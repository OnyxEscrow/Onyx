{#
  NEXUS SHIELD SCORE COMPONENT (MACRO)
  Dynamic trust badge showing vendor reputation as a visual shield

  Usage:
    {% import "partials/nexus/atoms/shield-score.html" as shield %}
    {{ shield::badge(score=87, reviews=42, rating=4.8) }}
    {{ shield::badge(score=45, reviews=10, rating=3.5, size="sm") }}
    {{ shield::badge(score=95, reviews=150, rating=4.9, size="lg", verified=true) }}

  Parameters:
    - score (required): 0-100 trust score
    - reviews (optional): Total number of reviews (default: 0)
    - rating (optional): Average star rating 0.0-5.0 (default: 0)
    - size (optional): sm|md|lg (default: md)
    - verified (optional): Show verified checkmark (default: false)
    - class (optional): Additional CSS classes
    - animate (optional): Enable entry animation (default: true)

  Trust Levels (determined by score):
    - Bronze:   0-39
    - Silver:   40-69
    - Gold:     70-89
    - Platinum: 90-100
#}

{% macro badge(score, reviews=0, rating=0, size="md", verified=false, class="", animate=true) %}
  {# Determine trust level based on score #}
  {%- if score >= 90 -%}
    {%- set level = "platinum" -%}
    {%- set level_label = "PLATINUM" -%}
  {%- elif score >= 70 -%}
    {%- set level = "gold" -%}
    {%- set level_label = "GOLD" -%}
  {%- elif score >= 40 -%}
    {%- set level = "silver" -%}
    {%- set level_label = "SILVER" -%}
  {%- else -%}
    {%- set level = "bronze" -%}
    {%- set level_label = "BRONZE" -%}
  {%- endif -%}

  {# Build CSS classes #}
  {%- set css_classes = "shield-score shield-score--" ~ size ~ " shield-score--" ~ level -%}
  {%- if animate -%}
    {%- set css_classes = css_classes ~ " shield-score--animate" -%}
  {%- endif -%}
  {%- if class -%}
    {%- set css_classes = css_classes ~ " " ~ class -%}
  {%- endif -%}

  <div class="{{ css_classes }}"
       data-score="{{ score }}"
       data-level="{{ level }}"
       role="img"
       aria-label="Trust Score: {{ score }} out of 100, {{ level_label }} level">

    {# Shield SVG with dynamic progress ring #}
    <div class="shield-score__shield">
      <svg viewBox="0 0 100 120" class="shield-score__svg" aria-hidden="true">
        {# Shield background path #}
        <defs>
          <linearGradient id="shield-gradient-{{ level }}" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" class="shield-score__gradient-start"/>
            <stop offset="100%" class="shield-score__gradient-end"/>
          </linearGradient>
          <filter id="shield-glow-{{ level }}" x="-50%" y="-50%" width="200%" height="200%">
            <feGaussianBlur stdDeviation="3" result="blur"/>
            <feComposite in="SourceGraphic" in2="blur" operator="over"/>
          </filter>
        </defs>

        {# Shield shape #}
        <path class="shield-score__bg"
              d="M50 5 L90 20 L90 60 Q90 95 50 115 Q10 95 10 60 L10 20 Z"
              fill="url(#shield-gradient-{{ level }})"
              filter="url(#shield-glow-{{ level }})"/>

        {# Progress arc (shows score percentage) #}
        <circle class="shield-score__progress-bg"
                cx="50" cy="55" r="30"
                fill="none"
                stroke-width="4"/>
        <circle class="shield-score__progress"
                cx="50" cy="55" r="30"
                fill="none"
                stroke-width="4"
                stroke-dasharray="188.5"
                stroke-dashoffset="{{ 188.5 - (score / 100 * 188.5) }}"
                transform="rotate(-90 50 55)"/>

        {# Score text #}
        <text x="50" y="50" class="shield-score__number" text-anchor="middle">{{ score }}</text>
        <text x="50" y="65" class="shield-score__label" text-anchor="middle">/100</text>

        {# Verified checkmark (if applicable) #}
        {%- if verified -%}
        <circle cx="75" cy="25" r="10" class="shield-score__verified-bg"/>
        <path d="M70 25 L73 28 L80 21" class="shield-score__verified-check" fill="none" stroke-width="2"/>
        {%- endif -%}
      </svg>
    </div>

    {# Level label #}
    <div class="shield-score__level">{{ level_label }}</div>

    {# Stats row #}
    {%- if reviews > 0 or rating > 0 -%}
    <div class="shield-score__stats">
      {%- if rating > 0 -%}
      <span class="shield-score__rating" aria-label="Average rating: {{ rating }} stars">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
        </svg>
        {{ rating | round(precision=1) }}
      </span>
      {%- endif -%}
      {%- if reviews > 0 -%}
      <span class="shield-score__reviews" aria-label="{{ reviews }} reviews">
        {{ reviews }} reviews
      </span>
      {%- endif -%}
    </div>
    {%- endif -%}
  </div>
{%- endmacro badge %}

{% macro mini(score, size="sm") %}
  {# Mini version for listings/cards - just the shield icon with score #}
  {%- if score >= 90 -%}
    {%- set level = "platinum" -%}
  {%- elif score >= 70 -%}
    {%- set level = "gold" -%}
  {%- elif score >= 40 -%}
    {%- set level = "silver" -%}
  {%- else -%}
    {%- set level = "bronze" -%}
  {%- endif -%}

  <span class="shield-score-mini shield-score-mini--{{ level }}"
        title="Trust Score: {{ score }}/100"
        aria-label="Trust Score: {{ score }} out of 100">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
    </svg>
    <span>{{ score }}</span>
  </span>
{%- endmacro mini %}

{# CSS styles embedded for component isolation #}
<style>
/* Shield Score Component */
.shield-score {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: var(--nx-space-2);
}

.shield-score__shield {
  position: relative;
}

.shield-score__svg {
  width: var(--nx-shield-size);
  height: calc(var(--nx-shield-size) * 1.2);
  filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
}

/* Size variants */
.shield-score--sm .shield-score__svg {
  width: var(--nx-shield-size-sm);
  height: calc(var(--nx-shield-size-sm) * 1.2);
}

.shield-score--lg .shield-score__svg {
  width: var(--nx-shield-size-lg);
  height: calc(var(--nx-shield-size-lg) * 1.2);
}

/* Level colors */
.shield-score--bronze .shield-score__gradient-start { stop-color: var(--nx-trust-bronze); }
.shield-score--bronze .shield-score__gradient-end { stop-color: #8B5A2B; }
.shield-score--bronze .shield-score__progress { stroke: var(--nx-trust-bronze); }
.shield-score--bronze .shield-score__level { color: var(--nx-trust-bronze); }

.shield-score--silver .shield-score__gradient-start { stop-color: var(--nx-trust-silver); }
.shield-score--silver .shield-score__gradient-end { stop-color: #808080; }
.shield-score--silver .shield-score__progress { stroke: var(--nx-trust-silver); }
.shield-score--silver .shield-score__level { color: var(--nx-trust-silver); }

.shield-score--gold .shield-score__gradient-start { stop-color: var(--nx-trust-gold); }
.shield-score--gold .shield-score__gradient-end { stop-color: #A68929; }
.shield-score--gold .shield-score__progress { stroke: var(--nx-trust-gold); }
.shield-score--gold .shield-score__level { color: var(--nx-trust-gold); }

.shield-score--platinum .shield-score__gradient-start { stop-color: var(--nx-trust-platinum); }
.shield-score--platinum .shield-score__gradient-end { stop-color: #B8B8B8; }
.shield-score--platinum .shield-score__progress { stroke: var(--nx-trust-platinum); }
.shield-score--platinum .shield-score__level { color: var(--nx-trust-platinum); }

/* Progress ring */
.shield-score__progress-bg {
  stroke: var(--nx-ring-bg);
}

.shield-score__progress {
  stroke-linecap: round;
  transition: stroke-dashoffset var(--nx-shield-animation);
}

/* Text styles */
.shield-score__number {
  font-family: var(--nx-font-display);
  font-size: 24px;
  font-weight: 700;
  fill: var(--nx-text-primary);
}

.shield-score__label {
  font-family: var(--nx-font-mono);
  font-size: 10px;
  fill: var(--nx-text-muted);
}

.shield-score__level {
  font-family: var(--nx-font-display);
  font-size: var(--nx-text-sm);
  font-weight: 700;
  letter-spacing: 0.1em;
  text-transform: uppercase;
}

/* Verified badge */
.shield-score__verified-bg {
  fill: var(--nx-success);
}

.shield-score__verified-check {
  stroke: white;
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* Stats row */
.shield-score__stats {
  display: flex;
  align-items: center;
  gap: var(--nx-space-4);
  font-family: var(--nx-font-body);
  font-size: var(--nx-text-sm);
  color: var(--nx-text-secondary);
}

.shield-score__rating {
  display: flex;
  align-items: center;
  gap: var(--nx-space-1);
}

.shield-score__rating svg {
  color: var(--nx-gold);
}

/* Animation on entry */
.shield-score--animate .shield-score__svg {
  animation: shield-appear 0.6s ease-out;
}

.shield-score--animate .shield-score__progress {
  animation: ring-fill var(--nx-shield-animation) ease-out;
}

@keyframes shield-appear {
  from {
    opacity: 0;
    transform: scale(0.8) translateY(10px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

@keyframes ring-fill {
  from {
    stroke-dashoffset: 188.5;
  }
}

/* Mini version for cards */
.shield-score-mini {
  display: inline-flex;
  align-items: center;
  gap: var(--nx-space-1);
  padding: var(--nx-space-1) var(--nx-space-2);
  border-radius: var(--nx-radius-full);
  font-family: var(--nx-font-mono);
  font-size: var(--nx-text-xs);
  font-weight: 600;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.shield-score-mini--bronze { color: var(--nx-trust-bronze); }
.shield-score-mini--silver { color: var(--nx-trust-silver); }
.shield-score-mini--gold { color: var(--nx-trust-gold); }
.shield-score-mini--platinum { color: var(--nx-trust-platinum); }

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  .shield-score--animate .shield-score__svg,
  .shield-score--animate .shield-score__progress {
    animation: none;
  }

  .shield-score__progress {
    transition: none;
  }
}
</style>
