{#
  NEXUS TRUST PASSPORT COMPONENT
  Vendor reputation dashboard with Shield Badge, metrics consolidation, and certificate export

  Usage:
    {% import "partials/nexus/molecules/trust-passport.html" as passport %}
    {{ passport::dashboard(
        score=87,
        internal_rating=4.8,
        internal_reviews=42,
        external_rating=4.5,
        external_reviews=15,
        completed_transactions=87,
        verified=true
    ) }}

  Parameters:
    - score (required): 0-100 consolidated trust score (Shield Score V2)
    - internal_rating (optional): Average rating from this marketplace (0.0-5.0)
    - internal_reviews (optional): Number of reviews on this marketplace
    - external_rating (optional): Imported rating from external sources
    - external_reviews (optional): Number of imported reviews
    - completed_transactions (optional): Number of completed escrow transactions
    - verified (optional): Account verification status
    - ipfs_hash (optional): Last exported IPFS hash
    - class (optional): Additional CSS classes

  Shield Score V2 Formula:
    40% × transaction_volume + 30% × review_quality + 30% × review_volume

  Export Flow:
    1. Click "Export Certificate"
    2. Animation shows "forging" process
    3. Result: QR Code + Short link + Copy button
#}

{% import "partials/nexus/atoms/shield-score.html" as shield %}

{% macro dashboard(score, internal_rating=0, internal_reviews=0, external_rating=0, external_reviews=0, completed_transactions=0, verified=false, ipfs_hash="", class="") %}

{# Calculate combined metrics #}
{%- set total_reviews = internal_reviews + external_reviews -%}
{%- if total_reviews > 0 -%}
  {%- set combined_rating = ((internal_rating * internal_reviews) + (external_rating * external_reviews)) / total_reviews -%}
{%- else -%}
  {%- set combined_rating = 0 -%}
{%- endif -%}

{# Build CSS classes #}
{%- set css_classes = "trust-passport" -%}
{%- if class -%}
  {%- set css_classes = css_classes ~ " " ~ class -%}
{%- endif -%}

<div class="{{ css_classes }}" data-trust-passport>
  {# Zone 1: Shield Badge #}
  <div class="trust-passport__shield-zone">
    {{ shield::badge(score=score, reviews=total_reviews, rating=combined_rating, verified=verified, size="lg") }}
  </div>

  {# Zone 2: Metrics Consolidation #}
  <div class="trust-passport__metrics-zone">
    {# Transactions Card (NEW - Most Important) #}
    <div class="trust-passport__metric-card trust-passport__metric-card--transactions" data-metric="transactions">
      <div class="trust-passport__metric-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
          <polyline points="17 6 23 6 23 12"></polyline>
        </svg>
        <span>TX</span>
      </div>
      <div class="trust-passport__metric-value">
        <span class="trust-passport__metric-number trust-passport__metric-number--transactions">
          {{ completed_transactions }}
        </span>
      </div>
      <div class="trust-passport__metric-count">
        completed
      </div>
    </div>

    {# Internal Score Card #}
    <div class="trust-passport__metric-card" data-metric="internal">
      <div class="trust-passport__metric-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
          <polyline points="9 22 9 12 15 12 15 22"></polyline>
        </svg>
        <span>INTERNAL</span>
      </div>
      <div class="trust-passport__metric-value">
        {%- if internal_rating > 0 -%}
          <span class="trust-passport__metric-rating">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="trust-passport__star" aria-hidden="true">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
            {{ internal_rating | round(precision=1) }}
          </span>
        {%- else -%}
          <span class="trust-passport__metric-empty">--</span>
        {%- endif -%}
      </div>
      <div class="trust-passport__metric-count">
        {{ internal_reviews }} reviews
      </div>
    </div>

    {# External Score Card #}
    <div class="trust-passport__metric-card" data-metric="external">
      <div class="trust-passport__metric-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="2" y1="12" x2="22" y2="12"></line>
          <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
        </svg>
        <span>EXTERNAL</span>
      </div>
      <div class="trust-passport__metric-value">
        {%- if external_rating > 0 -%}
          <span class="trust-passport__metric-rating">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="trust-passport__star" aria-hidden="true">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
            {{ external_rating | round(precision=1) }}
          </span>
        {%- else -%}
          <span class="trust-passport__metric-empty">--</span>
        {%- endif -%}
      </div>
      <div class="trust-passport__metric-count">
        {%- if external_reviews > 0 -%}
          {{ external_reviews }} imported
        {%- else -%}
          <a href="#" class="trust-passport__import-link" data-action="import">Import</a>
        {%- endif -%}
      </div>
    </div>

    {# Combined Score Card #}
    <div class="trust-passport__metric-card trust-passport__metric-card--combined" data-metric="combined">
      <div class="trust-passport__metric-header">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
        </svg>
        <span>COMBINED</span>
      </div>
      <div class="trust-passport__metric-value">
        {%- if combined_rating > 0 -%}
          <span class="trust-passport__metric-rating trust-passport__metric-rating--highlight">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" class="trust-passport__star" aria-hidden="true">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
            {{ combined_rating | round(precision=1) }}
          </span>
        {%- else -%}
          <span class="trust-passport__metric-empty">--</span>
        {%- endif -%}
      </div>
      <div class="trust-passport__metric-count">
        {{ total_reviews }} total
      </div>
    </div>
  </div>

  {# Zone 3: Actions #}
  <div class="trust-passport__actions-zone">
    <button type="button" class="trust-passport__btn trust-passport__btn--primary" data-action="export">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
      </svg>
      <span>Export Certificate</span>
    </button>

    <button type="button" class="trust-passport__btn trust-passport__btn--secondary" data-action="import">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="7 10 12 15 17 10"></polyline>
        <line x1="12" y1="15" x2="12" y2="3"></line>
      </svg>
      <span>Import Reputation</span>
    </button>
  </div>

  {# Export Result Panel (hidden by default) #}
  <div class="trust-passport__export-result" data-export-result hidden>
    <div class="trust-passport__export-header">
      <h4>Certificate Generated</h4>
      <button type="button" class="trust-passport__export-close" aria-label="Close">&times;</button>
    </div>

    <div class="trust-passport__export-qr" data-qr-container>
      {# QR code will be inserted here by JS #}
    </div>

    <div class="trust-passport__export-link">
      <input type="text" readonly class="trust-passport__export-input" data-export-link value="">
      <button type="button" class="trust-passport__copy-btn" data-action="copy" aria-label="Copy link">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
        </svg>
      </button>
    </div>

    <p class="trust-passport__export-hint">
      Share this link to prove your reputation
    </p>

    <a href="#" class="trust-passport__export-download" data-action="download" download="reputation-certificate.json">
      Download file
    </a>
  </div>

  {# Export Loading State #}
  <div class="trust-passport__export-loading" data-export-loading hidden>
    <div class="trust-passport__forge-animation">
      <svg viewBox="0 0 100 120" class="trust-passport__forge-shield">
        <defs>
          <linearGradient id="forge-gradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="var(--nx-trust-gold)"/>
            <stop offset="100%" stop-color="#A68929"/>
          </linearGradient>
        </defs>
        <path class="trust-passport__forge-path"
              d="M50 5 L90 20 L90 60 Q90 95 50 115 Q10 95 10 60 L10 20 Z"
              fill="url(#forge-gradient)"/>
      </svg>
    </div>
    <p class="trust-passport__forge-text">Forging Certificate...</p>
  </div>
</div>

<style>
/* Trust Passport Container */
.trust-passport {
  display: flex;
  flex-direction: column;
  gap: var(--nx-space-6);
  padding: var(--nx-space-6);
  background: linear-gradient(180deg, var(--nx-bg-elevated) 0%, var(--nx-bg-surface) 100%);
  border: 1px solid var(--nx-border);
  border-radius: var(--nx-radius-xl);
}

/* Zone 1: Shield */
.trust-passport__shield-zone {
  display: flex;
  justify-content: center;
  padding: var(--nx-space-4) 0;
}

/* Zone 2: Metrics */
.trust-passport__metrics-zone {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: var(--nx-space-4);
}

.trust-passport__metric-card {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: var(--nx-space-4);
  background: var(--nx-bg-deep);
  border: 1px solid var(--nx-border);
  border-radius: var(--nx-radius-lg);
  transition: all var(--nx-transition-fast);
}

.trust-passport__metric-card:hover {
  border-color: var(--nx-border-hover);
  background: var(--nx-bg-hover);
}

.trust-passport__metric-card--combined {
  border-color: var(--nx-gold-dim);
  background: rgba(212, 175, 55, 0.05);
}

.trust-passport__metric-card--transactions {
  border-color: var(--nx-success-dim);
  background: rgba(34, 197, 94, 0.05);
}

.trust-passport__metric-card--transactions .trust-passport__metric-header {
  color: var(--nx-success);
}

.trust-passport__metric-number--transactions {
  color: var(--nx-success);
  font-family: var(--nx-font-mono);
}

.trust-passport__metric-header {
  display: flex;
  align-items: center;
  gap: var(--nx-space-2);
  font-family: var(--nx-font-display);
  font-size: var(--nx-text-xs);
  font-weight: 700;
  color: var(--nx-text-muted);
  letter-spacing: 0.1em;
  text-transform: uppercase;
  margin-bottom: var(--nx-space-2);
}

.trust-passport__metric-value {
  font-family: var(--nx-font-display);
  font-size: var(--nx-text-2xl);
  font-weight: 700;
  color: var(--nx-text-primary);
  margin-bottom: var(--nx-space-1);
}

.trust-passport__metric-rating {
  display: flex;
  align-items: center;
  gap: var(--nx-space-1);
}

.trust-passport__metric-rating--highlight {
  color: var(--nx-gold);
}

.trust-passport__star {
  color: var(--nx-gold);
}

.trust-passport__metric-empty {
  color: var(--nx-text-muted);
}

.trust-passport__metric-count {
  font-family: var(--nx-font-body);
  font-size: var(--nx-text-sm);
  color: var(--nx-text-muted);
}

.trust-passport__import-link {
  color: var(--nx-gold);
  text-decoration: none;
  font-size: var(--nx-text-sm);
}

.trust-passport__import-link:hover {
  text-decoration: underline;
}

/* Zone 3: Actions */
.trust-passport__actions-zone {
  display: flex;
  gap: var(--nx-space-3);
  justify-content: center;
  flex-wrap: wrap;
}

.trust-passport__btn {
  display: inline-flex;
  align-items: center;
  gap: var(--nx-space-2);
  padding: var(--nx-space-3) var(--nx-space-5);
  border-radius: var(--nx-radius-md);
  font-family: var(--nx-font-display);
  font-size: var(--nx-text-sm);
  font-weight: 700;
  cursor: pointer;
  transition: all var(--nx-transition-fast);
  min-height: 48px;
}

.trust-passport__btn--primary {
  background: var(--nx-gold);
  border: none;
  color: var(--nx-bg-deep);
}

.trust-passport__btn--primary:hover {
  background: var(--nx-gold-hover);
  transform: translateY(-1px);
}

.trust-passport__btn--secondary {
  background: transparent;
  border: 1px solid var(--nx-border);
  color: var(--nx-text-secondary);
}

.trust-passport__btn--secondary:hover {
  background: rgba(255, 255, 255, 0.05);
  border-color: var(--nx-border-hover);
  color: var(--nx-text-primary);
}

/* Export Result Panel */
.trust-passport__export-result {
  padding: var(--nx-space-4);
  background: var(--nx-bg-deep);
  border: 1px solid var(--nx-success);
  border-radius: var(--nx-radius-lg);
  animation: result-in 0.3s ease-out;
}

@keyframes result-in {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.trust-passport__export-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--nx-space-4);
}

.trust-passport__export-header h4 {
  font-family: var(--nx-font-display);
  font-size: var(--nx-text-lg);
  font-weight: 700;
  color: var(--nx-success);
  margin: 0;
}

.trust-passport__export-close {
  background: transparent;
  border: none;
  color: var(--nx-text-muted);
  font-size: var(--nx-text-xl);
  cursor: pointer;
  padding: var(--nx-space-1);
  line-height: 1;
}

.trust-passport__export-close:hover {
  color: var(--nx-text-primary);
}

.trust-passport__export-qr {
  display: flex;
  justify-content: center;
  padding: var(--nx-space-4);
  background: white;
  border-radius: var(--nx-radius-md);
  margin-bottom: var(--nx-space-4);
}

.trust-passport__export-qr canvas,
.trust-passport__export-qr img {
  max-width: 150px;
  max-height: 150px;
}

.trust-passport__export-link {
  display: flex;
  gap: var(--nx-space-2);
  margin-bottom: var(--nx-space-3);
}

.trust-passport__export-input {
  flex: 1;
  background: var(--nx-bg-surface);
  border: 1px solid var(--nx-border);
  border-radius: var(--nx-radius-md);
  color: var(--nx-text-primary);
  font-family: var(--nx-font-mono);
  font-size: var(--nx-text-sm);
  padding: var(--nx-space-2) var(--nx-space-3);
}

.trust-passport__copy-btn {
  background: var(--nx-bg-surface);
  border: 1px solid var(--nx-border);
  border-radius: var(--nx-radius-md);
  color: var(--nx-text-secondary);
  padding: var(--nx-space-2);
  cursor: pointer;
  transition: all var(--nx-transition-fast);
}

.trust-passport__copy-btn:hover {
  background: var(--nx-bg-hover);
  color: var(--nx-text-primary);
}

.trust-passport__copy-btn--copied {
  background: var(--nx-success-dim);
  border-color: var(--nx-success);
  color: var(--nx-success);
}

.trust-passport__export-hint {
  font-family: var(--nx-font-body);
  font-size: var(--nx-text-sm);
  color: var(--nx-text-muted);
  text-align: center;
  margin: 0 0 var(--nx-space-3);
}

.trust-passport__export-download {
  display: block;
  text-align: center;
  font-family: var(--nx-font-body);
  font-size: var(--nx-text-xs);
  color: var(--nx-text-muted);
  text-decoration: none;
}

.trust-passport__export-download:hover {
  color: var(--nx-text-secondary);
  text-decoration: underline;
}

/* Export Loading State */
.trust-passport__export-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: var(--nx-space-8);
}

.trust-passport__forge-animation {
  width: 100px;
  height: 120px;
  margin-bottom: var(--nx-space-4);
}

.trust-passport__forge-shield {
  width: 100%;
  height: 100%;
}

.trust-passport__forge-path {
  animation: forge-glow 1.5s ease-in-out infinite;
}

@keyframes forge-glow {
  0%, 100% {
    filter: drop-shadow(0 0 5px var(--nx-trust-gold-glow));
    opacity: 0.7;
  }
  50% {
    filter: drop-shadow(0 0 20px var(--nx-trust-gold)) drop-shadow(0 0 40px var(--nx-trust-gold-glow));
    opacity: 1;
  }
}

.trust-passport__forge-text {
  font-family: var(--nx-font-display);
  font-size: var(--nx-text-base);
  color: var(--nx-gold);
  margin: 0;
  animation: forge-pulse 1s ease-in-out infinite;
}

@keyframes forge-pulse {
  0%, 100% { opacity: 0.7; }
  50% { opacity: 1; }
}

/* Responsive */
@media (max-width: 900px) {
  .trust-passport__metrics-zone {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 640px) {
  .trust-passport__metrics-zone {
    grid-template-columns: 1fr;
  }

  .trust-passport__actions-zone {
    flex-direction: column;
  }

  .trust-passport__btn {
    width: 100%;
    justify-content: center;
  }
}

/* Reduced Motion */
@media (prefers-reduced-motion: reduce) {
  .trust-passport__forge-path,
  .trust-passport__forge-text,
  .trust-passport__export-result {
    animation: none;
  }
}
</style>
{%- endmacro dashboard %}

{% macro compact(score, rating, reviews, completed_transactions=0, size="sm") %}
{# Compact version for headers/sidebars #}
<div class="trust-passport-compact">
  {{ shield::mini(score=score, size=size) }}
  {%- if rating > 0 -%}
  <span class="trust-passport-compact__rating">
    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="var(--nx-gold)" aria-hidden="true">
      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
    </svg>
    {{ rating | round(precision=1) }}
  </span>
  {%- endif -%}
  {%- if reviews > 0 -%}
  <span class="trust-passport-compact__reviews">({{ reviews }})</span>
  {%- endif -%}
  {%- if completed_transactions > 0 -%}
  <span class="trust-passport-compact__tx" title="{{ completed_transactions }} completed transactions">
    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="var(--nx-success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
      <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
      <polyline points="17 6 23 6 23 12"></polyline>
    </svg>
    {{ completed_transactions }}
  </span>
  {%- endif -%}
</div>

<style>
.trust-passport-compact {
  display: inline-flex;
  align-items: center;
  gap: var(--nx-space-2);
}

.trust-passport-compact__rating {
  display: inline-flex;
  align-items: center;
  gap: var(--nx-space-1);
  font-family: var(--nx-font-mono);
  font-size: var(--nx-text-sm);
  color: var(--nx-text-primary);
}

.trust-passport-compact__reviews {
  font-family: var(--nx-font-body);
  font-size: var(--nx-text-xs);
  color: var(--nx-text-muted);
}

.trust-passport-compact__tx {
  display: inline-flex;
  align-items: center;
  gap: var(--nx-space-1);
  font-family: var(--nx-font-mono);
  font-size: var(--nx-text-xs);
  color: var(--nx-success);
}
</style>
{%- endmacro compact %}
