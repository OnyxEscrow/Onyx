{#
  Onyx REVIEW PROMPT MODAL
  Post-order completion modal for zero-friction review collection

  Usage:
    {% import "partials/onyx/molecules/review-prompt-modal.html" as review %}
    {{ review::modal(order_id=order.id, vendor_id=order.vendor_id, vendor_name=vendor.username, txid=escrow.broadcast_tx_hash) }}

  Parameters:
    - order_id (required): Order UUID
    - vendor_id (required): Vendor UUID
    - vendor_name (required): Vendor display name
    - txid (required): Monero transaction hash for cryptographic binding
    - escrow_id (optional): Escrow UUID

  Behavior:
    1. Shows celebration message on order completion
    2. Presents 5-emoji rating selector
    3. On selection: expands to optional comment field
    4. On submit: signs review cryptographically and submits
    5. Auto-closes with "Thank you" animation

  JavaScript API:
    - window.ReviewPrompt.show(orderId) - Programmatically show modal
    - window.ReviewPrompt.hide() - Programmatically hide modal
#}

{% import "partials/onyx/atoms/emoji-rating.html" as emoji %}

{% macro modal(order_id, vendor_id, vendor_name, txid, escrow_id="") %}
<dialog id="review-prompt-modal" class="review-prompt" data-order-id="{{ order_id }}" data-vendor-id="{{ vendor_id }}" data-txid="{{ txid }}" data-escrow-id="{{ escrow_id }}">
  <div class="review-prompt__backdrop" onclick="window.ReviewPrompt && window.ReviewPrompt.hide()"></div>

  <div class="review-prompt__container">
    {# Phase 1: Celebration + Rating Selection #}
    <div class="review-prompt__phase review-prompt__phase--active" data-phase="rating">
      {# Success Icon #}
      <div class="review-prompt__success-icon" aria-hidden="true">
        <svg viewBox="0 0 52 52" class="review-prompt__checkmark">
          <circle class="review-prompt__checkmark-circle" cx="26" cy="26" r="25" fill="none"/>
          <path class="review-prompt__checkmark-check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
        </svg>
      </div>

      {# Celebration Text #}
      <h2 class="review-prompt__title">Order Complete</h2>
      <p class="review-prompt__subtitle">Funds released to <strong>{{ vendor_name }}</strong></p>

      <div class="review-prompt__divider"></div>

      {# Rating Question #}
      <p class="review-prompt__question">How was your experience?</p>

      {# Emoji Rating #}
      {{ emoji::rating(name="rating", size="lg") }}

      {# Social Nudge (appears after selection) #}
      <p class="review-prompt__nudge" aria-hidden="true">
        87% of buyers leave a review after a good experience
      </p>

      {# Skip Button #}
      <button type="button" class="review-prompt__skip" onclick="window.ReviewPrompt && window.ReviewPrompt.hide()">
        Skip
      </button>
    </div>

    {# Phase 2: Comment (Optional) #}
    <div class="review-prompt__phase" data-phase="comment">
      <button type="button" class="review-prompt__back" aria-label="Back">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="15 18 9 12 15 6"></polyline>
        </svg>
      </button>

      <div class="review-prompt__selected-emoji" aria-live="polite"></div>

      <p class="review-prompt__comment-prompt">A word for other buyers?</p>
      <p class="review-prompt__comment-hint">(optional)</p>

      <div class="review-prompt__comment-wrapper">
        <textarea
          class="review-prompt__textarea"
          name="comment"
          placeholder="Fast delivery, quality product..."
          maxlength="200"
          rows="3"
          aria-label="Optional comment"
        ></textarea>
        <span class="review-prompt__char-count">0/200</span>
      </div>

      <button type="button" class="review-prompt__submit">
        <span class="review-prompt__submit-text">Submit Review</span>
        <span class="review-prompt__submit-loading" aria-hidden="true">
          <svg class="review-prompt__spinner" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="31.4" stroke-dashoffset="10"/>
          </svg>
        </span>
      </button>
    </div>

    {# Phase 3: Thank You #}
    <div class="review-prompt__phase" data-phase="thankyou">
      <div class="review-prompt__thankyou-icon" aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="var(--nx-success)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
        </svg>
      </div>
      <h2 class="review-prompt__thankyou-title">Thanks!</h2>
      <p class="review-prompt__thankyou-text">Your review helps the community</p>
    </div>

    {# Phase 4: Error #}
    <div class="review-prompt__phase" data-phase="error">
      <div class="review-prompt__error-icon" aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--nx-danger)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="10"></circle>
          <line x1="12" y1="8" x2="12" y2="12"></line>
          <line x1="12" y1="16" x2="12.01" y2="16"></line>
        </svg>
      </div>
      <h2 class="review-prompt__error-title">Error</h2>
      <p class="review-prompt__error-text"></p>
      <button type="button" class="review-prompt__retry">Retry</button>
      <button type="button" class="review-prompt__close-error" onclick="window.ReviewPrompt && window.ReviewPrompt.hide()">Close</button>
    </div>
  </div>
</dialog>

<style>
/* Review Prompt Modal */
.review-prompt {
  border: none;
  padding: 0;
  background: transparent;
  max-width: 90vw;
  overflow: visible;
}

.review-prompt::backdrop {
  background-color: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  animation: review-backdrop-in 0.3s ease-out;
}

@keyframes review-backdrop-in {
  from { opacity: 0; }
  to { opacity: 1; }
}

.review-prompt[open] {
  animation: review-modal-in 0.4s ease-out;
}

@keyframes review-modal-in {
  from {
    opacity: 0;
    transform: scale(0.9) translateY(20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.review-prompt__backdrop {
  position: fixed;
  inset: 0;
  z-index: -1;
}

.review-prompt__container {
  background: linear-gradient(180deg, var(--nx-bg-elevated) 0%, var(--nx-bg-surface) 100%);
  border: 1px solid var(--nx-border);
  border-radius: var(--nx-radius-xl);
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
  width: 420px;
  max-width: 95vw;
  overflow: hidden;
  position: relative;
}

/* Phases */
.review-prompt__phase {
  display: none;
  flex-direction: column;
  align-items: center;
  padding: var(--nx-space-8);
  text-align: center;
}

.review-prompt__phase--active {
  display: flex;
  animation: phase-in 0.3s ease-out;
}

@keyframes phase-in {
  from {
    opacity: 0;
    transform: translateX(20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* Success Checkmark Animation */
.review-prompt__success-icon {
  width: 80px;
  height: 80px;
  margin-bottom: var(--nx-space-4);
}

.review-prompt__checkmark {
  width: 100%;
  height: 100%;
}

.review-prompt__checkmark-circle {
  stroke: var(--nx-success);
  stroke-width: 2;
  stroke-dasharray: 157;
  stroke-dashoffset: 157;
  animation: checkmark-circle 0.6s ease-out forwards;
}

.review-prompt__checkmark-check {
  stroke: var(--nx-success);
  stroke-width: 3;
  stroke-linecap: round;
  stroke-linejoin: round;
  stroke-dasharray: 48;
  stroke-dashoffset: 48;
  animation: checkmark-check 0.3s ease-out 0.4s forwards;
}

@keyframes checkmark-circle {
  to { stroke-dashoffset: 0; }
}

@keyframes checkmark-check {
  to { stroke-dashoffset: 0; }
}

/* Typography */
.review-prompt__title {
  font-family: var(--nx-font-display);
  font-size: var(--nx-text-2xl);
  font-weight: 700;
  color: var(--nx-text-primary);
  margin: 0 0 var(--nx-space-2);
}

.review-prompt__subtitle {
  font-family: var(--nx-font-body);
  font-size: var(--nx-text-base);
  color: var(--nx-text-secondary);
  margin: 0;
}

.review-prompt__subtitle strong {
  color: var(--nx-gold);
}

.review-prompt__divider {
  width: 60%;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--nx-border), transparent);
  margin: var(--nx-space-6) 0;
}

.review-prompt__question {
  font-family: var(--nx-font-body);
  font-size: var(--nx-text-lg);
  color: var(--nx-text-primary);
  margin: 0 0 var(--nx-space-4);
}

/* Social Nudge */
.review-prompt__nudge {
  font-family: var(--nx-font-body);
  font-size: var(--nx-text-sm);
  color: var(--nx-text-muted);
  margin-top: var(--nx-space-4);
  opacity: 0;
  transition: opacity 0.3s ease-out;
}

.review-prompt--rating-selected .review-prompt__nudge {
  opacity: 1;
}

/* Skip Button */
.review-prompt__skip {
  background: transparent;
  border: none;
  color: var(--nx-text-muted);
  font-family: var(--nx-font-body);
  font-size: var(--nx-text-sm);
  cursor: pointer;
  padding: var(--nx-space-2) var(--nx-space-4);
  margin-top: var(--nx-space-4);
  transition: color var(--nx-transition-fast);
}

.review-prompt__skip:hover {
  color: var(--nx-text-secondary);
}

/* Back Button */
.review-prompt__back {
  position: absolute;
  top: var(--nx-space-4);
  left: var(--nx-space-4);
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid var(--nx-border);
  border-radius: var(--nx-radius-full);
  color: var(--nx-text-secondary);
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all var(--nx-transition-fast);
}

.review-prompt__back:hover {
  background: rgba(255, 255, 255, 0.1);
  color: var(--nx-text-primary);
}

/* Selected Emoji Display */
.review-prompt__selected-emoji {
  font-size: 4rem;
  margin-bottom: var(--nx-space-4);
  animation: emoji-pop 0.3s ease-out;
}

@keyframes emoji-pop {
  0% { transform: scale(0); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}

/* Comment Section */
.review-prompt__comment-prompt {
  font-family: var(--nx-font-body);
  font-size: var(--nx-text-lg);
  color: var(--nx-text-primary);
  margin: 0;
}

.review-prompt__comment-hint {
  font-family: var(--nx-font-body);
  font-size: var(--nx-text-sm);
  color: var(--nx-text-muted);
  margin: var(--nx-space-1) 0 var(--nx-space-4);
}

.review-prompt__comment-wrapper {
  width: 100%;
  position: relative;
}

.review-prompt__textarea {
  width: 100%;
  background: var(--nx-bg-deep);
  border: 1px solid var(--nx-border);
  border-radius: var(--nx-radius-md);
  color: var(--nx-text-primary);
  font-family: var(--nx-font-body);
  font-size: var(--nx-text-base);
  padding: var(--nx-space-3);
  resize: none;
  transition: border-color var(--nx-transition-fast);
}

.review-prompt__textarea:focus {
  outline: none;
  border-color: var(--nx-gold);
}

.review-prompt__textarea::placeholder {
  color: var(--nx-text-muted);
}

.review-prompt__char-count {
  position: absolute;
  bottom: var(--nx-space-2);
  right: var(--nx-space-3);
  font-family: var(--nx-font-mono);
  font-size: var(--nx-text-xs);
  color: var(--nx-text-muted);
}

/* Submit Button */
.review-prompt__submit {
  width: 100%;
  background: var(--nx-gold);
  border: none;
  border-radius: var(--nx-radius-md);
  color: var(--nx-bg-deep);
  font-family: var(--nx-font-display);
  font-size: var(--nx-text-base);
  font-weight: 700;
  padding: var(--nx-space-4);
  margin-top: var(--nx-space-4);
  cursor: pointer;
  transition: all var(--nx-transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 52px;
}

.review-prompt__submit:hover:not(:disabled) {
  background: var(--nx-gold-hover);
  transform: translateY(-1px);
}

.review-prompt__submit:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}

.review-prompt__submit-loading {
  display: none;
}

.review-prompt__submit--loading .review-prompt__submit-text {
  display: none;
}

.review-prompt__submit--loading .review-prompt__submit-loading {
  display: block;
}

.review-prompt__spinner {
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Thank You Phase */
.review-prompt__thankyou-icon {
  margin-bottom: var(--nx-space-4);
  animation: heart-beat 0.6s ease-out;
}

@keyframes heart-beat {
  0% { transform: scale(0); }
  50% { transform: scale(1.2); }
  100% { transform: scale(1); }
}

.review-prompt__thankyou-title {
  font-family: var(--nx-font-display);
  font-size: var(--nx-text-3xl);
  font-weight: 700;
  color: var(--nx-success);
  margin: 0 0 var(--nx-space-2);
}

.review-prompt__thankyou-text {
  font-family: var(--nx-font-body);
  font-size: var(--nx-text-base);
  color: var(--nx-text-secondary);
  margin: 0;
}

/* Error Phase */
.review-prompt__error-icon {
  margin-bottom: var(--nx-space-4);
}

.review-prompt__error-title {
  font-family: var(--nx-font-display);
  font-size: var(--nx-text-2xl);
  font-weight: 700;
  color: var(--nx-danger);
  margin: 0 0 var(--nx-space-2);
}

.review-prompt__error-text {
  font-family: var(--nx-font-body);
  font-size: var(--nx-text-base);
  color: var(--nx-text-secondary);
  margin: 0 0 var(--nx-space-4);
}

.review-prompt__retry,
.review-prompt__close-error {
  background: transparent;
  border: 1px solid var(--nx-border);
  border-radius: var(--nx-radius-md);
  color: var(--nx-text-secondary);
  font-family: var(--nx-font-body);
  font-size: var(--nx-text-sm);
  padding: var(--nx-space-2) var(--nx-space-4);
  margin: var(--nx-space-1);
  cursor: pointer;
  transition: all var(--nx-transition-fast);
}

.review-prompt__retry:hover,
.review-prompt__close-error:hover {
  background: rgba(255, 255, 255, 0.05);
  color: var(--nx-text-primary);
}

/* Responsive */
@media (max-width: 480px) {
  .review-prompt__container {
    width: 100vw;
    max-width: 100vw;
    border-radius: var(--nx-radius-xl) var(--nx-radius-xl) 0 0;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
  }

  .review-prompt__phase {
    padding: var(--nx-space-6);
  }
}

/* Reduced Motion */
@media (prefers-reduced-motion: reduce) {
  .review-prompt[open],
  .review-prompt::backdrop,
  .review-prompt__checkmark-circle,
  .review-prompt__checkmark-check,
  .review-prompt__phase--active,
  .review-prompt__selected-emoji,
  .review-prompt__thankyou-icon,
  .review-prompt__spinner {
    animation: none;
  }

  .review-prompt__checkmark-circle,
  .review-prompt__checkmark-check {
    stroke-dashoffset: 0;
  }
}
</style>
{%- endmacro modal %}
