{% extends "base-onyx.html" %}
{% import "components/trust-meter.html" as trust %}

{% block title %}Escrow #{{ escrow.id | truncate(length=8, end="") }} - FROST MARKET{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/onyx-true.css">
<style>
/* === ESCROW DETAIL - Onyx DESIGN === */

.onyx-escrow-container {
  max-width: 1400px;
  margin: 2rem auto;
  padding: 0 var(--onyx-space-4);
}

.onyx-escrow-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--onyx-space-6);
  padding: var(--onyx-space-6);
  background: rgba(13, 13, 13, 0.95);
  backdrop-filter: blur(20px);
  border: 1px solid hsl(0, 0%, 15%);
  border-radius: var(--onyx-radius-lg);
  box-shadow: var(--onyx-shadow-lg);
}

.onyx-escrow-title-group h1 {
  margin: 0 0 var(--onyx-space-2) 0;
  font-size: var(--onyx-text-3xl);
  font-weight: var(--onyx-weight-black);
  color: var(--onyx-primary);
  text-shadow: 0 0 20px rgba(255, 26, 92, 0.5);
  letter-spacing: var(--onyx-tracking-tight);
}

.onyx-escrow-subtitle {
  margin: 0;
  font-size: var(--onyx-text-base);
  color: var(--onyx-muted-fg);
  font-weight: var(--onyx-weight-medium);
}

.onyx-status-badge {
  padding: var(--onyx-space-2) var(--onyx-space-4);
  border-radius: var(--onyx-radius-full);
  font-size: var(--onyx-text-sm);
  font-weight: var(--onyx-weight-bold);
  text-transform: uppercase;
  letter-spacing: var(--onyx-tracking-wide);
  animation: pulse-glow 2s ease-in-out infinite;
}

.onyx-status-created {
  background: rgba(124, 58, 237, 0.2);
  color: hsl(270, 60%, 65%);
  border: 1px solid hsl(270, 60%, 50%);
  box-shadow: 0 0 15px rgba(124, 58, 237, 0.3);
}

.onyx-status-funded {
  background: rgba(0, 217, 255, 0.2);
  color: hsl(190, 100%, 55%);
  border: 1px solid hsl(190, 100%, 50%);
  box-shadow: 0 0 15px rgba(0, 217, 255, 0.3);
}

.onyx-status-releasing, .onyx-status-refunding {
  background: rgba(251, 191, 36, 0.2);
  color: hsl(45, 100%, 60%);
  border: 1px solid hsl(45, 100%, 50%);
  box-shadow: 0 0 15px rgba(251, 191, 36, 0.3);
}

.onyx-status-completed {
  background: rgba(34, 197, 94, 0.2);
  color: hsl(145, 65%, 55%);
  border: 1px solid hsl(145, 65%, 45%);
  box-shadow: 0 0 15px rgba(34, 197, 94, 0.3);
}

.onyx-status-disputed {
  background: rgba(239, 68, 68, 0.2);
  color: hsl(0, 85%, 60%);
  border: 1px solid hsl(0, 85%, 50%);
  box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
}

@keyframes pulse-glow {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.onyx-escrow-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: var(--onyx-space-6);
  margin-bottom: var(--onyx-space-6);
}

.onyx-glass-card {
  background: rgba(13, 13, 13, 0.95);
  backdrop-filter: blur(20px);
  border: 1px solid hsl(0, 0%, 15%);
  border-radius: var(--onyx-radius-lg);
  padding: var(--onyx-space-6);
  box-shadow: var(--onyx-shadow-lg);
  transition: all var(--onyx-transition-base);
}

.onyx-glass-card:hover {
  border-color: hsl(0, 0%, 20%);
  box-shadow: var(--onyx-shadow-2xl);
}

.onyx-amount-display {
  text-align: center;
  padding: var(--onyx-space-8);
  background: linear-gradient(135deg, rgba(255, 26, 92, 0.1), rgba(124, 58, 237, 0.1));
  border-radius: var(--onyx-radius-lg);
  margin-bottom: var(--onyx-space-6);
}

.onyx-amount-label {
  display: block;
  font-size: var(--onyx-text-sm);
  color: var(--onyx-muted-fg);
  margin-bottom: var(--onyx-space-2);
  text-transform: uppercase;
  letter-spacing: var(--onyx-tracking-wide);
}

.onyx-amount-value {
  display: block;
  font-size: var(--onyx-text-4xl);
  font-weight: var(--onyx-weight-black);
  color: var(--onyx-primary);
  text-shadow: 0 0 30px rgba(255, 26, 92, 0.6);
  margin-bottom: var(--onyx-space-2);
}

.onyx-amount-atomic {
  display: block;
  font-size: var(--onyx-text-xs);
  color: var(--onyx-muted-fg);
  font-family: var(--onyx-font-mono);
}

/* === TIMELINE VISUALIZATION === */

.onyx-timeline {
  position: relative;
  padding-left: var(--onyx-space-12);
}

.onyx-timeline::before {
  content: '';
  position: absolute;
  left: 28px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: linear-gradient(180deg, hsl(0, 0%, 20%) 0%, hsl(0, 0%, 10%) 100%);
}

.onyx-timeline-step {
  position: relative;
  padding-bottom: var(--onyx-space-8);
}

.onyx-timeline-step:last-child {
  padding-bottom: 0;
}

.onyx-timeline-marker {
  position: absolute;
  left: -44px;
  top: 0;
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: rgba(13, 13, 13, 0.95);
  border: 2px solid hsl(0, 0%, 20%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: var(--onyx-weight-bold);
  color: var(--onyx-muted-fg);
  z-index: 2;
}

.onyx-timeline-step.completed .onyx-timeline-marker {
  background: linear-gradient(135deg, rgba(255, 26, 92, 0.2), rgba(124, 58, 237, 0.2));
  border-color: var(--onyx-primary);
  color: var(--onyx-primary);
  box-shadow: 0 0 20px rgba(255, 26, 92, 0.4);
}

.onyx-timeline-step.active .onyx-timeline-marker {
  background: linear-gradient(135deg, rgba(0, 217, 255, 0.2), rgba(124, 58, 237, 0.2));
  border-color: hsl(190, 100%, 50%);
  color: hsl(190, 100%, 50%);
  box-shadow: 0 0 20px rgba(0, 217, 255, 0.4);
  animation: pulse-ring 2s infinite;
}

@keyframes pulse-ring {
  0% {
    box-shadow: 0 0 0 0 rgba(0, 217, 255, 0.4);
  }
  50% {
    box-shadow: 0 0 0 10px rgba(0, 217, 255, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(0, 217, 255, 0);
  }
}

.onyx-timeline-content h3 {
  margin: 0 0 var(--onyx-space-2) 0;
  font-size: var(--onyx-text-lg);
  font-weight: var(--onyx-weight-bold);
  color: var(--onyx-fg);
}

.onyx-timeline-desc {
  margin: 0 0 var(--onyx-space-2) 0;
  color: var(--onyx-muted-fg);
  font-size: var(--onyx-text-sm);
}

.onyx-timeline-time {
  font-size: var(--onyx-text-xs);
  color: var(--onyx-muted-fg);
  font-family: var(--onyx-font-mono);
}

.onyx-address-box {
  margin-top: var(--onyx-space-3);
  padding: var(--onyx-space-3);
  background: rgba(10, 10, 10, 0.8);
  border-radius: var(--onyx-radius-md);
  border: 1px solid hsl(0, 0%, 15%);
}

.onyx-address-label {
  display: block;
  font-size: var(--onyx-text-xs);
  color: var(--onyx-muted-fg);
  margin-bottom: var(--onyx-space-2);
  text-transform: uppercase;
  letter-spacing: var(--onyx-tracking-wide);
}

.onyx-monero-address {
  display: block;
  font-family: var(--onyx-font-mono);
  font-size: var(--onyx-text-xs);
  color: hsl(190, 100%, 50%);
  word-break: break-all;
}

/* === PARTICIPANTS === */

.onyx-participants {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: var(--onyx-space-4);
  margin-top: var(--onyx-space-6);
}

.onyx-participant {
  text-align: center;
  padding: var(--onyx-space-4);
  background: rgba(10, 10, 10, 0.6);
  border-radius: var(--onyx-radius-md);
  border: 1px solid hsl(0, 0%, 15%);
  transition: all var(--onyx-transition-base);
}

.onyx-participant:hover {
  border-color: var(--onyx-primary);
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(255, 26, 92, 0.2);
}

.onyx-participant-icon {
  width: 48px;
  height: 48px;
  margin: 0 auto var(--onyx-space-3);
  padding: var(--onyx-space-3);
  border-radius: 50%;
  background: linear-gradient(135deg, rgba(255, 26, 92, 0.2), rgba(124, 58, 237, 0.2));
}

.onyx-participant-icon svg {
  width: 100%;
  height: 100%;
  color: var(--onyx-primary);
}

.onyx-participant h3 {
  margin: 0 0 var(--onyx-space-1) 0;
  font-size: var(--onyx-text-sm);
  font-weight: var(--onyx-weight-bold);
  color: var(--onyx-fg);
  text-transform: uppercase;
  letter-spacing: var(--onyx-tracking-wide);
}

.onyx-participant p {
  margin: 0;
  font-size: var(--onyx-text-sm);
  color: var(--onyx-muted-fg);
}

/* === ACTIONS === */

.onyx-actions-grid {
  display: grid;
  gap: var(--onyx-space-3);
  margin-top: var(--onyx-space-6);
}

@media (max-width: 1024px) {
  .onyx-escrow-grid {
    grid-template-columns: 1fr;
  }

  .onyx-participants {
    grid-template-columns: 1fr;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="onyx-escrow-container">
  <!-- Header -->
  <div class="onyx-escrow-header">
    <div class="onyx-escrow-title-group">
      <h1>ESCROW #{{ escrow.id | truncate(length=8, end="") }}</h1>
      <p class="onyx-escrow-subtitle">2-of-3 Multisig Protection</p>
    </div>
    <span class="onyx-status-badge onyx-status-{{ escrow.status }}">
      {{ escrow.status }}
    </span>
  </div>

  <!-- Trust Meter Widget - Phase 1.1: "Trust Through Math" -->
  {{ trust::trust_meter(escrow=escrow, timeout_config=timeout_config) }}

  <!-- Main Grid -->
  <div class="onyx-escrow-grid">
    <!-- Left Column: Timeline -->
    <div class="onyx-glass-card">
      <!-- Amount Display -->
      <div class="onyx-amount-display">
        <span class="onyx-amount-label">Escrow Amount</span>
        <span class="onyx-amount-value">{{ escrow.amount_xmr }} XMR</span>
        <span class="onyx-amount-atomic">{{ escrow.amount_atomic }} atomic units</span>
      </div>

      <h2 style="margin: 0 0 var(--onyx-space-6) 0; color: var(--onyx-fg); font-size: var(--onyx-text-xl);">Escrow Process</h2>

      <!-- Timeline -->
      <div class="onyx-timeline">
        <!-- Step 1: Created -->
        <div class="onyx-timeline-step {% if escrow.status != 'created' %}completed{% else %}active{% endif %}">
          <div class="onyx-timeline-marker">
            {% if escrow.status != 'created' %}
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            {% else %}
              1
            {% endif %}
          </div>
          <div class="onyx-timeline-content">
            <h3>Escrow Initiated</h3>
            <p class="onyx-timeline-desc">Multisig wallet created (Buyer, Vendor, Arbiter)</p>
            <span class="onyx-timeline-time">{{ escrow.created_at | date(format="%Y-%m-%d %H:%M UTC") }}</span>
          </div>
        </div>

        <!-- Step 2: Multisig Setup -->
        <div class="onyx-timeline-step {% if escrow.multisig_address %}completed{% elif escrow.status == 'created' %}active{% endif %}">
          <div class="onyx-timeline-marker">
            {% if escrow.multisig_address %}
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            {% else %}
              2
            {% endif %}
          </div>
          <div class="onyx-timeline-content">
            <h3>Multisig Setup Complete</h3>
            <p class="onyx-timeline-desc">All parties exchanged multisig info</p>
            {% if escrow.multisig_address %}
              <div class="onyx-address-box">
                <span class="onyx-address-label">Multisig Address:</span>
                <code class="onyx-monero-address">{{ escrow.multisig_address }}</code>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Step 3: Funded -->
        <div class="onyx-timeline-step {% if escrow.status == 'funded' or escrow.status == 'releasing' or escrow.status == 'refunding' or escrow.status == 'completed' %}completed{% elif escrow.multisig_address and escrow.status == 'created' %}active{% endif %}">
          <div class="onyx-timeline-marker">
            {% if escrow.status == 'funded' or escrow.status == 'releasing' or escrow.status == 'refunding' or escrow.status == 'completed' %}
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            {% else %}
              3
            {% endif %}
          </div>
          <div class="onyx-timeline-content">
            <h3>Escrow Funded</h3>
            <p class="onyx-timeline-desc">Buyer deposited {{ escrow.amount_xmr }} XMR</p>
            {% if escrow.transaction_hash %}
              <div class="onyx-address-box">
                <span class="onyx-address-label">TX Hash:</span>
                <code class="onyx-monero-address">{{ escrow.transaction_hash }}</code>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Step 4: Resolution -->
        <div class="onyx-timeline-step {% if escrow.status == 'completed' %}completed{% elif escrow.status == 'releasing' or escrow.status == 'refunding' %}active{% endif %}">
          <div class="onyx-timeline-marker">
            {% if escrow.status == 'completed' %}
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            {% else %}
              4
            {% endif %}
          </div>
          <div class="onyx-timeline-content">
            {% if escrow.status == 'completed' %}
              <h3>Funds Released</h3>
              <p class="onyx-timeline-desc">Transaction confirmed on blockchain</p>
            {% elif escrow.status == 'releasing' %}
              <h3>Releasing to Vendor</h3>
              <p class="onyx-timeline-desc">2-of-3 signatures: Buyer + Arbiter</p>
            {% elif escrow.status == 'refunding' %}
              <h3>Refunding to Buyer</h3>
              <p class="onyx-timeline-desc">2-of-3 signatures: Vendor + Arbiter</p>
            {% else %}
              <h3>Awaiting Resolution</h3>
              <p class="onyx-timeline-desc">Pending buyer confirmation or dispute</p>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Participants -->
      <h2 style="margin: var(--onyx-space-6) 0 var(--onyx-space-4) 0; color: var(--onyx-fg); font-size: var(--onyx-text-xl);">Participants</h2>
      <div class="onyx-participants">
        <div class="onyx-participant">
          <div class="onyx-participant-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
            </svg>
          </div>
          <h3>Buyer</h3>
          <p>{{ escrow.buyer_id | truncate(length=8, end="...") }}</p>
        </div>

        <div class="onyx-participant">
          <div class="onyx-participant-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
          </div>
          <h3>Vendor</h3>
          <p>{{ escrow.vendor_id | truncate(length=8, end="...") }}</p>
        </div>

        <div class="onyx-participant">
          <div class="onyx-participant-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
          </div>
          <h3>Arbiter</h3>
          <p>FROST MARKET System</p>
        </div>
      </div>
    </div>

    <!-- Right Column: Actions & Info -->
    <div>
      <!-- Quick Actions (show based on user role and status) -->
      {% if user_role == "buyer" and escrow.status == "funded" %}
      <div class="onyx-glass-card" style="margin-bottom: var(--onyx-space-4);">
        <h2 style="margin: 0 0 var(--onyx-space-4) 0; color: var(--onyx-fg); font-size: var(--onyx-text-lg);">Quick Actions</h2>
        <div class="onyx-actions-grid">
          <button class="onyx-btn onyx-btn-primary"
                  hx-get="/escrow/{{ escrow.id }}/release-form"
                  hx-target="#modal-container"
                  hx-swap="innerHTML">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Release Funds
          </button>
          <button class="onyx-btn onyx-btn-destructive"
                  hx-get="/escrow/{{ escrow.id }}/modals/dispute"
                  hx-target="#modal-container"
                  hx-swap="innerHTML">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            Open Dispute
          </button>
        </div>
      </div>
      {% endif %}

      {% if user_role == "vendor" and escrow.status == "funded" %}
      <div class="onyx-glass-card" style="margin-bottom: var(--onyx-space-4);">
        <h2 style="margin: 0 0 var(--onyx-space-4) 0; color: var(--onyx-fg); font-size: var(--onyx-text-lg);">Quick Actions</h2>
        <div class="onyx-actions-grid">
          <button class="onyx-btn onyx-btn-secondary"
                  hx-get="/escrow/{{ escrow.id }}/refund-form"
                  hx-target="#modal-container"
                  hx-swap="innerHTML">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
            </svg>
            Refund Buyer
          </button>
        </div>
      </div>
      {% endif %}

      <!-- Auto-Escalation Warning Banner -->
      {% if escrow.auto_escalated_at %}
      <div class="onyx-glass-card" style="margin-bottom: var(--onyx-space-4); background: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(239, 68, 68, 0.15)); border: 1px solid hsl(38, 92%, 50%);">
        <div style="display: flex; align-items: flex-start; gap: var(--onyx-space-3);">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="hsl(38, 92%, 50%)" stroke-width="2" style="flex-shrink: 0; margin-top: 2px;">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div>
            <h3 style="margin: 0 0 var(--onyx-space-2) 0; color: hsl(38, 92%, 50%); font-size: var(--onyx-text-md); font-weight: var(--onyx-weight-bold);">
              ‚ö†Ô∏è Dispute Auto-Escalated
            </h3>
            <p style="margin: 0 0 var(--onyx-space-2) 0; color: var(--onyx-fg); font-size: var(--onyx-text-sm); line-height: 1.6;">
              This dispute was automatically escalated after 7 days without resolution.
              {% if escrow.escalation_reason %}
              <br><strong>Reason:</strong> {{ escrow.escalation_reason }}
              {% endif %}
            </p>
            <p style="margin: 0; color: var(--onyx-muted-fg); font-size: var(--onyx-text-xs);">
              Escalated at: {{ escrow.auto_escalated_at }}
            </p>
          </div>
        </div>
      </div>
      {% endif %}

      <!-- Arbiter Resolution Panel (only for arbiter) -->
      {% if escrow.status == "disputed" and escrow_user_role == "arbiter" %}
      <div class="onyx-glass-card arbiter-panel">
        <div class="arbiter-panel__header">
          <div class="arbiter-panel__icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3" />
            </svg>
          </div>
          <div>
            <h2 class="arbiter-panel__title">Arbiter Resolution</h2>
            <p class="arbiter-panel__subtitle">Make your decision to resolve this dispute</p>
          </div>
        </div>

        {% if escrow.dispute_signing_pair %}
        <!-- Decision Already Made -->
        <div class="arbiter-panel__decision-made">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div>
            <span class="arbiter-panel__decision-label">Decision Recorded</span>
            <span class="arbiter-panel__decision-value">
              {% if escrow.dispute_signing_pair == "arbiter_buyer" %}
              Refund to Buyer ‚Äî Awaiting signatures (Arbiter + Buyer)
              {% elif escrow.dispute_signing_pair == "arbiter_vendor" %}
              Release to Vendor ‚Äî Awaiting signatures (Arbiter + Vendor)
              {% endif %}
            </span>
          </div>
        </div>
        {% else %}
        <!-- Resolution Options -->
        <div class="arbiter-panel__options">
          <button id="resolve-buyer-btn" class="arbiter-option arbiter-option--refund" onclick="setDisputeSigningPair('arbiter_buyer')">
            <div class="arbiter-option__icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
              </svg>
            </div>
            <div class="arbiter-option__content">
              <span class="arbiter-option__title">Refund Buyer</span>
              <span class="arbiter-option__desc">Return funds to the buyer</span>
            </div>
            <div class="arbiter-option__signers">
              <span>Signers:</span>
              <div class="arbiter-option__signer-badges">
                <span class="signer-badge signer-badge--arbiter">Arbiter</span>
                <span class="signer-badge signer-badge--buyer">Buyer</span>
              </div>
            </div>
          </button>

          <button id="resolve-vendor-btn" class="arbiter-option arbiter-option--release" onclick="setDisputeSigningPair('arbiter_vendor')">
            <div class="arbiter-option__icon">
              <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div class="arbiter-option__content">
              <span class="arbiter-option__title">Release to Vendor</span>
              <span class="arbiter-option__desc">Complete the transaction</span>
            </div>
            <div class="arbiter-option__signers">
              <span>Signers:</span>
              <div class="arbiter-option__signer-badges">
                <span class="signer-badge signer-badge--arbiter">Arbiter</span>
                <span class="signer-badge signer-badge--vendor">Vendor</span>
              </div>
            </div>
          </button>
        </div>

        <div class="arbiter-panel__warning">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <span>This decision is final and cannot be reversed. Review all evidence before proceeding.</span>
        </div>
        {% endif %}
      </div>

      <style>
      .arbiter-panel {
        border: 1px solid rgba(139, 92, 246, 0.3) !important;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(139, 92, 246, 0.02)) !important;
        margin-bottom: var(--onyx-space-4);
      }
      .arbiter-panel__header {
        display: flex;
        align-items: flex-start;
        gap: var(--onyx-space-3);
        margin-bottom: var(--onyx-space-4);
        padding-bottom: var(--onyx-space-4);
        border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      }
      .arbiter-panel__icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1));
        display: flex;
        align-items: center;
        justify-content: center;
        color: #a78bfa;
        flex-shrink: 0;
      }
      .arbiter-panel__title {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #e2e8f0;
        letter-spacing: -0.01em;
      }
      .arbiter-panel__subtitle {
        margin: 4px 0 0 0;
        font-size: 0.8125rem;
        color: rgba(255, 255, 255, 0.5);
      }
      .arbiter-panel__decision-made {
        display: flex;
        align-items: center;
        gap: var(--onyx-space-3);
        padding: var(--onyx-space-4);
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.05));
        border: 1px solid rgba(34, 197, 94, 0.3);
        border-radius: 12px;
        color: #4ade80;
      }
      .arbiter-panel__decision-label {
        display: block;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        opacity: 0.8;
      }
      .arbiter-panel__decision-value {
        display: block;
        font-size: 0.875rem;
        font-weight: 500;
        margin-top: 2px;
      }
      .arbiter-panel__options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--onyx-space-3);
      }
      .arbiter-option {
        display: flex;
        flex-direction: column;
        gap: var(--onyx-space-3);
        padding: var(--onyx-space-4);
        border-radius: 12px;
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        text-align: left;
        background: rgba(255, 255, 255, 0.02);
      }
      .arbiter-option:hover {
        transform: translateY(-2px);
      }
      .arbiter-option--refund {
        border-color: rgba(59, 130, 246, 0.3);
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.02));
      }
      .arbiter-option--refund:hover {
        border-color: rgba(59, 130, 246, 0.5);
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
        box-shadow: 0 8px 32px rgba(59, 130, 246, 0.2);
      }
      .arbiter-option--release {
        border-color: rgba(34, 197, 94, 0.3);
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.02));
      }
      .arbiter-option--release:hover {
        border-color: rgba(34, 197, 94, 0.5);
        background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(34, 197, 94, 0.05));
        box-shadow: 0 8px 32px rgba(34, 197, 94, 0.2);
      }
      .arbiter-option__icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .arbiter-option--refund .arbiter-option__icon {
        background: rgba(59, 130, 246, 0.15);
        color: #60a5fa;
      }
      .arbiter-option--release .arbiter-option__icon {
        background: rgba(34, 197, 94, 0.15);
        color: #4ade80;
      }
      .arbiter-option__content {
        flex: 1;
      }
      .arbiter-option__title {
        display: block;
        font-size: 1rem;
        font-weight: 600;
        color: #e2e8f0;
        margin-bottom: 4px;
      }
      .arbiter-option__desc {
        display: block;
        font-size: 0.8125rem;
        color: rgba(255, 255, 255, 0.5);
      }
      .arbiter-option__signers {
        padding-top: var(--onyx-space-3);
        border-top: 1px solid rgba(255, 255, 255, 0.06);
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.4);
      }
      .arbiter-option__signer-badges {
        display: flex;
        gap: 6px;
        margin-top: 6px;
      }
      .signer-badge {
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.6875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.03em;
      }
      .signer-badge--arbiter {
        background: rgba(139, 92, 246, 0.2);
        color: #a78bfa;
      }
      .signer-badge--buyer {
        background: rgba(59, 130, 246, 0.2);
        color: #60a5fa;
      }
      .signer-badge--vendor {
        background: rgba(34, 197, 94, 0.2);
        color: #4ade80;
      }
      .arbiter-panel__warning {
        display: flex;
        align-items: center;
        gap: var(--onyx-space-2);
        margin-top: var(--onyx-space-4);
        padding: var(--onyx-space-3);
        background: rgba(251, 191, 36, 0.08);
        border: 1px solid rgba(251, 191, 36, 0.2);
        border-radius: 8px;
        font-size: 0.75rem;
        color: #fbbf24;
      }
      @media (max-width: 640px) {
        .arbiter-panel__options {
          grid-template-columns: 1fr;
        }
      }
      </style>
      {% endif %}

      <!-- Dispute Evidence Section (only when disputed) -->
      {% if escrow.status == "disputed" %}
      <div class="onyx-glass-card" style="margin-bottom: var(--onyx-space-4);">
        <h2 style="margin: 0 0 var(--onyx-space-4) 0; color: hsl(0, 85%, 60%); font-size: var(--onyx-text-lg); display: flex; align-items: center; gap: var(--onyx-space-2);">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          Dispute Evidence
        </h2>

        <!-- Dispute Reason -->
        {% if escrow.dispute_reason %}
        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid hsl(0, 85%, 50%); border-radius: var(--onyx-radius-md); padding: var(--onyx-space-4); margin-bottom: var(--onyx-space-4);">
          <span style="display: block; font-size: var(--onyx-text-xs); color: var(--onyx-muted-fg); text-transform: uppercase; margin-bottom: var(--onyx-space-2);">Dispute Reason:</span>
          <p style="margin: 0; color: var(--onyx-fg); font-size: var(--onyx-text-sm); line-height: 1.6;">{{ escrow.dispute_reason }}</p>
        </div>
        {% endif %}

        <!-- Evidence List -->
        <div id="evidence-list"
             hx-get="/api/escrow/{{ escrow.id }}/dispute/evidence"
             hx-trigger="load"
             hx-target="#evidence-list-content"
             hx-swap="innerHTML">
          <div id="evidence-list-content">
            <div style="text-align: center; padding: var(--onyx-space-4); color: var(--onyx-muted-fg);">
              <div class="apple-spinner-sm" style="margin: 0 auto var(--onyx-space-2);"></div>
              Loading evidence...
            </div>
          </div>
        </div>

        <!-- Upload Evidence Form -->
        <div style="margin-top: var(--onyx-space-4); padding-top: var(--onyx-space-4); border-top: 1px solid hsl(0, 0%, 15%);">
          <h3 style="margin: 0 0 var(--onyx-space-3) 0; font-size: var(--onyx-text-sm); color: var(--onyx-fg);">Upload Evidence</h3>
          <form id="evidence-upload-form" enctype="multipart/form-data">
            <div id="evidence-dropzone"
                 style="border: 2px dashed hsl(0, 0%, 25%); border-radius: var(--onyx-radius-md); padding: var(--onyx-space-6); text-align: center; cursor: pointer; transition: all 0.2s;"
                 ondragover="event.preventDefault(); this.style.borderColor='var(--onyx-primary)'; this.style.background='rgba(255,26,92,0.1)';"
                 ondragleave="this.style.borderColor='hsl(0, 0%, 25%)'; this.style.background='transparent';"
                 ondrop="handleEvidenceDrop(event)"
                 onclick="document.getElementById('evidence-file-input').click()">
              <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto var(--onyx-space-3); color: var(--onyx-muted-fg);">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
              </svg>
              <p style="margin: 0 0 var(--onyx-space-2); color: var(--onyx-fg); font-size: var(--onyx-text-sm);">Drop files here or click to upload</p>
              <p style="margin: 0; color: var(--onyx-muted-fg); font-size: var(--onyx-text-xs);">PDF, JPEG, PNG, GIF, TXT ‚Ä¢ Max 5MB per file ‚Ä¢ Max 10 files total</p>
            </div>
            <input type="file" id="evidence-file-input" name="file" accept=".pdf,.jpg,.jpeg,.png,.gif,.txt" style="display: none;" onchange="uploadEvidence(this.files[0])">
            <textarea name="description" id="evidence-description" placeholder="Optional: Describe this evidence..."
                      style="width: 100%; margin-top: var(--onyx-space-3); padding: var(--onyx-space-3); background: rgba(10,10,10,0.8); border: 1px solid hsl(0,0%,15%); border-radius: var(--onyx-radius-md); color: var(--onyx-fg); font-size: var(--onyx-text-sm); resize: vertical; min-height: 60px;"></textarea>
          </form>
          <div id="evidence-upload-status" style="margin-top: var(--onyx-space-2);"></div>
        </div>

        <!-- Buyer Refund Address (v0.66.3) - Only for buyer in disputed escrow -->
        {% if escrow_user_role == "buyer" %}
        <div style="margin-top: var(--onyx-space-4); padding-top: var(--onyx-space-4); border-top: 1px solid hsl(0, 0%, 15%);">
          <h3 style="margin: 0 0 var(--onyx-space-3) 0; font-size: var(--onyx-text-sm); color: var(--onyx-fg); display: flex; align-items: center; gap: var(--onyx-space-2);">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6" />
            </svg>
            Your Refund Address
          </h3>
          <p style="margin: 0 0 var(--onyx-space-3) 0; color: var(--onyx-muted-fg); font-size: var(--onyx-text-xs); line-height: 1.5;">
            If the arbiter decides in your favor, funds will be sent to this address. Set it now to avoid delays.
          </p>

          {% if escrow.buyer_refund_address %}
          <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid hsl(142, 71%, 45%); border-radius: var(--onyx-radius-md); padding: var(--onyx-space-3); margin-bottom: var(--onyx-space-3);">
            <span style="color: hsl(142, 71%, 45%); font-size: var(--onyx-text-xs);">‚úì Refund address set:</span>
            <p style="margin: var(--onyx-space-1) 0 0 0; color: var(--onyx-fg); font-size: var(--onyx-text-xs); font-family: monospace; word-break: break-all;">
              {{ escrow.buyer_refund_address }}
            </p>
          </div>
          {% endif %}

          <div style="display: flex; gap: var(--onyx-space-2);">
            <input type="text"
                   id="buyer-refund-address"
                   placeholder="Your Monero address (95 or 106 characters)"
                   value="{{ escrow.buyer_refund_address | default(value='') }}"
                   style="flex: 1; padding: var(--onyx-space-3); background: rgba(10,10,10,0.8); border: 1px solid hsl(0,0%,20%); border-radius: var(--onyx-radius-md); color: var(--onyx-fg); font-size: var(--onyx-text-sm); font-family: monospace;">
            <button onclick="setRefundAddress()"
                    id="set-refund-btn"
                    style="padding: var(--onyx-space-3) var(--onyx-space-4); background: linear-gradient(135deg, hsl(200, 80%, 50%), hsl(200, 80%, 40%)); border: none; border-radius: var(--onyx-radius-md); color: white; font-weight: var(--onyx-weight-bold); font-size: var(--onyx-text-sm); cursor: pointer; white-space: nowrap;">
              {% if escrow.buyer_refund_address %}Update{% else %}Set Address{% endif %}
            </button>
          </div>
          <div id="refund-address-status" style="margin-top: var(--onyx-space-2);"></div>
        </div>
        {% endif %}
      </div>
      {% endif %}

      <!-- Security Info -->
      <div class="onyx-glass-card" style="margin-bottom: var(--onyx-space-4);">
        <h2 style="margin: 0 0 var(--onyx-space-4) 0; color: var(--onyx-fg); font-size: var(--onyx-text-lg);">Security Features</h2>
        <div style="display: flex; flex-direction: column; gap: var(--onyx-space-3);">
          <div style="display: flex; align-items: center; gap: var(--onyx-space-3);">
            <svg style="width: 20px; height: 20px; color: var(--onyx-primary); flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            <span style="color: var(--onyx-muted-fg); font-size: var(--onyx-text-sm);">2-of-3 Multisig Protection</span>
          </div>
          <div style="display: flex; align-items: center; gap: var(--onyx-space-3);">
            <svg style="width: 20px; height: 20px; color: var(--onyx-primary); flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            <span style="color: var(--onyx-muted-fg); font-size: var(--onyx-text-sm);">Monero Privacy Features</span>
          </div>
          <div style="display: flex; align-items: center; gap: var(--onyx-space-3);">
            <svg style="width: 20px; height: 20px; color: var(--onyx-primary); flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            <span style="color: var(--onyx-muted-fg); font-size: var(--onyx-text-sm);">Neutral Arbiter System</span>
          </div>
          <div style="display: flex; align-items: center; gap: var(--onyx-space-3);">
            <svg style="width: 20px; height: 20px; color: var(--onyx-primary); flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            <span style="color: var(--onyx-muted-fg); font-size: var(--onyx-text-sm);">Testnet Only (v0.2.6)</span>
          </div>
        </div>
      </div>

      <!-- How It Works -->
      <div class="onyx-glass-card">
        <h2 style="margin: 0 0 var(--onyx-space-4) 0; color: var(--onyx-fg); font-size: var(--onyx-text-lg);">How 2-of-3 Works</h2>
        <p style="color: var(--onyx-muted-fg); font-size: var(--onyx-text-sm); line-height: 1.6; margin-bottom: var(--onyx-space-4);">
          Any 2 out of 3 parties (Buyer, Vendor, Arbiter) must sign to move funds.
        </p>
        <h3 style="margin: 0 0 var(--onyx-space-2) 0; color: var(--onyx-fg); font-size: var(--onyx-text-sm); font-weight: var(--onyx-weight-bold);">Scenarios:</h3>
        <ul style="margin: 0; padding-left: var(--onyx-space-5); color: var(--onyx-muted-fg); font-size: var(--onyx-text-sm); line-height: 1.8;">
          <li><strong style="color: var(--onyx-primary);">Happy Path:</strong> Buyer + Arbiter ‚Üí Release to vendor</li>
          <li><strong style="color: var(--onyx-secondary);">Refund:</strong> Vendor + Arbiter ‚Üí Return to buyer</li>
          <li><strong style="color: hsl(45, 100%, 55%);">Dispute:</strong> Arbiter decides based on evidence</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Modal Container for Forms -->
<div id="modal-container"></div>
{% endblock %}

{% block scripts %}
<script>
// WebSocket for live escrow updates (Onyx version)
(function() {
  const escrowId = '{{ escrow.id }}';
  const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
  const wsUrl = wsProtocol + '//' + window.location.host + '/ws/';

  let ws;
  let reconnectAttempts = 0;
  const maxReconnectAttempts = 5;

  function connect() {
    ws = new WebSocket(wsUrl);

    ws.onopen = function() {
      console.log('‚úÖ WebSocket connected for escrow:', escrowId);
      reconnectAttempts = 0;

      // Subscribe to escrow updates
      ws.send(JSON.stringify({
        type: 'subscribe',
        channel: 'escrow:' + escrowId
      }));
    };

    ws.onmessage = function(event) {
      try {
        const data = JSON.parse(event.data);
        console.log('Escrow update received:', data);

        if (data.type === 'EscrowStatusChanged' && data.escrow_id === escrowId) {
          // Show toast notification
          if (window.notificationManager) {
            window.notificationManager.showToast(
              'üîí Escrow Updated',
              `Status changed to: ${data.new_status}`,
              'success',
              3000
            );
          }

          // Reload page after 2 seconds to show updated status
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        }
      } catch (e) {
        console.error('Failed to parse WebSocket message:', e);
      }
    };

    ws.onerror = function(error) {
      console.error('WebSocket error:', error);
    };

    ws.onclose = function() {
      console.log('WebSocket disconnected');

      if (reconnectAttempts < maxReconnectAttempts) {
        reconnectAttempts++;
        console.log(`Reconnecting... (attempt ${reconnectAttempts}/${maxReconnectAttempts})`);
        setTimeout(connect, 3000);
      }
    };
  }

  // Initialize connection
  connect();
})();

// === Evidence Upload Functions ===
function handleEvidenceDrop(event) {
  event.preventDefault();
  const dropzone = document.getElementById('evidence-dropzone');
  dropzone.style.borderColor = 'hsl(0, 0%, 25%)';
  dropzone.style.background = 'transparent';

  const files = event.dataTransfer.files;
  if (files.length > 0) {
    uploadEvidence(files[0]);
  }
}

async function uploadEvidence(file) {
  if (!file) return;

  const statusDiv = document.getElementById('evidence-upload-status');
  const maxSize = 5 * 1024 * 1024; // 5MB

  // Validate file size
  if (file.size > maxSize) {
    statusDiv.innerHTML = '<p style="color: hsl(0, 85%, 60%); font-size: var(--onyx-text-sm);">‚ùå File too large (max 5MB)</p>';
    return;
  }

  // Validate file type
  const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/gif', 'text/plain'];
  if (!allowedTypes.includes(file.type)) {
    statusDiv.innerHTML = '<p style="color: hsl(0, 85%, 60%); font-size: var(--onyx-text-sm);">‚ùå Invalid file type. Allowed: PDF, JPEG, PNG, GIF, TXT</p>';
    return;
  }

  // Show uploading status
  statusDiv.innerHTML = '<div style="display: flex; align-items: center; gap: var(--onyx-space-2);"><div class="apple-spinner-sm"></div><span style="color: var(--onyx-muted-fg); font-size: var(--onyx-text-sm);">Uploading...</span></div>';

  const formData = new FormData();
  formData.append('file', file);

  const description = document.getElementById('evidence-description').value.trim();
  if (description) {
    formData.append('description', description);
  }

  try {
    const escrowId = '{{ escrow.id }}';
    const response = await fetch(`/api/escrow/${escrowId}/dispute/evidence`, {
      method: 'POST',
      body: formData,
      credentials: 'include'
    });

    const result = await response.json();

    if (response.ok && result.success) {
      statusDiv.innerHTML = '<p style="color: hsl(145, 65%, 55%); font-size: var(--onyx-text-sm);">‚úÖ Evidence uploaded successfully</p>';
      // Clear form
      document.getElementById('evidence-description').value = '';
      document.getElementById('evidence-file-input').value = '';
      // Refresh evidence list
      htmx.trigger('#evidence-list', 'load');
      // Show toast
      if (window.notificationManager) {
        window.notificationManager.showToast('Evidence Uploaded', result.file_name, 'success', 4000);
      }
    } else {
      statusDiv.innerHTML = `<p style="color: hsl(0, 85%, 60%); font-size: var(--onyx-text-sm);">‚ùå ${result.error || 'Upload failed'}</p>`;
    }
  } catch (error) {
    console.error('Evidence upload error:', error);
    statusDiv.innerHTML = '<p style="color: hsl(0, 85%, 60%); font-size: var(--onyx-text-sm);">‚ùå Upload failed. Please try again.</p>';
  }
}

// Format evidence list response for display
document.body.addEventListener('htmx:beforeSwap', function(evt) {
  if (evt.detail.target.id === 'evidence-list-content') {
    try {
      const response = JSON.parse(evt.detail.xhr.responseText);
      if (response.success) {
        if (response.evidence.length === 0) {
          evt.detail.serverResponse = '<p style="text-align: center; color: var(--onyx-muted-fg); font-size: var(--onyx-text-sm); padding: var(--onyx-space-4);">No evidence uploaded yet.</p>';
        } else {
          let html = '<div style="display: flex; flex-direction: column; gap: var(--onyx-space-3);">';
          response.evidence.forEach(e => {
            const roleColor = e.uploader_role === 'buyer' ? 'hsl(190, 100%, 50%)' :
                              e.uploader_role === 'vendor' ? 'var(--onyx-primary)' : 'hsl(45, 100%, 55%)';
            html += `
              <div style="background: rgba(10,10,10,0.6); border: 1px solid hsl(0,0%,15%); border-radius: var(--onyx-radius-md); padding: var(--onyx-space-3);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--onyx-space-2);">
                  <span style="color: ${roleColor}; font-size: var(--onyx-text-xs); text-transform: uppercase; font-weight: var(--onyx-weight-bold);">${e.uploader_role}</span>
                  <span style="color: var(--onyx-muted-fg); font-size: var(--onyx-text-xs);">${e.created_at}</span>
                </div>
                <a href="${e.download_url}" target="_blank" style="color: var(--onyx-fg); text-decoration: none; font-size: var(--onyx-text-sm); display: flex; align-items: center; gap: var(--onyx-space-2);">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                  </svg>
                  ${e.file_name} <span style="color: var(--onyx-muted-fg);">(${(e.file_size / 1024).toFixed(1)} KB)</span>
                </a>
                ${e.description ? `<p style="margin: var(--onyx-space-2) 0 0 0; color: var(--onyx-muted-fg); font-size: var(--onyx-text-xs);">${e.description}</p>` : ''}
              </div>
            `;
          });
          html += '</div>';
          html += `<p style="text-align: center; color: var(--onyx-muted-fg); font-size: var(--onyx-text-xs); margin-top: var(--onyx-space-3);">${response.total_count}/10 files uploaded</p>`;
          evt.detail.serverResponse = html;
        }
      } else {
        evt.detail.serverResponse = `<p style="color: hsl(0, 85%, 60%); text-align: center;">${response.error || 'Failed to load evidence'}</p>`;
      }
    } catch (e) {
      // Not JSON, pass through
    }
  }
});

// === Arbiter Resolution Functions ===
async function setDisputeSigningPair(signingPair) {
  const escrowId = '{{ escrow.id }}';
  const action = signingPair === 'arbiter_buyer' ? 'refund to buyer' : 'release to vendor';

  // Confirm the decision
  if (!confirm(`Are you sure you want to ${action}?\n\nThis action is IRREVERSIBLE. The signing pair will be set to ${signingPair} and cannot be changed.`)) {
    return;
  }

  // Disable buttons
  const buyerBtn = document.getElementById('resolve-buyer-btn');
  const vendorBtn = document.getElementById('resolve-vendor-btn');
  if (buyerBtn) buyerBtn.disabled = true;
  if (vendorBtn) vendorBtn.disabled = true;

  try {
    const response = await fetch(`/api/escrow/${escrowId}/dispute/signing-pair`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ signing_pair: signingPair }),
      credentials: 'include'
    });

    const result = await response.json();

    if (response.ok && result.success) {
      // Show success notification
      if (window.notificationManager) {
        window.notificationManager.showToast(
          'Decision Recorded',
          `Signing pair set to: ${signingPair === 'arbiter_buyer' ? 'Arbiter + Buyer' : 'Arbiter + Vendor'}`,
          'success',
          5000
        );
      }
      // Reload the page to show updated state
      setTimeout(() => window.location.reload(), 1500);
    } else {
      // Re-enable buttons
      if (buyerBtn) buyerBtn.disabled = false;
      if (vendorBtn) vendorBtn.disabled = false;
      alert(`Failed to set signing pair: ${result.error || 'Unknown error'}`);
    }
  } catch (error) {
    console.error('Error setting signing pair:', error);
    // Re-enable buttons
    if (buyerBtn) buyerBtn.disabled = false;
    if (vendorBtn) vendorBtn.disabled = false;
    alert('Network error. Please try again.');
  }
}

// === Buyer Refund Address Functions (v0.66.3) ===
async function setRefundAddress() {
  const escrowId = '{{ escrow.id }}';
  const addressInput = document.getElementById('buyer-refund-address');
  const statusDiv = document.getElementById('refund-address-status');
  const submitBtn = document.getElementById('set-refund-btn');

  const refundAddress = addressInput.value.trim();

  // Validate address length
  if (refundAddress.length !== 95 && refundAddress.length !== 106) {
    statusDiv.innerHTML = '<p style="color: hsl(0, 85%, 60%); font-size: var(--onyx-text-xs);">‚ùå Invalid address length. Must be 95 or 106 characters.</p>';
    return;
  }

  // Validate first character
  const validPrefixes = ['4', '5', '7', '8', '9', 'A', 'B'];
  if (!validPrefixes.includes(refundAddress[0])) {
    statusDiv.innerHTML = '<p style="color: hsl(0, 85%, 60%); font-size: var(--onyx-text-xs);">‚ùå Invalid address format. Must start with 4, 5, 7, 8, 9, A, or B.</p>';
    return;
  }

  // Disable button and show loading
  submitBtn.disabled = true;
  submitBtn.textContent = 'Saving...';
  statusDiv.innerHTML = '<div style="display: flex; align-items: center; gap: var(--onyx-space-2);"><div class="apple-spinner-sm"></div><span style="color: var(--onyx-muted-fg); font-size: var(--onyx-text-xs);">Saving address...</span></div>';

  try {
    const response = await fetch(`/api/v2/escrow/${escrowId}/set-refund-address`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ refund_address: refundAddress }),
      credentials: 'include'
    });

    const result = await response.json();

    if (response.ok && result.success) {
      statusDiv.innerHTML = '<p style="color: hsl(142, 71%, 45%); font-size: var(--onyx-text-xs);">‚úÖ Refund address saved successfully</p>';
      submitBtn.textContent = 'Update';
      submitBtn.disabled = false;

      // Show toast notification
      if (window.notificationManager) {
        window.notificationManager.showToast('Address Saved', 'Your refund address has been stored', 'success', 4000);
      }

      // Reload to show updated state after delay
      setTimeout(() => window.location.reload(), 2000);
    } else {
      statusDiv.innerHTML = `<p style="color: hsl(0, 85%, 60%); font-size: var(--onyx-text-xs);">‚ùå ${result.error || 'Failed to save address'}</p>`;
      submitBtn.textContent = 'Set Address';
      submitBtn.disabled = false;
    }
  } catch (error) {
    console.error('Error setting refund address:', error);
    statusDiv.innerHTML = '<p style="color: hsl(0, 85%, 60%); font-size: var(--onyx-text-xs);">‚ùå Network error. Please try again.</p>';
    submitBtn.textContent = 'Set Address';
    submitBtn.disabled = false;
  }
}
</script>
{% endblock %}
