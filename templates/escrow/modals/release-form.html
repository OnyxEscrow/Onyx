<!-- Apple Modal: Release Funds to Vendor -->
<div class="apple-modal active" id="release-modal">
    <div class="apple-modal-content" onclick="event.stopPropagation()">
        <div class="apple-modal-header">
            <h3 class="apple-modal-title">
                <span class="apple-modal-title-icon apple-modal-title-icon-success">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </span>
                Release Funds to Vendor
            </h3>
            <button class="apple-modal-close" onclick="document.getElementById('release-modal').remove()" aria-label="Close">&times;</button>
        </div>

        <div class="apple-modal-body">
            <!-- Warning Notice -->
            <div class="apple-alert apple-alert-warning" style="margin-bottom: 24px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <div>
                    <strong>This action is irreversible</strong>
                    <p style="margin: 4px 0 0 0; font-size: 13px;">Once released, funds will be sent to the vendor's Monero address. Make sure you've received the goods/services before proceeding.</p>
                </div>
            </div>

            <!-- Release Form -->
            <form id="release-form"
                  hx-post="/api/escrow/{{ escrow_id }}/release"
                  hx-ext="json-enc"
                  hx-target="#release-result"
                  hx-swap="innerHTML"
                  hx-indicator="#release-spinner"
                  hx-timeout="30000"
                  hx-disabled-elt="find button[type='submit']">

                {% if csrf_token %}
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                {% endif %}

                <!-- Vendor Address -->
                <div class="apple-form-group">
                    <label for="vendor_address" class="apple-form-label">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 12V7H5a2 2 0 010-4h14v4" />
                            <path d="M3 5v14a2 2 0 002 2h16v-5" />
                            <path d="M18 12a2 2 0 100 4 2 2 0 000-4z" />
                        </svg>
                        Vendor Monero Address
                    </label>
                    <input type="text"
                           name="vendor_address"
                           id="vendor_address"
                           class="apple-input apple-input-mono"
                           placeholder="4ABC...xyz (95 characters)"
                           required
                           pattern="^4[0-9A-Za-z]{94}$"
                           minlength="95"
                           maxlength="95">
                    <span class="apple-form-hint">Monero testnet addresses start with '4' and are exactly 95 characters long.</span>
                </div>

                <!-- Transaction Details -->
                <div class="apple-alert apple-alert-info" style="flex-direction: column; align-items: stretch;">
                    <h4 class="apple-info-title">Transaction Details</h4>
                    <div class="apple-details-grid">
                        <span class="apple-detail-label">Amount:</span>
                        <span class="apple-detail-value">{{ amount_xmr }} XMR</span>

                        <span class="apple-detail-label">Signatures Required:</span>
                        <span class="apple-detail-value">2-of-3 (Buyer + Arbiter)</span>

                        <span class="apple-detail-label">Status After Release:</span>
                        <span class="apple-detail-value">
                            <span class="apple-badge apple-badge-warning">Releasing</span>
                        </span>
                    </div>
                </div>

                <!-- Result Container -->
                <div id="release-result"></div>
            </form>
        </div>

        <!-- Actions -->
        <div class="apple-modal-footer">
            <button type="button"
                    class="apple-btn apple-btn-ghost"
                    onclick="document.getElementById('release-modal').remove()">
                Cancel
            </button>
            <button type="submit"
                    form="release-form"
                    class="apple-btn apple-btn-success">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right: 8px;">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Release {{ amount_xmr }} XMR
            </button>
            <div id="release-spinner" class="apple-spinner-inline htmx-indicator">
                <div class="apple-spinner-sm"></div>
                <span>Processing transaction...</span>
            </div>
        </div>
    </div>
</div>

<script>
// Close modal on overlay click
document.getElementById('release-modal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        this.remove();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('release-modal');
        if (modal) modal.remove();
    }
}, { once: true });

// Handle HTMX response
document.getElementById('release-form')?.addEventListener('htmx:afterRequest', function(event) {
    if (event.detail.successful) {
        if (window.notificationManager) {
            window.notificationManager.showToast(
                'Funds Released',
                'Transaction submitted successfully. Awaiting blockchain confirmation.',
                'success',
                5000
            );
        }

        setTimeout(() => {
            document.getElementById('release-modal')?.remove();
            window.location.reload();
        }, 2000);
    } else {
        const errorMessage = event.detail.xhr.responseText || 'Failed to release funds';
        if (window.notificationManager) {
            window.notificationManager.showToast(
                'Release Failed',
                errorMessage,
                'error',
                8000
            );
        }
    }
});
</script>
