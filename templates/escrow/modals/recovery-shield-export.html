<!-- Recovery Shield Export Modal -->
<!--
    Creates encrypted backup file containing:
    - BIP39 seed phrase (12 words)
    - FROST DKG key_package (threshold signing share)
    - Escrow metadata for recovery

    File is encrypted with AES-256-GCM (PBKDF2-derived key)
-->
<div id="recovery-shield-modal"
    class="fixed inset-0 z-50 hidden backdrop-blur-sm bg-black/80 transition-opacity duration-300 opacity-0"
    style="display: none; overflow-y: auto !important;">
    <div class="min-h-full flex items-center justify-center p-4 sm:p-6">
    <div class="relative w-full max-w-xl transform rounded-lg bg-[#0a0a0a] border border-white/10 shadow-2xl shadow-black/50 transition-all duration-300 scale-95 opacity-0 translate-y-4 my-8"
        id="recovery-shield-modal-content">

        <!-- Background Gradients -->
        <div class="absolute inset-0 rounded-lg overflow-hidden pointer-events-none">
            <div class="absolute -top-24 -right-24 w-64 h-64 bg-[#D4AF37]/10 rounded-full blur-3xl"></div>
            <div class="absolute -bottom-24 -left-24 w-64 h-64 bg-[#D4AF37]/5 rounded-full blur-3xl"></div>
        </div>

        <!-- Header -->
        <div class="relative p-6 border-b border-white/5 flex items-center justify-between">
            <h3 class="text-xl text-white font-light flex items-center gap-3" style="font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 0.08em;">
                <div class="p-2 rounded-lg bg-[#D4AF37]/20 text-[#D4AF37]">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/>
                        <path d="m9 12 2 2 4-4"/>
                    </svg>
                </div>
                Recovery Shield
            </h3>
            <button onclick="closeRecoveryShieldModal()"
                class="text-gray-400 hover:text-white transition-colors p-2 rounded-lg hover:bg-white/5">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 6 6 18"/><path d="m6 6 12 12"/>
                </svg>
            </button>
        </div>

        <!-- Body -->
        <div class="relative p-6 space-y-5">

            <!-- Info Box -->
            <div class="p-4 rounded-lg bg-[#D4AF37]/10 border border-[#D4AF37]/20 flex items-start gap-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-[#D4AF37] flex-shrink-0 mt-0.5">
                    <circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/>
                </svg>
                <div>
                    <strong class="text-[#D4AF37] font-medium block mb-1">Your Only Lifeline</strong>
                    <p class="text-gray-300 text-sm">
                        This file contains your <strong>Master Key</strong> and <strong>Security Fragment</strong>.
                        Without it, you cannot recover your escrow if you switch browsers or clear your data.
                    </p>
                </div>
            </div>

            <!-- What's Included -->
            <div class="space-y-2">
                <label class="text-xs font-medium text-gray-500 uppercase tracking-wider block" style="font-family: 'Roboto Mono', monospace;">
                    Shield Contents
                </label>
                <div class="grid grid-cols-2 gap-3">
                    <div class="p-3 rounded-lg bg-white/5 border border-white/5 flex items-center gap-3">
                        <div class="p-1.5 rounded bg-green-500/20">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-green-400">
                                <path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                            </svg>
                        </div>
                        <div>
                            <span class="text-xs text-gray-400 block">Master Key</span>
                            <span class="text-sm text-white" id="shield-seed-status">12 words</span>
                        </div>
                    </div>
                    <div class="p-3 rounded-lg bg-white/5 border border-white/5 flex items-center gap-3">
                        <div class="p-1.5 rounded bg-cyan-500/20">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-cyan-400">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/>
                            </svg>
                        </div>
                        <div>
                            <span class="text-xs text-gray-400 block">Security Fragment</span>
                            <span class="text-sm text-white" id="shield-fragment-status">Ready</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Password Input -->
            <div class="space-y-2">
                <label class="text-xs font-medium text-gray-500 uppercase tracking-wider block" style="font-family: 'Roboto Mono', monospace;">
                    Encryption Password
                </label>
                <div class="relative">
                    <input type="password"
                        id="shield-password"
                        placeholder="Minimum 8 characters"
                        class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-[#D4AF37]/50 focus:ring-1 focus:ring-[#D4AF37]/20 transition-all"
                        oninput="updatePasswordStrength(this.value)"
                        style="font-family: 'Roboto Mono', monospace;">
                    <button type="button" onclick="togglePasswordVisibility('shield-password', this)"
                        class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="eye-icon">
                            <path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                    </button>
                </div>

                <!-- Password Strength Meter -->
                <div class="space-y-1">
                    <div class="h-1 bg-white/10 rounded-full overflow-hidden">
                        <div id="password-strength-bar" class="h-full w-0 transition-all duration-300 rounded-full"></div>
                    </div>
                    <p id="password-strength-text" class="text-xs text-gray-500">Enter a strong password</p>
                </div>
            </div>

            <!-- Confirm Password -->
            <div class="space-y-2">
                <label class="text-xs font-medium text-gray-500 uppercase tracking-wider block" style="font-family: 'Roboto Mono', monospace;">
                    Confirm Password
                </label>
                <div class="relative">
                    <input type="password"
                        id="shield-password-confirm"
                        placeholder="Re-enter password"
                        class="w-full px-4 py-3 bg-black/30 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-[#D4AF37]/50 focus:ring-1 focus:ring-[#D4AF37]/20 transition-all"
                        oninput="checkPasswordMatch()"
                        style="font-family: 'Roboto Mono', monospace;">
                    <div id="password-match-indicator" class="absolute right-3 top-1/2 -translate-y-1/2 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-green-400">
                            <path d="M20 6 9 17l-5-5"/>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Error Display -->
            <div id="shield-error" class="hidden p-3 rounded-lg bg-red-500/10 border border-red-500/20 text-red-400 text-sm"></div>

            <!-- Security Notice -->
            <div class="text-xs text-gray-500 flex items-start gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="flex-shrink-0 mt-0.5">
                    <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                </svg>
                <span>Your shield is encrypted locally. NEXUS never sees your password or keys.</span>
            </div>
        </div>

        <!-- Footer -->
        <div class="relative p-6 border-t border-white/5 flex gap-3">
            <button onclick="closeRecoveryShieldModal()"
                class="flex-1 px-6 py-3 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 text-gray-300 hover:text-white font-medium transition-all flex items-center justify-center gap-2"
                style="font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 0.05em;">
                Cancel
            </button>
            <button id="download-shield-btn" onclick="downloadRecoveryShield()" disabled
                class="flex-1 px-6 py-3 rounded-lg text-black font-semibold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none hover:opacity-90 transition-all flex items-center justify-center gap-2"
                style="background: linear-gradient(135deg, #D4AF37, #B8962E); font-family: 'Oswald', sans-serif; text-transform: uppercase; letter-spacing: 0.05em;">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>
                </svg>
                Download Shield
            </button>
        </div>
    </div>
    </div><!-- Close flex wrapper -->
</div>

<script>
// Recovery Shield state
let shieldEscrowId = '';
let shieldRole = '';

/**
 * Show the Recovery Shield export modal
 * @param {string} escrowId - Current escrow ID
 * @param {string} role - User's role (buyer/vendor/arbiter)
 * @param {boolean} mandatory - If true, cannot close without downloading
 */
function showRecoveryShieldModal(escrowId, role, mandatory = false) {
    shieldEscrowId = escrowId;
    shieldRole = role;

    // Check if we have the required data
    const seedPhrase = localStorage.getItem('monero_seed_phrase');
    const keyPackage = localStorage.getItem(`frost_dkg_${escrowId}_${role}_key_package`);

    // Update status indicators
    const seedStatus = document.getElementById('shield-seed-status');
    const fragmentStatus = document.getElementById('shield-fragment-status');

    if (seedStatus) {
        seedStatus.textContent = seedPhrase ? '12 words' : 'Missing';
        seedStatus.className = seedPhrase ? 'text-sm text-white' : 'text-sm text-red-400';
    }

    if (fragmentStatus) {
        fragmentStatus.textContent = keyPackage ? 'Ready' : 'Not generated';
        fragmentStatus.className = keyPackage ? 'text-sm text-white' : 'text-sm text-yellow-400';
    }

    const modal = document.getElementById('recovery-shield-modal');
    const content = document.getElementById('recovery-shield-modal-content');

    if (modal && content) {
        // Show modal - use block, not flex (flex is on inner wrapper)
        modal.style.display = 'block';
        modal.offsetHeight; // Force reflow

        modal.classList.remove('opacity-0', 'hidden');
        content.classList.remove('scale-95', 'opacity-0', 'translate-y-4');
        content.classList.add('scale-100', 'opacity-100', 'translate-y-0');

        // Lock BODY scroll but modal itself is scrollable via CSS
        document.body.style.overflow = 'hidden';

        // Store mandatory state
        modal.dataset.mandatory = mandatory ? 'true' : 'false';

        // Scroll modal to top and focus password
        setTimeout(() => {
            modal.scrollTop = 0;
            const passwordInput = document.getElementById('shield-password');
            if (passwordInput) {
                passwordInput.focus();
            }
        }, 300);
    }
}

/**
 * Close the Recovery Shield modal
 */
function closeRecoveryShieldModal() {
    const modal = document.getElementById('recovery-shield-modal');
    const content = document.getElementById('recovery-shield-modal-content');

    // Check if mandatory
    if (modal?.dataset.mandatory === 'true') {
        const error = document.getElementById('shield-error');
        if (error) {
            error.textContent = 'You must download your Recovery Shield to continue.';
            error.classList.remove('hidden');
        }
        return;
    }

    if (modal && content) {
        content.classList.remove('scale-100', 'opacity-100', 'translate-y-0');
        content.classList.add('scale-95', 'opacity-0', 'translate-y-4');
        modal.classList.add('opacity-0');

        setTimeout(() => {
            modal.style.display = 'none';
            modal.classList.add('hidden');
            // Use proper scroll unlock function if available (from escrow-setup.js)
            if (typeof window.unlockScroll === 'function') {
                window.unlockScroll();
            } else {
                document.body.style.overflow = '';
                document.body.style.position = '';
                document.body.style.top = '';
                document.body.style.width = '';
            }
        }, 300);
    }

    // Clear inputs
    const passwordInput = document.getElementById('shield-password');
    const confirmInput = document.getElementById('shield-password-confirm');
    const errorDiv = document.getElementById('shield-error');

    if (passwordInput) passwordInput.value = '';
    if (confirmInput) confirmInput.value = '';
    if (errorDiv) errorDiv.classList.add('hidden');

    resetPasswordStrength();
}

/**
 * Toggle password visibility
 */
function togglePasswordVisibility(inputId, button) {
    const input = document.getElementById(inputId);
    if (!input) return;

    const isPassword = input.type === 'password';
    input.type = isPassword ? 'text' : 'password';

    // Update icon
    const icon = button.querySelector('.eye-icon');
    if (icon) {
        icon.innerHTML = isPassword
            ? '<path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/>'
            : '<path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/>';
    }
}

/**
 * Update password strength meter
 */
function updatePasswordStrength(password) {
    const bar = document.getElementById('password-strength-bar');
    const text = document.getElementById('password-strength-text');
    const downloadBtn = document.getElementById('download-shield-btn');

    if (!bar || !text) return;

    let strength = 0;
    let label = 'Too weak';
    let color = '#ef4444';

    if (password.length >= 8) strength += 25;
    if (password.length >= 12) strength += 15;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 20;
    if (/[0-9]/.test(password)) strength += 20;
    if (/[^a-zA-Z0-9]/.test(password)) strength += 20;

    if (strength >= 80) {
        label = 'Strong';
        color = '#22c55e';
    } else if (strength >= 60) {
        label = 'Good';
        color = '#D4AF37';
    } else if (strength >= 40) {
        label = 'Fair';
        color = '#eab308';
    }

    bar.style.width = `${strength}%`;
    bar.style.backgroundColor = color;
    text.textContent = label;
    text.style.color = color;

    // Update button state
    checkPasswordMatch();
}

/**
 * Reset password strength UI
 */
function resetPasswordStrength() {
    const bar = document.getElementById('password-strength-bar');
    const text = document.getElementById('password-strength-text');

    if (bar) {
        bar.style.width = '0%';
    }
    if (text) {
        text.textContent = 'Enter a strong password';
        text.style.color = '';
    }
}

/**
 * Check if passwords match
 */
function checkPasswordMatch() {
    const password = document.getElementById('shield-password')?.value || '';
    const confirm = document.getElementById('shield-password-confirm')?.value || '';
    const indicator = document.getElementById('password-match-indicator');
    const downloadBtn = document.getElementById('download-shield-btn');

    const matches = password.length >= 8 && password === confirm;

    if (indicator) {
        indicator.classList.toggle('hidden', !matches || confirm.length === 0);
    }

    if (downloadBtn) {
        downloadBtn.disabled = !matches;
    }
}

/**
 * Download the Recovery Shield file
 */
async function downloadRecoveryShield() {
    const password = document.getElementById('shield-password')?.value;
    const confirm = document.getElementById('shield-password-confirm')?.value;
    const errorDiv = document.getElementById('shield-error');
    const downloadBtn = document.getElementById('download-shield-btn');

    // Validate
    if (!password || password.length < 8) {
        showShieldError('Password must be at least 8 characters');
        return;
    }

    if (password !== confirm) {
        showShieldError('Passwords do not match');
        return;
    }

    // Get data from localStorage
    const seedPhrase = localStorage.getItem('monero_seed_phrase');
    const keyPackage = localStorage.getItem(`frost_dkg_${shieldEscrowId}_${shieldRole}_key_package`);
    const groupPubkey = localStorage.getItem(`frost_dkg_${shieldEscrowId}_${shieldRole}_group_pubkey`);
    const verifyingShare = localStorage.getItem(`frost_dkg_${shieldEscrowId}_${shieldRole}_verifying_share`);
    const multisigAddress = localStorage.getItem(`escrow_${shieldEscrowId}_address`) ||
                           document.getElementById('escrow-address')?.textContent?.trim();
    const spendKeyPub = localStorage.getItem('monero_spend_key_pub');

    // CRITICAL: Get the EXTRACTED secret share (what signing actually uses)
    // sign-action.js retrieves in this priority order
    const secretShare = localStorage.getItem(`frost_secret_share_${shieldEscrowId}_${shieldRole}`)
        || localStorage.getItem(`frost_secret_share_${shieldEscrowId}`)
        || localStorage.getItem(`spend_key_${shieldRole}`)
        || localStorage.getItem('spend_key');

    // CRITICAL: Get view key private (needed for transaction derivation)
    const viewKeyPriv = localStorage.getItem('monero_view_key_priv')
        || localStorage.getItem(`frost_dkg_${shieldEscrowId}_${shieldRole}_view_key_private`);

    // Get multisig view key (for balance monitoring after recovery)
    const multisigViewKey = localStorage.getItem(`frost_dkg_${shieldEscrowId}_${shieldRole}_view_key_private`);

    if (!seedPhrase) {
        showShieldError('Master Key not found. Please restore your wallet first.');
        return;
    }

    // Warn if secret share is missing (signing will fail after recovery)
    if (!secretShare && keyPackage) {
        console.warn('[SHIELD] Warning: key_package exists but secret_share not found. Recovery may not allow signing.');
    }

    // Show loading state
    if (downloadBtn) {
        downloadBtn.disabled = true;
        downloadBtn.innerHTML = `
            <svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
            </svg>
            Encrypting...
        `;
    }

    try {
        // Build shield payload (v1.1 - includes secret_share for signing)
        const shieldPayload = {
            wallet: {
                bip39_seed: seedPhrase,
                address: localStorage.getItem('monero_address') || '',
                spend_key_pub: spendKeyPub || '',
                view_key_priv: viewKeyPriv || ''  // CRITICAL for tx derivation
            },
            frost_dkg: {
                key_package: keyPackage || null,
                secret_share: secretShare || null,  // CRITICAL for signing!
                group_public_key: groupPubkey || null,
                verifying_share: verifyingShare || null,
                participant_index: shieldRole === 'buyer' ? 1 : shieldRole === 'vendor' ? 2 : 3
            },
            escrow: {
                escrow_id: shieldEscrowId,
                role: shieldRole,
                multisig_address: multisigAddress || null,
                multisig_view_key: multisigViewKey || null  // For balance monitoring
            },
            recovery_instructions: 'To recover via CLI: monero-wallet-cli --testnet --restore-from-seed'
        };

        // Encrypt with AES-256-GCM
        const plaintext = JSON.stringify(shieldPayload);
        const encrypted = await encryptShieldPayload(plaintext, password);

        // Build final file (v1.1.0 includes secret_share + view_key_priv)
        const shieldFile = {
            nexus_recovery_shield: true,
            version: '1.1.0',
            created_at: new Date().toISOString(),
            encryption: {
                algorithm: 'AES-256-GCM',
                kdf: 'PBKDF2-SHA256',
                iterations: 100000,
                salt: encrypted.salt,
                iv: encrypted.iv
            },
            payload_encrypted: encrypted.ciphertext,
            metadata_public: {
                escrow_id: shieldEscrowId,
                participant_role: shieldRole,
                multisig_address_preview: multisigAddress ? multisigAddress.substring(0, 8) + '...' + multisigAddress.slice(-4) : null,
                created_date: new Date().toISOString().split('T')[0]
            }
        };

        // Download
        const blob = new Blob([JSON.stringify(shieldFile, null, 2)], { type: 'application/json' });
        const shortId = shieldEscrowId.substring(0, 8);
        const timestamp = new Date().toISOString().split('T')[0].replace(/-/g, '');
        const filename = `nexus-shield-${shortId}-${timestamp}.json`;

        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Mark as downloaded in localStorage
        localStorage.setItem(`shield_downloaded_${shieldEscrowId}`, new Date().toISOString());

        // Update any shield status indicators on the page
        updateShieldStatusIndicators();

        // Show success toast
        showShieldToast('Recovery Shield downloaded successfully', 'success');

        // Close modal (even if mandatory, download is complete)
        const modal = document.getElementById('recovery-shield-modal');
        if (modal) modal.dataset.mandatory = 'false';
        closeRecoveryShieldModal();

        // SAFETY: Ensure scroll is unlocked even if modal close fails
        setTimeout(() => {
            document.body.style.overflow = '';
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.width = '';
        }, 500);

        // Dispatch event for other components
        window.dispatchEvent(new CustomEvent('shieldDownloaded', {
            detail: { escrowId: shieldEscrowId, timestamp: new Date().toISOString() }
        }));

    } catch (error) {
        console.error('Shield encryption error:', error);
        showShieldError('Failed to create Recovery Shield: ' + error.message);

        // Reset button
        if (downloadBtn) {
            downloadBtn.disabled = false;
            downloadBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/>
                </svg>
                Download Shield
            `;
        }
    }
}

/**
 * Encrypt shield payload using Web Crypto API
 */
async function encryptShieldPayload(plaintext, password) {
    // Generate random salt and IV
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));

    // Derive key from password
    const encoder = new TextEncoder();
    const passwordBuffer = encoder.encode(password);

    const keyMaterial = await crypto.subtle.importKey(
        'raw',
        passwordBuffer,
        'PBKDF2',
        false,
        ['deriveKey']
    );

    const key = await crypto.subtle.deriveKey(
        {
            name: 'PBKDF2',
            salt: salt,
            iterations: 100000,
            hash: 'SHA-256'
        },
        keyMaterial,
        { name: 'AES-GCM', length: 256 },
        false,
        ['encrypt']
    );

    // Encrypt
    const dataBuffer = encoder.encode(plaintext);
    const cipherBuffer = await crypto.subtle.encrypt(
        { name: 'AES-GCM', iv: iv },
        key,
        dataBuffer
    );

    return {
        salt: btoa(String.fromCharCode.apply(null, salt)),
        iv: btoa(String.fromCharCode.apply(null, iv)),
        ciphertext: btoa(String.fromCharCode.apply(null, new Uint8Array(cipherBuffer)))
    };
}

/**
 * Show error in modal
 */
function showShieldError(message) {
    const errorDiv = document.getElementById('shield-error');
    if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
    }
}

/**
 * Update shield status indicators across the page
 */
function updateShieldStatusIndicators() {
    // Find all shield status elements
    const indicators = document.querySelectorAll('[data-shield-status]');
    const escrowId = shieldEscrowId || document.body.dataset.escrowId;
    const downloadedAt = localStorage.getItem(`shield_downloaded_${escrowId}`);

    indicators.forEach(indicator => {
        if (downloadedAt) {
            indicator.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-green-400">
                    <path d="M20 6 9 17l-5-5"/>
                </svg>
                <span>Shield Secured</span>
            `;
            indicator.className = indicator.className.replace(/bg-yellow-\d+\/\d+|border-yellow-\d+\/\d+/g, '').trim();
            indicator.classList.add('bg-green-500/10', 'border-green-500/20', 'text-green-400');
        }
    });
}

/**
 * Show toast notification
 */
function showShieldToast(message, type = 'info') {
    if (typeof window.NexusToast !== 'undefined') {
        window.NexusToast.show(message, type);
        return;
    }

    // Fallback toast
    const colors = {
        success: 'bg-green-600',
        error: 'bg-red-600',
        info: 'bg-[#D4AF37]'
    };

    const toast = document.createElement('div');
    toast.className = `fixed bottom-8 right-8 px-6 py-3 rounded-lg text-white text-sm font-medium shadow-2xl z-[100] transition-all duration-300 transform translate-y-10 opacity-0 ${colors[type] || colors.info}`;
    toast.innerHTML = `<div class="flex items-center gap-2"><span>${message}</span></div>`;
    document.body.appendChild(toast);

    requestAnimationFrame(() => {
        toast.classList.remove('translate-y-10', 'opacity-0');
    });

    setTimeout(() => {
        toast.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
    }, 4000);
}

// Close on backdrop click
document.getElementById('recovery-shield-modal')?.addEventListener('click', function(e) {
    if (e.target === this) closeRecoveryShieldModal();
});

// Close on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('recovery-shield-modal');
        if (modal && modal.style.display === 'flex') {
            closeRecoveryShieldModal();
        }
    }
});

// Export functions
window.showRecoveryShieldModal = showRecoveryShieldModal;
window.closeRecoveryShieldModal = closeRecoveryShieldModal;
window.downloadRecoveryShield = downloadRecoveryShield;
window.updateShieldStatusIndicators = updateShieldStatusIndicators;
</script>
