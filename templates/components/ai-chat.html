{# AI Chat Widget - Aura Design #}
{# Floating chat button with expandable chat window #}

<!-- AI Chat Trigger Button -->
<button
    id="ai-chat-trigger"
    onclick="toggleAIChat()"
    class="fixed bottom-8 right-8 z-50 p-4 rounded-full bg-white/5 backdrop-blur-md border border-white/10 shadow-lg transition-all duration-300 hover:bg-white/10 hover:shadow-cyan-500/20 group">
    <div class="absolute inset-0 rounded-full border border-cyan-500/30 animate-pulse"></div>
    <i data-lucide="sparkles" class="w-6 h-6 text-white"></i>
</button>

<!-- AI Chat Window -->
<div id="ai-chat-window"
     class="fixed bottom-24 right-8 w-96 max-h-[600px] h-[70vh] z-50 flex-col rounded-2xl bg-[#0F1115]/80 backdrop-blur-xl border border-white/10 shadow-2xl overflow-hidden hidden">

    <!-- Header -->
    <div class="p-4 border-b border-white/5 flex items-center justify-between bg-white/5">
        <div class="flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-cyan-400 animate-pulse"></div>
            <span class="text-sm font-medium tracking-wide text-white">FROST MARKET AI Assistant</span>
        </div>
        <span class="text-[10px] text-gray-500 uppercase">Beta</span>
    </div>

    <!-- Messages Container -->
    <div id="ai-chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 hide-scrollbar">
        <!-- Welcome Message -->
        <div class="flex justify-start">
            <div class="max-w-[85%] p-3 rounded-2xl text-sm leading-relaxed bg-white/5 border border-white/5 text-gray-200 rounded-tl-none">
                Hello! I'm your FROST MARKET assistant. Looking for a specific product, service, or need help navigating the marketplace?
            </div>
        </div>
    </div>

    <!-- Input Area -->
    <div class="p-4 border-t border-white/5 bg-white/5">
        <form id="ai-chat-form" onsubmit="sendAIMessage(event)" class="relative">
            <input
                type="text"
                id="ai-chat-input"
                name="message"
                placeholder="Ask about products, vendors, escrow..."
                autocomplete="off"
                class="w-full bg-black/20 text-white placeholder-gray-500 text-sm rounded-xl py-3 px-4 pr-10 border border-white/5 focus:outline-none focus:border-cyan-500/50 transition-colors"
            />
            <button
                type="submit"
                id="ai-chat-send"
                class="absolute right-2 top-1/2 transform -translate-y-1/2 p-1.5 rounded-lg text-gray-400 hover:text-white transition-colors">
                <i data-lucide="send" class="w-5 h-5"></i>
            </button>
        </form>
    </div>
</div>

<script>
let aiChatOpen = false;

function toggleAIChat() {
    const chatWindow = document.getElementById('ai-chat-window');
    const trigger = document.getElementById('ai-chat-trigger');

    aiChatOpen = !aiChatOpen;

    if (aiChatOpen) {
        chatWindow.classList.remove('hidden');
        chatWindow.classList.add('flex');
        trigger.classList.add('rotate-45');
        document.getElementById('ai-chat-input').focus();
    } else {
        chatWindow.classList.add('hidden');
        chatWindow.classList.remove('flex');
        trigger.classList.remove('rotate-45');
    }
}

function addMessage(role, text) {
    const container = document.getElementById('ai-chat-messages');
    const msgDiv = document.createElement('div');
    msgDiv.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;

    const bubble = document.createElement('div');
    bubble.className = `max-w-[85%] p-3 rounded-2xl text-sm leading-relaxed ${
        role === 'user'
            ? 'bg-gradient-to-br from-purple-600/40 to-cyan-600/40 border border-white/10 text-white rounded-tr-none'
            : 'bg-white/5 border border-white/5 text-gray-200 rounded-tl-none'
    }`;
    bubble.textContent = text;

    msgDiv.appendChild(bubble);
    container.appendChild(msgDiv);
    container.scrollTop = container.scrollHeight;
}

function showTypingIndicator() {
    const container = document.getElementById('ai-chat-messages');
    const typingDiv = document.createElement('div');
    typingDiv.id = 'typing-indicator';
    typingDiv.className = 'flex justify-start';
    typingDiv.innerHTML = `
        <div class="bg-white/5 border border-white/5 p-3 rounded-2xl rounded-tl-none flex gap-1 items-center">
            <div class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></div>
            <div class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
            <div class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
        </div>
    `;
    container.appendChild(typingDiv);
    container.scrollTop = container.scrollHeight;
}

function removeTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) indicator.remove();
}

async function sendAIMessage(event) {
    event.preventDefault();

    const input = document.getElementById('ai-chat-input');
    const message = input.value.trim();

    if (!message) return;

    // Add user message
    addMessage('user', message);
    input.value = '';

    // Show typing indicator
    showTypingIndicator();

    try {
        // Send to backend AI endpoint
        const response = await fetch('/api/ai/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ message })
        });

        removeTypingIndicator();

        if (response.ok) {
            const data = await response.json();
            addMessage('model', data.response || data.message || 'I understand. How can I help further?');
        } else {
            // Fallback response if endpoint not available
            addMessage('model', getLocalResponse(message));
        }
    } catch (error) {
        removeTypingIndicator();
        // Offline fallback
        addMessage('model', getLocalResponse(message));
    }
}

// Local fallback responses when API not available
function getLocalResponse(message) {
    const msg = message.toLowerCase();

    if (msg.includes('escrow') || msg.includes('multisig')) {
        return 'Our escrow system uses 2-of-3 multisig for maximum security. Funds are only released when both buyer and seller (or arbiter) agree. Check your order page for escrow status.';
    }
    if (msg.includes('price') || msg.includes('xmr') || msg.includes('monero')) {
        return 'All prices are in XMR (Monero). You can filter by price range using the Filter button. Current rates are fetched from decentralized exchanges.';
    }
    if (msg.includes('vendor') || msg.includes('seller')) {
        return 'Vendors are verified through our reputation system. Look for the star rating and review count on each listing. You can also filter by specific vendors.';
    }
    if (msg.includes('shipping') || msg.includes('delivery')) {
        return 'Shipping methods vary by vendor. Check the listing details for shipping options. Never share your real address - use secure drop points when possible.';
    }
    if (msg.includes('help') || msg.includes('how')) {
        return 'I can help you with: finding products, understanding escrow, vendor info, and marketplace navigation. What would you like to know?';
    }

    return 'I\'m here to help you navigate FROST MARKET. You can ask about products, escrow security, vendors, or how to use the marketplace safely.';
}
</script>
