{% extends "base-industrial.html" %}

{% block title %}Order #{{ order.id | truncate(length=8, end="") }} — FROST MARKET{% endblock %}

{% block content %}
<div class="order-detail-interface">
    <div class="container-industrial">

        {# ===== BACK LINK ===== #}
        <a href="/orders" class="order-detail-back">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"/>
            </svg>
            Back to Orders
        </a>

        <div class="order-detail-layout">
            {# ===== MAIN CONTENT ===== #}
            <div class="order-detail-main">

                {# ===== ORDER HEADER ===== #}
                <div class="order-detail-card" style="animation-delay: 0ms;">
                    <div class="order-header">
                        <div class="order-header__info">
                            <h1 class="order-header__title">
                                Order <span class="text-gold">#{{ order.id | truncate(length=8, end="") | upper }}</span>
                            </h1>
                            <p class="order-header__date">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                                    <line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/>
                                    <line x1="3" x2="21" y1="10" y2="10"/>
                                </svg>
                                {{ order.created_at | date(format="%Y-%m-%d %H:%M UTC") }}
                            </p>
                        </div>

                        {# Status Badge #}
                        {% if order.status == "pending" %}
                        <span class="order-status-badge status--pending">Pending</span>
                        {% elif order.status == "funded" %}
                        <span class="order-status-badge status--funded">Funded</span>
                        {% elif order.status == "shipped" %}
                        <span class="order-status-badge status--shipped">Shipped</span>
                        {% elif order.status == "releasing" %}
                        <span class="order-status-badge status--releasing">Confirming</span>
                        {% elif order.status == "completed" %}
                        <span class="order-status-badge status--completed">Completed</span>
                        {% elif order.status == "cancelled" %}
                        <span class="order-status-badge status--cancelled">Cancelled</span>
                        {% elif order.status == "disputed" %}
                        <span class="order-status-badge status--disputed">Disputed</span>
                        {% elif order.status == "refunded" %}
                        <span class="order-status-badge status--refunded">Refunded</span>
                        {% else %}
                        <span class="order-status-badge">{{ order.status | upper }}</span>
                        {% endif %}
                    </div>

                    {# Order Details Grid #}
                    <div class="order-details-grid">
                        <div class="order-detail-field">
                            <span class="order-detail-field__label">Listing</span>
                            <a href="/listings/{{ order.listing_id }}" class="order-detail-field__value order-detail-field__value--link">
                                {{ order.listing_title }}
                            </a>
                        </div>
                        <div class="order-detail-field">
                            <span class="order-detail-field__label">Quantity</span>
                            <span class="order-detail-field__value">{{ order.quantity }} unit(s)</span>
                        </div>
                        <div class="order-detail-field">
                            <span class="order-detail-field__label">Unit Price</span>
                            <span class="order-detail-field__value order-detail-field__value--mono">{{ order.unit_price_xmr }} XMR</span>
                        </div>
                        <div class="order-detail-field">
                            <span class="order-detail-field__label">Total Amount</span>
                            <span class="order-detail-field__value order-detail-field__value--gold order-detail-field__value--large">{{ order.total_price_xmr }} XMR</span>
                        </div>

                        {% if role == "buyer" %}
                        <div class="order-detail-field">
                            <span class="order-detail-field__label">Vendor</span>
                            <span class="order-detail-field__value">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--nexus-gold)" stroke-width="2">
                                    <path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/>
                                    <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/>
                                    <path d="M2 7h20"/>
                                </svg>
                                {{ order.vendor_username }}
                            </span>
                        </div>
                        {% elif role == "vendor" %}
                        <div class="order-detail-field">
                            <span class="order-detail-field__label">Buyer</span>
                            <span class="order-detail-field__value">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 1 0-16 0"/>
                                </svg>
                                {{ order.buyer_username }}
                            </span>
                        </div>
                        {% endif %}

                        {% if order.escrow_id %}
                        <div class="order-detail-field">
                            <span class="order-detail-field__label">Escrow</span>
                            <a href="/escrow/{{ order.escrow_id }}" class="order-detail-field__value order-detail-field__value--link">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/>
                                </svg>
                                View Details
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {# ==================== EMBEDDED SIGNING UI ==================== #}
                {% if order.escrow_id and escrow %}

                {# Define signing state variables for PKI-based Round-Robin flow #}
                {% set vendor_has_signed = escrow.partial_tx or escrow.vendor_partial_key_image %}
                {% set buyer_has_signed = escrow.buyer_partial_key_image %}
                {% set signer1_done = vendor_has_signed %}
                {% set signer2_done = escrow.completed_clsag %}

                {# Signature Progress Indicator #}
                {% if escrow.status == "funded" or escrow.status == "signing_initiated" or escrow.status == "ready_to_broadcast" %}
                <div class="signing-progress-card" style="animation-delay: 50ms;">
                    <div class="signing-progress__header">
                        <h3 class="signing-progress__title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--nexus-gold)" stroke-width="2">
                                <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                            </svg>
                            Round-Robin Signatures
                        </h3>
                        <span class="signing-progress__count">
                            {% if signer2_done %}2/2{% elif signer1_done %}1/2{% else %}0/2{% endif %}
                        </span>
                    </div>

                    {# Progress Bar #}
                    <div class="signing-progress__bar">
                        <div class="signing-progress__fill {% if signer2_done %}signing-progress__fill--complete{% elif signer1_done %}signing-progress__fill--half{% endif %}"></div>
                    </div>

                    {# Signers List #}
                    <div class="signing-progress__signers">
                        {# Signer 1 (Vendor) #}
                        <div class="signer-item {% if signer1_done %}signer-item--done{% endif %}">
                            <div class="signer-item__left">
                                {% if signer1_done %}
                                <div class="signer-item__icon signer-item__icon--done">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                </div>
                                <span class="signer-item__label">Signer 1 <span class="text-gold">(Vendor)</span></span>
                                {% else %}
                                <div class="signer-item__icon">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10" stroke-dasharray="4 4"/>
                                    </svg>
                                </div>
                                <span class="signer-item__label signer-item__label--pending">Signer 1 (Vendor)</span>
                                {% endif %}
                            </div>
                            <span class="signer-item__status {% if signer1_done %}signer-item__status--signed{% endif %}">
                                {% if signer1_done %}Signed{% else %}Awaiting{% endif %}
                            </span>
                        </div>

                        {# Signer 2 (Buyer) #}
                        <div class="signer-item {% if signer2_done %}signer-item--done{% elif signer1_done %}signer-item--active{% endif %}">
                            <div class="signer-item__left">
                                {% if signer2_done %}
                                <div class="signer-item__icon signer-item__icon--done">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                </div>
                                <span class="signer-item__label">Signer 2 <span class="text-gold">(Buyer)</span></span>
                                {% elif signer1_done %}
                                <div class="signer-item__icon signer-item__icon--waiting">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                                    </svg>
                                </div>
                                <span class="signer-item__label signer-item__label--active">Signer 2 (Buyer) — Your Turn!</span>
                                {% else %}
                                <div class="signer-item__icon">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10" stroke-dasharray="4 4"/>
                                    </svg>
                                </div>
                                <span class="signer-item__label signer-item__label--pending">Signer 2 (Buyer)</span>
                                {% endif %}
                            </div>
                            <span class="signer-item__status {% if signer2_done %}signer-item__status--signed{% elif signer1_done %}signer-item__status--waiting{% endif %}">
                                {% if signer2_done %}Signed{% elif signer1_done %}Awaiting{% else %}Pending{% endif %}
                            </span>
                        </div>
                    </div>

                    {% if escrow.completed_clsag %}
                    <div class="signing-progress__complete">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        All signatures collected! Ready to broadcast.
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {# Co-Signer Notification Banner #}
                {% if vendor_has_signed and not signer2_done and not buyer_has_signed %}
                {% if role == "buyer" %}
                <div class="cosign-notification cosign-notification--buyer" style="animation-delay: 75ms;">
                    <div class="cosign-notification__icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                            <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
                        </svg>
                    </div>
                    <div class="cosign-notification__content">
                        <h3 class="cosign-notification__title">Vendor Has Signed!</h3>
                        <p class="cosign-notification__text">
                            The vendor has marked the order as shipped. Complete the signature to release funds.
                        </p>
                        <button onclick="showSignActionModal('{{ escrow.id }}', 'cosign', '{{ escrow.amount_xmr }}')" class="btn-gold btn-shimmer cosign-notification__btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                            </svg>
                            Complete Signature Now
                        </button>
                    </div>
                </div>
                {% elif buyer_has_signed and not escrow.completed_clsag and not vendor_has_signed and role == "vendor" %}
                <div class="cosign-notification cosign-notification--vendor" style="animation-delay: 75ms;">
                    <div class="cosign-notification__icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/>
                            <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/>
                        </svg>
                    </div>
                    <div class="cosign-notification__content">
                        <h3 class="cosign-notification__title">Buyer Has Signed!</h3>
                        <p class="cosign-notification__text">
                            The buyer has initiated the release. Complete the signature to receive your funds.
                        </p>
                        <button onclick="showSignActionModal('{{ escrow.id }}', 'cosign', '{{ escrow.amount_xmr }}')" class="btn-gold btn-shimmer cosign-notification__btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/>
                            </svg>
                            Complete Signature Now
                        </button>
                    </div>
                </div>
                {% endif %}
                {% endif %}

                {# Ready to Broadcast Section #}
                {% if escrow.status == 'ready_to_broadcast' %}
                <div class="broadcast-ready-card" style="animation-delay: 100ms;">
                    <h3 class="broadcast-ready__title">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--nexus-green)" stroke-width="2">
                            <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                        </svg>
                        Ready to Broadcast
                    </h3>
                    <div class="broadcast-ready__status">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        2-of-3 signatures collected! Transaction is ready to broadcast.
                    </div>
                    <button id="broadcast-btn" onclick="showConfirmBroadcastModal('{{ escrow.id }}', '{{ escrow.amount_xmr }}', '{{ vendor_wallet_address | default(value='') }}')" class="btn-gold btn-shimmer broadcast-ready__btn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
                        </svg>
                        Broadcast Transaction
                    </button>
                    <div id="broadcast-status" class="mt-4 hidden"></div>
                </div>
                {% endif %}

                {% endif %}
                {# ==================== END SIGNING UI ==================== #}

                {# ===== DELIVERY ADDRESS (Vendor Only) ===== #}
                {% if role == "vendor" %}
                <div class="order-detail-card" style="animation-delay: 100ms;">
                    <h2 class="order-card-title">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--nexus-gold)" stroke-width="2">
                            <path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                        Delivery Address <span class="text-muted">(Confidential)</span>
                    </h2>

                    {% if order.shipping_address %}
                    <div class="shipping-address-box">
                        <pre class="shipping-address-box__content">{{ order.shipping_address }}</pre>

                        {% if order.shipping_notes %}
                        <div class="shipping-address-box__notes">
                            <span class="shipping-address-box__notes-label">Delivery Instructions</span>
                            <p class="shipping-address-box__notes-text">{{ order.shipping_notes }}</p>
                        </div>
                        {% endif %}

                        <div class="shipping-address-box__warning">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect width="18" height="11" x="3" y="11" rx="2" ry="2"/>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                            </svg>
                            This address is encrypted and only visible to you and the buyer.
                        </div>
                    </div>
                    {% else %}
                    <div class="shipping-address-empty">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/>
                            <line x1="12" x2="12.01" y1="16" y2="16"/>
                        </svg>
                        No shipping address provided (digital product or legacy order)
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {# ===== SHIPPING STATUS ===== #}
                {% if order.status == "shipped" or order.status == "completed" %}
                <div class="shipping-status-card" style="animation-delay: 125ms;">
                    <div class="shipping-status__icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"/>
                            <path d="M15 18H9"/><path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"/>
                            <circle cx="17" cy="18" r="2"/><circle cx="7" cy="18" r="2"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="shipping-status__title">Order Shipped</h3>
                        <p class="shipping-status__text">
                            Vendor marked as shipped on {{ order.updated_at | date(format="%Y-%m-%d %H:%M") }}
                        </p>
                    </div>
                </div>
                {% endif %}

                {# ===== LEAVE A REVIEW (Completed Orders - Buyer Only) ===== #}
                {% if order.status == "completed" and role == "buyer" %}
                <div class="review-prompt-card" style="animation-delay: 135ms;">
                    <div class="review-prompt__icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--nexus-gold)" stroke-width="1.5">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                        </svg>
                    </div>
                    <div class="review-prompt__content">
                        <h3 class="review-prompt__title">Rate Your Experience</h3>
                        <p class="review-prompt__text">
                            Your transaction is complete! Help other buyers by leaving a cryptographically-signed review for this vendor.
                        </p>
                        {# Use broadcast_tx_hash, funding_tx_hash, or escrow_id as txid fallback #}
                        {% set review_txid = escrow.broadcast_tx_hash | default(value=escrow.funding_tx_hash) | default(value=order.escrow_id) %}
                        <a href="/review/submit?vendor_id={{ order.vendor_id }}&txid={{ review_txid }}&escrow_id={{ order.escrow_id }}" class="btn-gold btn-shimmer review-prompt__btn">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                            Leave a Review
                        </a>
                    </div>
                </div>
                {% endif %}

                {# ===== ORDER TIMELINE ===== #}
                <div class="order-detail-card" style="animation-delay: 150ms;">
                    <h2 class="order-card-title">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--nexus-gold)" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                        </svg>
                        Order Timeline
                    </h2>

                    <div class="order-timeline" id="order-timeline">
                        {# Created #}
                        <div class="timeline-item timeline-item--done">
                            <div class="timeline-item__dot timeline-item__dot--done"></div>
                            <div class="timeline-item__content">
                                <h3 class="timeline-item__title">Order Created</h3>
                                <p class="timeline-item__date">{{ order.created_at | date(format="%Y-%m-%d %H:%M") }}</p>
                                <p class="timeline-item__desc">Order placed successfully</p>
                            </div>
                        </div>

                        {# Funded #}
                        <div class="timeline-item {% if order.status == 'funded' or order.status == 'shipped' or order.status == 'completed' %}timeline-item--done{% elif order.status == 'pending' %}timeline-item--active{% endif %}">
                            <div class="timeline-item__dot {% if order.status == 'funded' or order.status == 'shipped' or order.status == 'completed' %}timeline-item__dot--done{% elif order.status == 'pending' %}timeline-item__dot--active{% endif %}"></div>
                            <div class="timeline-item__content">
                                <h3 class="timeline-item__title">Escrow Funded</h3>
                                {% if order.funded_at %}
                                <p class="timeline-item__date">{{ order.funded_at | date(format="%Y-%m-%d %H:%M") }}</p>
                                <p class="timeline-item__desc">Buyer funded the escrow</p>
                                {% else %}
                                <p class="timeline-item__desc timeline-item__desc--pending">Awaiting buyer to fund escrow</p>
                                {% endif %}
                            </div>
                        </div>

                        {# Shipped #}
                        <div class="timeline-item {% if order.status == 'shipped' or order.status == 'completed' %}timeline-item--done{% elif order.status == 'funded' %}timeline-item--active{% endif %}">
                            <div class="timeline-item__dot {% if order.status == 'shipped' or order.status == 'completed' %}timeline-item__dot--done{% elif order.status == 'funded' %}timeline-item__dot--active{% endif %}"></div>
                            <div class="timeline-item__content">
                                <h3 class="timeline-item__title">Order Shipped</h3>
                                {% if order.shipped_at %}
                                <p class="timeline-item__date">{{ order.shipped_at | date(format="%Y-%m-%d %H:%M") }}</p>
                                <p class="timeline-item__desc">Vendor shipped the order</p>
                                {% else %}
                                <p class="timeline-item__desc timeline-item__desc--pending">Awaiting vendor to ship</p>
                                {% endif %}
                            </div>
                        </div>

                        {# Completed #}
                        <div class="timeline-item {% if order.status == 'completed' %}timeline-item--done{% elif order.status == 'shipped' %}timeline-item--active{% endif %}">
                            <div class="timeline-item__dot {% if order.status == 'completed' %}timeline-item__dot--done{% elif order.status == 'shipped' %}timeline-item__dot--active{% endif %}"></div>
                            <div class="timeline-item__content">
                                <h3 class="timeline-item__title">Order Completed</h3>
                                {% if order.completed_at %}
                                <p class="timeline-item__date">{{ order.completed_at | date(format="%Y-%m-%d %H:%M") }}</p>
                                <p class="timeline-item__desc">Buyer confirmed receipt</p>
                                {% else %}
                                <p class="timeline-item__desc timeline-item__desc--pending">Awaiting buyer confirmation</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {# ===== ORDER CHAT ===== #}
                {% if (role == "buyer" or role == "vendor") and order.status != "cancelled" %}
                <div class="order-detail-card" style="animation-delay: 200ms;">
                    <div class="chat-header">
                        <h2 class="order-card-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--nexus-gold)" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                            </svg>
                            Chat with {% if role == "buyer" %}Vendor{% else %}Buyer{% endif %}
                        </h2>
                        <div class="chat-status">
                            <span class="chat-status__dot"></span>
                            Real-time
                        </div>
                    </div>

                    <div class="order-chat" id="order-chat">
                        <div class="order-chat-messages h-[400px] overflow-y-auto p-4 space-y-4 scroll-smooth custom-scrollbar">
                            <!-- Messages loaded by JS -->
                        </div>

                        <div class="order-chat-typing px-4 py-2 text-xs text-gray-500 italic hidden">
                            Typing...
                        </div>

                        <div class="chat-input-area">
                            <form class="chat-input-form" onsubmit="return false;">
                                <div class="chat-input-wrapper">
                                    <textarea id="chat-message-input"
                                        class="chat-input"
                                        placeholder="Type your message..."
                                        rows="1"
                                        maxlength="2000"></textarea>
                                    <div class="chat-input-counter">0 / 2000</div>
                                </div>
                                <button type="button" class="order-chat-send-btn chat-send-btn">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="22" x2="11" y1="2" y2="13"/>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            {# ===== SIDEBAR ===== #}
            <div class="order-detail-sidebar">
                <div class="sidebar-sticky">
                    {# Actions Card #}
                    <div class="order-detail-card sidebar-card" style="animation-delay: 250ms;">
                        <h2 class="order-card-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--nexus-gold)" stroke-width="2">
                                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                            </svg>
                            Actions
                        </h2>

                        <div id="action-result" class="mb-4"></div>
                        <div id="auto-pki-status" class="mb-4 hidden text-center"></div>

                        <div class="actions-list">
                            {# ===== VENDOR ACTIONS ===== #}
                            {% if role == "vendor" %}
                                {% if escrow and escrow.status == "funded" and not vendor_has_signed %}
                                <button onclick="showSignActionModal('{{ escrow.id }}', 'ship', '{{ escrow.amount_xmr }}')" class="btn-gold btn-shimmer btn-full">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="m7.5 4.27 9 5.15"/>
                                        <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/>
                                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"/>
                                    </svg>
                                    Mark as Shipped
                                </button>
                                <p class="action-hint">Sign with your wallet to ship order</p>

                                {# Mark Shipped Guidance #}
                                <details class="education-expandable education-expandable--ship" style="margin-top: 1rem;">
                                    <summary>When should I mark as shipped?</summary>
                                    <div class="education-expandable__content">
                                        <p>Mark as shipped when:</p>
                                        <ul>
                                            <li><strong>Physical items:</strong> After dropping off the package with a carrier</li>
                                            <li><strong>Digital goods:</strong> After delivering access codes or download links</li>
                                            <li><strong>Services:</strong> After completing the agreed work</li>
                                        </ul>
                                        <p class="education-warning">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/>
                                            </svg>
                                            Once you mark as shipped, the buyer can release payment or open a dispute.
                                        </p>
                                    </div>
                                </details>

                                {% elif escrow and escrow.signing_phase == "ready_for_initiation" %}
                                <button onclick="showSignActionModal('{{ escrow.id }}', 'ship', '{{ escrow.amount_xmr }}')" class="btn-gold btn-shimmer btn-full">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="m7.5 4.27 9 5.15"/>
                                        <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/>
                                    </svg>
                                    Mark as Shipped
                                </button>
                                <p class="action-hint">Ready - click to ship and create transaction</p>

                                {# Mark Shipped Guidance #}
                                <details class="education-expandable education-expandable--ship" style="margin-top: 1rem;">
                                    <summary>When should I mark as shipped?</summary>
                                    <div class="education-expandable__content">
                                        <p>Mark as shipped when:</p>
                                        <ul>
                                            <li><strong>Physical items:</strong> After dropping off the package with a carrier</li>
                                            <li><strong>Digital goods:</strong> After delivering access codes or download links</li>
                                            <li><strong>Services:</strong> After completing the agreed work</li>
                                        </ul>
                                        <p class="education-warning">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/>
                                            </svg>
                                            Once you mark as shipped, the buyer can release payment or open a dispute.
                                        </p>
                                    </div>
                                </details>

                                {% elif escrow and escrow.partial_tx and not escrow.completed_clsag %}
                                <div class="action-status action-status--success">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    Transaction initiated. Waiting for buyer to complete...
                                </div>
                                {% endif %}
                            {% endif %}

                            {# ===== BUYER ACTIONS ===== #}
                            {% if role == "buyer" %}
                                {% if escrow and escrow.status == "funded" and not vendor_has_signed %}
                                <div class="action-status action-status--waiting">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
                                    </svg>
                                    Waiting for Vendor
                                </div>
                                <p class="action-hint">Vendor must mark as shipped before you can release funds.</p>

                                {% elif escrow and escrow.partial_tx and not escrow.completed_clsag %}
                                <button onclick="showSignActionModal('{{ escrow.id }}', 'release', '{{ escrow.amount_xmr }}')" class="btn-gold btn-shimmer btn-full">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                        <polyline points="22 4 12 14.01 9 11.01"/>
                                    </svg>
                                    Confirm Receipt & Release Funds
                                </button>
                                <p class="action-hint">Vendor shipped. Sign to release funds.</p>

                                {# Education: What does Release Funds mean? #}
                                <details class="education-expandable education-expandable--escrow" style="margin-top: 1rem;">
                                    <summary>What does "Release Funds" mean?</summary>
                                    <div class="education-expandable__content">
                                        <p><strong>Only click after you've received and inspected your order.</strong></p>
                                        <ul>
                                            <li>This sends the escrowed XMR directly to the vendor's wallet</li>
                                            <li>Your browser will sign the transaction locally (your keys never leave)</li>
                                            <li>The action is <strong>irreversible</strong> once broadcast</li>
                                        </ul>
                                        <p>If there's any issue with your order, use "Open Dispute" instead.</p>
                                    </div>
                                </details>

                                {% elif escrow and escrow.completed_clsag and not escrow.tx_hash %}
                                <div class="action-status action-status--success">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"/>
                                    </svg>
                                    Signature complete. Broadcasting transaction...
                                </div>
                                {% endif %}
                            {% endif %}

                            {# ===== DISPUTE BUTTON ===== #}
                            {% if (role == "buyer" or role == "vendor") and escrow and (escrow.status == "funded" or order.status == "shipped") and not escrow.completed_clsag %}
                            <button id="open-dispute-modal-btn" class="open-dispute-modal-btn btn-outline-danger btn-full" data-order-id="{{ order.id }}">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                                    <line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/>
                                </svg>
                                Open Dispute
                            </button>

                            {# Education: When to open a dispute #}
                            <details class="education-expandable" style="margin-top: 0.75rem;">
                                <summary>When should I open a dispute?</summary>
                                <div class="education-expandable__content">
                                    <p>Open a dispute if:</p>
                                    <ul>
                                        <li>Order never arrived after reasonable time</li>
                                        <li>Product doesn't match description</li>
                                        <li>Package arrived damaged or incomplete</li>
                                        <li>Vendor is unresponsive to messages</li>
                                    </ul>
                                    <p>A neutral <strong>arbiter</strong> will review evidence from both sides and decide how to distribute the escrowed funds fairly.</p>
                                </div>
                            </details>
                            {% endif %}

                            {# ===== FUND ESCROW (Pending Buyer) ===== #}
                            {% if order.status == "pending" and role == "buyer" %}
                            <button id="fund-escrow-btn" class="btn-gold btn-shimmer btn-full">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/>
                                    <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/>
                                    <path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/>
                                </svg>
                                Fund Escrow ({{ order.total_price_xmr }} XMR)
                            </button>

                            {# Escrow Instructions (hidden until clicked) #}
                            <div id="escrow-instructions" class="hidden mt-6 space-y-4 animate-slide-down">
                                <div class="escrow-payment-box">
                                    <h3 class="escrow-payment-box__title">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--nexus-gold)" stroke-width="2">
                                            <rect width="5" height="5" x="3" y="3" rx="1"/>
                                            <rect width="5" height="5" x="16" y="3" rx="1"/>
                                            <rect width="5" height="5" x="3" y="16" rx="1"/>
                                            <path d="M21 16h-3a2 2 0 0 0-2 2v3"/>
                                            <path d="M21 21v.01"/><path d="M12 7v3a2 2 0 0 1-2 2H7"/>
                                            <path d="M3 12h.01"/><path d="M12 3h.01"/>
                                            <path d="M12 16v.01"/><path d="M16 12h1"/>
                                            <path d="M21 12v.01"/><path d="M12 21v-1"/>
                                        </svg>
                                        Escrow Payment
                                    </h3>

                                    <div class="escrow-qr-container">
                                        <div class="escrow-qr-wrapper">
                                            <canvas id="escrow-qr-code"></canvas>
                                        </div>
                                        <p class="escrow-qr-hint">Scan to pay</p>
                                    </div>

                                    <div class="escrow-address-section">
                                        <label class="escrow-address-label">Escrow Address</label>
                                        <div class="escrow-address-row">
                                            <div id="escrow-address" class="escrow-address-value">Initializing...</div>
                                            <button id="copy-address-btn" class="escrow-copy-btn">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <rect width="14" height="14" x="8" y="8" rx="2" ry="2"/>
                                                    <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </div>

                                    <div class="escrow-amount-section">
                                        <label class="escrow-amount-label">Amount to Send</label>
                                        <div class="escrow-amount-value">{{ order.total_price_xmr }} XMR</div>
                                    </div>

                                    <div class="escrow-fee-breakdown">
                                        <div class="escrow-fee-row">
                                            <span>Product Price</span>
                                            <span>{{ order.total_price_xmr }} XMR</span>
                                        </div>
                                        <div class="escrow-fee-row">
                                            <span>Network Fee (est.)</span>
                                            <span>~0.0001 XMR</span>
                                        </div>
                                        <div class="escrow-fee-row escrow-fee-row--total">
                                            <span>Vendor Receives</span>
                                            <span class="text-green">~{{ order.total_price_xmr }} - 0.0001 XMR</span>
                                        </div>
                                    </div>

                                    <div class="escrow-checklist">
                                        <p>✓ Send EXACTLY {{ order.total_price_xmr }} XMR</p>
                                        <p>✓ Funds secured in 2-of-3 multisig</p>
                                        <p>✓ Released only after confirmation</p>
                                    </div>

                                    <div id="payment-status" class="mt-4"></div>
                                </div>
                            </div>

                            <button class="btn-outline-danger btn-full mt-4"
                                hx-post="/api/orders/{{ order.id }}/cancel"
                                hx-target="#action-result"
                                hx-swap="innerHTML"
                                hx-confirm="Are you sure you want to cancel this order?">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/>
                                </svg>
                                Cancel Order
                            </button>
                            {% endif %}

                            {# View Escrow Link #}
                            {% if order.escrow_id %}
                            <a href="/escrow/{{ order.escrow_id }}" class="btn-outline btn-full">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/>
                                </svg>
                                View Escrow Details
                            </a>
                            {% endif %}
                        </div>
                    </div>

                    {# Help Card #}
                    <div class="order-detail-card sidebar-card" style="animation-delay: 300ms;">
                        <h2 class="order-card-title order-card-title--small">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
                                <path d="M12 17h.01"/>
                            </svg>
                            Need Help?
                        </h2>
                        <ul class="help-list">
                            {% if role == "buyer" %}
                            <li>Wait for the vendor to ship</li>
                            <li>Open a dispute if there's a problem</li>
                            <li>Contact support for assistance</li>
                            {% elif role == "vendor" %}
                            <li>Mark the order as shipped when ready</li>
                            <li>Open a dispute if there's a problem</li>
                            <li>Contact support for assistance</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        {# Hidden Data Attributes #}
        <div id="order-data" data-order-id="{{ order.id }}"></div>
        <div id="order-page-data"
            data-order-id="{{ order.id }}"
            data-escrow-id="{{ order.escrow_id | default(value='') }}"
            data-escrow-status="{{ escrow.status | default(value='') }}"
            data-total-price="{{ order.total_price_xmr }}"
            data-escrow-amount="{{ escrow.amount_xmr | default(value='0') }}"
            data-vendor-wallet-address="{{ vendor_wallet_address | default(value='') }}"
            data-role="{{ role }}"
            data-user-id="{{ user_id }}"
            data-username="{{ username }}"
            data-order-status="{{ order.status }}"
            style="display: none;"></div>
    </div>
</div>

{# Modals #}
{% include "modals/ship-with-payout.html" %}
{% include "modals/confirm-broadcast.html" %}

{# LocalStorage Sync for Escrow Role + Escrow Data Injection #}
<script>
(function syncEscrowRoleAndData() {
    const role = '{{ role }}';
    if (role) {
        localStorage.setItem('escrow_role', role.toLowerCase());
        window.userRole = role.toLowerCase();
        console.log('[OrderPage] Synced escrow_role:', role.toLowerCase());
    }

    {% if escrow %}
    window.currentEscrowId = '{{ escrow.id }}';
    window.currentEscrowStatus = '{{ escrow.status }}';
    window.escrowData = {
        id: '{{ escrow.id }}',
        status: '{{ escrow.status }}',
        signing_phase: '{{ escrow.signing_phase | default(value="awaiting_initiation") }}',
        amount_xmr: '{{ escrow.amount_xmr }}',
        one_time_pubkey: '{{ escrow.funding_output_pubkey | default(value="") }}',
        funding_output_pubkey: '{{ escrow.funding_output_pubkey | default(value="") }}',
        funding_tx_pubkey: '{{ escrow.funding_tx_pubkey | default(value="") }}',
        multisig_view_key: '{{ escrow.multisig_view_key | default(value="") }}',
        funding_output_index: {{ escrow.funding_output_index | default(value=0) }},
        vendor_partial_key_image: {% if escrow.vendor_partial_key_image %}'{{ escrow.vendor_partial_key_image }}'{% else %}null{% endif %},
        buyer_partial_key_image: {% if escrow.buyer_partial_key_image %}'{{ escrow.buyer_partial_key_image }}'{% else %}null{% endif %},
        aggregated_key_image: {% if escrow.aggregated_key_image %}'{{ escrow.aggregated_key_image }}'{% else %}null{% endif %},
        partial_tx: {% if escrow.partial_tx %}'{{ escrow.partial_tx }}'{% else %}null{% endif %},
        completed_clsag: {% if escrow.completed_clsag %}true{% else %}false{% endif %}
    };
    console.log('[OrderPage] Injected escrowData:', window.escrowData);
    {% else %}
    window.currentEscrowId = null;
    window.currentEscrowStatus = null;
    window.escrowData = null;
    {% endif %}
})();
</script>

{# Scripts #}
<script src="/static/js/qrcode.min.js"></script>
<script src="/static/js/fund-escrow.js"></script>
<script src="/static/js/order-actions.js"></script>
<script src="/static/js/dispute-system.js"></script>
<script src="/static/js/order-chat.js"></script>
<script src="/static/js/error-codes.js?v=1"></script>
<script src="/static/js/recovery-file.js?v=1"></script>
<script src="/static/js/auto-pki.js?v=3"></script>
<script src="/static/js/sign-action.js?v=12"></script>
<script src="/static/js/ship-payout.js?v=2"></script>
<script src="/static/js/order-page-init.js?v=2"></script>
{% endblock %}
