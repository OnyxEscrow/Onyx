{% extends "base-industrial.html" %}

{% block title %}Vendor Profile â€” FROST MARKET{% endblock %}

{% block content %}
<div class="vendor-profile-interface">
    <div class="container-industrial">

        {# ===== VENDOR HEADER ===== #}
        <div class="vendor-profile-header">
            <div class="vendor-profile-avatar">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
            </div>

            <div class="vendor-profile-info">
                <div class="vendor-profile-name-row">
                    <h1 class="h1-massive">
                        Vendor <span class="text-gold">#{{ vendor_id | truncate(length=8, end="") }}</span>
                    </h1>
                    {% if is_vendor %}
                    <span class="vendor-you-badge">This is you</span>
                    {% endif %}
                </div>

                <div class="vendor-profile-meta">
                    {# Rating #}
                    <div class="vendor-rating">
                        <div class="vendor-stars">
                            {% for i in range(end=5) %}
                            {% if i < reputation.stats.average_rating | round %}
                            <svg class="star star--filled" width="18" height="18" viewBox="0 0 24 24">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                            {% else %}
                            <svg class="star" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                            </svg>
                            {% endif %}
                            {% endfor %}
                        </div>
                        <span class="vendor-rating-value">{{ reputation.stats.average_rating | round(precision=1) }}</span>
                        <span class="vendor-rating-count">({{ reputation.stats.total_reviews }} reviews)</span>
                    </div>

                    {# Member Since #}
                    <div class="vendor-member-since">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                            <line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/>
                            <line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>
                        <span>Member since {{ reputation.generated_at | date(format="%Y") }}</span>
                    </div>
                </div>
            </div>

            <div class="vendor-profile-actions">
                {% if is_vendor %}
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button type="button" data-action="open-export-modal" class="btn-gold-outline btn-shimmer">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                        <polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/>
                    </svg>
                    Export to IPFS
                </button>
                {% endif %}

                <button type="button" data-action="open-verify-modal" class="btn-secondary-outline">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/>
                        <polyline points="9 12 11 14 15 10"/>
                    </svg>
                    Verify External
                </button>

                {% if not is_vendor and logged_in %}
                <a href="/messages/{{ vendor_id }}" class="btn-gold-outline">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                    Contact Vendor
                </a>
                {% endif %}

                <div id="verification-status" class="verification-status">
                    <div class="verification-dot" id="status-dot"></div>
                    <span id="status-text">Verifying signatures...</span>
                </div>
            </div>
        </div>

        {# ===== REVIEWS SECTION ===== #}
        <div class="reviews-section">
            <h2 class="reviews-section__title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--nexus-gold)" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                Customer Reviews
            </h2>

            {% if reputation.reviews | length > 0 %}
            <div class="reviews-list">
                {% for review in reputation.reviews %}
                <div class="review-card" data-review-signature="{{ review.signature }}" data-review-json='{{ review | json_encode | safe }}'>
                    <div class="review-card__header">
                        <div class="review-rating-row">
                            <div class="review-stars">
                                {% for i in range(end=5) %}
                                {% if i < review.rating %}
                                <svg class="star star--filled" width="14" height="14" viewBox="0 0 24 24">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                </svg>
                                {% else %}
                                <svg class="star" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                </svg>
                                {% endif %}
                                {% endfor %}
                            </div>
                            <span class="review-date">{{ review.timestamp | date(format="%b %d, %Y") }}</span>
                        </div>

                        <div class="review-badge" id="badge-{{ loop.index }}">
                            <svg class="spin" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                            </svg>
                            Verifying...
                        </div>
                    </div>

                    {% if review.comment %}
                    <p class="review-card__comment">{{ review.comment }}</p>
                    {% endif %}

                    <div class="review-card__footer">
                        <div class="review-meta">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 0 1 9-9"/>
                            </svg>
                            <span>TXID: {{ review.txid | truncate(length=16, end="...") }}</span>
                        </div>
                        <div class="review-meta" title="Ed25519 Signature">
                            <span>SIG: {{ review.signature | truncate(length=12, end="...") }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            {# Empty State #}
            <div class="reviews-empty">
                <div class="reviews-empty__icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                    </svg>
                </div>
                <h3 class="reviews-empty__title">No Reviews Yet</h3>
                <p class="reviews-empty__text">This vendor hasn't received any reviews yet.</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{# Hidden data for WASM verification #}
<script id="reputation-data" type="application/json">
    {{ reputation_json | safe }}
</script>

<script type="module" src="/static/js/reputation-verify.js"></script>
<script src="/static/js/reputation-export.js"></script>
<script src="/static/js/reputation-import.js"></script>

{# Export Modal (only for vendor's own profile) #}
{% if is_vendor %}
{% include "reputation/partials/_export_modal.html" %}
{% endif %}

{# Verify Modal (available to all users) #}
{% include "reputation/partials/_import_modal.html" %}
{% endblock %}
