{% extends "base-industrial.html" %}

{% block title %}Wallet — FROST MARKET{% endblock %}

{% block content %}
<div class="wallet-interface">
    <div class="container-industrial" style="max-width: 900px;">

        {# ===== HEADER ===== #}
        <div class="wallet-header">
            <div class="wallet-header__icon">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M19 7V4a1 1 0 0 0-1-1H5a2 2 0 0 0 0 4h15a1 1 0 0 1 1 1v4h-3a2 2 0 0 0 0 4h3a1 1 0 0 0 1-1v-2a1 1 0 0 0-1-1"/>
                    <path d="M3 5v14a2 2 0 0 0 2 2h15a1 1 0 0 0 1-1v-4"/>
                </svg>
            </div>
            <h1 class="h1-massive">
                Your <span class="text-gold">WASM Wallet</span>
            </h1>
            <p class="wallet-header__subtitle">
                Non-custodial wallet for escrow transactions. Your keys are generated and stored locally in your browser — FROST MARKET never has access to them.
            </p>
        </div>

        {# ===== WALLET STATUS CARD ===== #}
        <div id="wallet-status" class="wallet-status-card">
            {% if has_wasm_wallet %}
            {# Wallet Exists #}
            <div class="wallet-active">
                <div class="wallet-active__badge">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                    Wallet Active
                </div>

                <div class="wallet-address-box">
                    <label class="wallet-address-label">Your Address</label>
                    <div class="wallet-address-row">
                        <code id="wallet-address" class="wallet-address-value">{{ wallet_address }}</code>
                        <button onclick="copyAddress()" class="wallet-copy-btn" title="Copy">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="wallet-actions-grid">
                    <button onclick="showBackupModal()" class="wallet-action-btn wallet-action-btn--yellow">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                        </svg>
                        Backup Seed
                    </button>
                    <button onclick="showKeysModal()" class="wallet-action-btn wallet-action-btn--purple">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        View Keys
                    </button>
                    <a href="/escrows" class="wallet-action-btn wallet-action-btn--blue">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/>
                        </svg>
                        Go to Escrows
                    </a>
                </div>
            </div>

            {% else %}
            {# No Wallet - Setup Options #}
            <div class="wallet-setup">
                <div class="wallet-setup__badge">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                        <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                    </svg>
                    Wallet Not Set Up
                </div>

                <p class="wallet-setup__text">
                    You need a WASM wallet to participate in escrow transactions. Choose an option below to get started.
                </p>

                <div class="wallet-setup-options">
                    {# Generate New Wallet #}
                    <button onclick="generateNewWallet()" class="wallet-option-card wallet-option-card--green">
                        <div class="wallet-option-icon">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M12 3v18m9-9H3"/>
                            </svg>
                        </div>
                        <h3 class="wallet-option-title">Generate New Wallet</h3>
                        <p class="wallet-option-desc">Create a fresh wallet with a new seed phrase. Make sure to backup your seed!</p>
                    </button>

                    {# Restore from Seed #}
                    <button onclick="showRestoreModal()" class="wallet-option-card wallet-option-card--purple">
                        <div class="wallet-option-icon">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                            </svg>
                        </div>
                        <h3 class="wallet-option-title">Restore from Seed</h3>
                        <p class="wallet-option-desc">Already have a wallet? Enter your 25-word seed phrase to restore it.</p>
                    </button>
                </div>
            </div>
            {% endif %}
        </div>

        {# ===== SECURITY NOTICE ===== #}
        <div class="wallet-security-card">
            <h3 class="wallet-security-title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--onyx-green)" stroke-width="2">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/>
                </svg>
                Security Information
            </h3>

            <div class="wallet-security-grid">
                <div class="wallet-security-item">
                    <div class="wallet-security-check wallet-security-check--green">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div>
                        <strong>Non-Custodial</strong>
                        <p>Your private keys never leave your browser. FROST MARKET cannot access or control your funds.</p>
                    </div>
                </div>

                <div class="wallet-security-item">
                    <div class="wallet-security-check wallet-security-check--green">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                    </div>
                    <div>
                        <strong>Client-Side WASM</strong>
                        <p>All cryptographic operations run locally using WebAssembly for maximum security.</p>
                    </div>
                </div>

                <div class="wallet-security-item">
                    <div class="wallet-security-check wallet-security-check--yellow">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                        </svg>
                    </div>
                    <div>
                        <strong>Backup Your Seed</strong>
                        <p>If you lose your seed phrase, you lose access to your funds permanently.</p>
                    </div>
                </div>

                <div class="wallet-security-item">
                    <div class="wallet-security-check wallet-security-check--blue">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                        </svg>
                    </div>
                    <div>
                        <strong>2-of-3 Multisig</strong>
                        <p>Escrows use multisig requiring 2 signatures from buyer, vendor, or arbiter.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# ===== RESTORE WALLET MODAL ===== #}
<div id="restore-modal" class="wallet-modal" style="display: none;">
    <div class="wallet-modal__backdrop" onclick="hideRestoreModal()"></div>
    <div class="wallet-modal__content">
        <div class="wallet-modal__header">
            <h3 class="wallet-modal__title">Restore Wallet</h3>
            <button onclick="hideRestoreModal()" class="wallet-modal__close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>

        <form id="restore-form" onsubmit="restoreWallet(event)">
            <div class="form-field">
                <label class="form-label">25-Word Seed Phrase</label>
                <textarea id="seed-input" rows="4" class="form-textarea"
                    placeholder="Enter your seed phrase, one word per space..."></textarea>
            </div>

            <div class="wallet-modal__actions">
                <button type="button" onclick="hideRestoreModal()" class="btn-outline">Cancel</button>
                <button type="submit" class="btn-gold btn-shimmer">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                    </svg>
                    Restore
                </button>
            </div>
        </form>
    </div>
</div>

{# ===== BACKUP SEED MODAL ===== #}
<div id="backup-modal" class="wallet-modal" style="display: none;">
    <div class="wallet-modal__backdrop" onclick="hideBackupModal()"></div>
    <div class="wallet-modal__content">
        <div class="wallet-modal__header">
            <h3 class="wallet-modal__title">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--onyx-gold)" stroke-width="2">
                    <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                Backup Your Seed
            </h3>
            <button onclick="hideBackupModal()" class="wallet-modal__close">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                </svg>
            </button>
        </div>

        <div class="wallet-warning-box">
            <strong>Warning:</strong> Never share your seed phrase with anyone. Store it securely offline. Anyone with your seed can steal your funds.
        </div>

        <div id="seed-display" class="wallet-seed-display">
            <p>Click "Reveal Seed" to show your seed phrase</p>
        </div>

        <div class="wallet-modal__actions">
            <button onclick="hideBackupModal()" class="btn-outline">Close</button>
            <button onclick="revealSeed()" class="btn-gold btn-shimmer">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                Reveal Seed
            </button>
        </div>
    </div>
</div>

<script type="module" src="/static/js/wasm-loader.js?v=20251228_v580_rebuild2"></script>
<script>
// Modal functions
function showRestoreModal() {
    document.getElementById('restore-modal').style.display = 'flex';
}
function hideRestoreModal() {
    document.getElementById('restore-modal').style.display = 'none';
}
function showBackupModal() {
    document.getElementById('backup-modal').style.display = 'flex';
}
function hideBackupModal() {
    document.getElementById('backup-modal').style.display = 'none';
    document.getElementById('seed-display').innerHTML = '<p>Click "Reveal Seed" to show your seed phrase</p>';
}
function showKeysModal() {
    alert('View Keys functionality - Coming soon');
}

// Copy address
function copyAddress() {
    const address = document.getElementById('wallet-address').textContent;
    navigator.clipboard.writeText(address).then(() => {
        alert('Address copied to clipboard!');
    });
}

// Generate new wallet
async function generateNewWallet() {
    try {
        // Wait for WASM to be ready
        if (!window.wasmReady) {
            await new Promise((resolve, reject) => {
                const timeout = setTimeout(() => reject(new Error('WASM load timeout')), 10000);
                window.addEventListener('wasmLoaded', () => {
                    clearTimeout(timeout);
                    resolve();
                }, { once: true });
                if (window.wasmReady) {
                    clearTimeout(timeout);
                    resolve();
                }
            });
        }

        const result = window.generateMoneroWallet();
        if (result.error) {
            alert('Error generating wallet: ' + result.error);
            return;
        }

        localStorage.setItem('onyx_wasm_wallet', JSON.stringify({
            address: result.address,
            seed: result.seed,
            view_key: result.view_key,
            spend_key: result.spend_key,
            created_at: new Date().toISOString()
        }));

        localStorage.setItem('monero_seed_phrase', result.seed);
        localStorage.setItem('monero_spend_key_priv', result.spend_key);
        localStorage.setItem('monero_view_key_priv', result.view_key);
        localStorage.setItem('monero_address', result.address);

        alert('Wallet generated! IMPORTANT: Please backup your seed phrase immediately.');
        showBackupModal();
        revealSeed();

        setTimeout(() => location.reload(), 100);

    } catch (err) {
        console.error('Wallet generation error:', err);
        alert('Failed to generate wallet: ' + err.message);
    }
}

// Restore wallet from seed
async function restoreWallet(event) {
    event.preventDefault();
    const seedInput = document.getElementById('seed-input').value.trim();

    if (!seedInput) {
        alert('Please enter your seed phrase');
        return;
    }

    const words = seedInput.split(/\s+/);
    if (words.length !== 25) {
        alert('Seed phrase must be exactly 25 words');
        return;
    }

    try {
        if (!window.wasmReady) {
            await new Promise((resolve, reject) => {
                const timeout = setTimeout(() => reject(new Error('WASM load timeout')), 10000);
                window.addEventListener('wasmLoaded', () => {
                    clearTimeout(timeout);
                    resolve();
                }, { once: true });
                if (window.wasmReady) {
                    clearTimeout(timeout);
                    resolve();
                }
            });
        }

        const result = window.restoreMoneroWallet(seedInput);
        if (result.error) {
            alert('Error restoring wallet: ' + result.error);
            return;
        }

        localStorage.setItem('onyx_wasm_wallet', JSON.stringify({
            address: result.address,
            seed: seedInput,
            view_key: result.view_key,
            spend_key: result.spend_key,
            restored_at: new Date().toISOString()
        }));

        localStorage.setItem('monero_seed_phrase', seedInput);
        localStorage.setItem('monero_spend_key_priv', result.spend_key);
        localStorage.setItem('monero_view_key_priv', result.view_key);
        localStorage.setItem('monero_address', result.address);

        alert('Wallet restored successfully!');
        location.reload();

    } catch (err) {
        console.error('Wallet restore error:', err);
        alert('Failed to restore wallet: ' + err.message);
    }
}

// Reveal seed phrase
function revealSeed() {
    const wallet = JSON.parse(localStorage.getItem('onyx_wasm_wallet') || '{}');
    if (wallet.seed) {
        document.getElementById('seed-display').innerHTML = `
            <div class="wallet-seed-grid">
                ${wallet.seed.split(' ').map((word, i) => `
                    <div class="wallet-seed-word">
                        <span class="wallet-seed-num">${i+1}</span>
                        <span class="wallet-seed-text">${word}</span>
                    </div>
                `).join('')}
            </div>
        `;
    } else {
        alert('No seed found in wallet');
    }
}

// Check wallet status on page load
document.addEventListener('DOMContentLoaded', () => {
    const walletJson = localStorage.getItem('onyx_wasm_wallet');
    const walletStatusDiv = document.getElementById('wallet-status');

    if (walletJson) {
        try {
            const wallet = JSON.parse(walletJson);
            if (wallet.address) {
                walletStatusDiv.innerHTML = `
                    <div class="wallet-active">
                        <div class="wallet-active__badge">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            Wallet Active
                        </div>

                        <div class="wallet-address-box">
                            <label class="wallet-address-label">Your Address</label>
                            <div class="wallet-address-row">
                                <code id="wallet-address" class="wallet-address-value">${wallet.address}</code>
                                <button onclick="copyAddress()" class="wallet-copy-btn" title="Copy">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <div class="wallet-actions-grid">
                            <button onclick="showBackupModal()" class="wallet-action-btn wallet-action-btn--yellow">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="m21 2-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/>
                                </svg>
                                Backup Seed
                            </button>
                            <button onclick="deleteWallet()" class="wallet-action-btn wallet-action-btn--red">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                </svg>
                                Delete Wallet
                            </button>
                            <a href="/escrows" class="wallet-action-btn wallet-action-btn--blue">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/>
                                </svg>
                                Go to Escrows
                            </a>
                        </div>
                    </div>
                `;
            }
        } catch (e) {
            console.error('Failed to parse wallet data:', e);
        }
    }
});

// Delete wallet
function deleteWallet() {
    if (confirm('Are you sure you want to delete your wallet? Make sure you have backed up your seed phrase!')) {
        localStorage.removeItem('onyx_wasm_wallet');
        localStorage.removeItem('monero_seed_phrase');
        localStorage.removeItem('monero_spend_key_priv');
        localStorage.removeItem('monero_view_key_priv');
        localStorage.removeItem('monero_address');
        alert('Wallet deleted');
        location.reload();
    }
}
</script>
{% endblock %}
