{% extends "base-industrial.html" %}

{% block title %}Vendor Onboarding â€” FROST MARKET{% endblock %}

{% block content %}
<div class="vendor-onboard">
    <div class="container-industrial container-industrial--narrow">

        {# ===== PROGRESS STEPPER ===== #}
        <div class="onboard-stepper">
            <div class="onboard-stepper__track">
                <div class="onboard-stepper__progress" id="stepper-progress" style="width: 25%;"></div>
            </div>
            <div class="onboard-stepper__steps">
                <button class="onboard-stepper__step onboard-stepper__step--active" data-step="1" onclick="goToStep(1)">
                    <div class="onboard-stepper__step-number">1</div>
                    <span class="onboard-stepper__step-label">Welcome</span>
                </button>
                <button class="onboard-stepper__step" data-step="2" onclick="goToStep(2)">
                    <div class="onboard-stepper__step-number">2</div>
                    <span class="onboard-stepper__step-label">How It Works</span>
                </button>
                <button class="onboard-stepper__step" data-step="3" onclick="goToStep(3)">
                    <div class="onboard-stepper__step-number">3</div>
                    <span class="onboard-stepper__step-label">Wallet</span>
                </button>
                <button class="onboard-stepper__step" data-step="4" onclick="goToStep(4)">
                    <div class="onboard-stepper__step-number">4</div>
                    <span class="onboard-stepper__step-label">First Listing</span>
                </button>
            </div>
        </div>

        {# ===== STEP 1: WELCOME ===== #}
        <div class="onboard-step onboard-step--active" id="step-1">
            <div class="onboard-step__header">
                <div class="onboard-step__icon onboard-step__icon--welcome">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        <path d="m9 12 2 2 4-4"></path>
                    </svg>
                </div>
                <h1 class="onboard-step__title">Welcome to FROST MARKET Vendor</h1>
                <p class="onboard-step__subtitle">
                    You're about to join a truly non-custodial marketplace.
                </p>
            </div>

            <div class="onboard-step__content">
                <div class="onboard-welcome-grid">
                    <div class="onboard-welcome-card">
                        <div class="onboard-welcome-card__icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                        </div>
                        <h3>Your Keys, Your Funds</h3>
                        <p>Private keys never leave your browser. FROST MARKET cannot access your XMR.</p>
                    </div>

                    <div class="onboard-welcome-card">
                        <div class="onboard-welcome-card__icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                        <h3>2-of-3 Protection</h3>
                        <p>Every sale uses escrow. Buyer, Seller, and Arbiter each hold a key.</p>
                    </div>

                    <div class="onboard-welcome-card">
                        <div class="onboard-welcome-card__icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 16v-4"></path>
                                <path d="M12 8h.01"></path>
                            </svg>
                        </div>
                        <h3>Fair Disputes</h3>
                        <p>If issues arise, a neutral arbiter helps resolve them fairly.</p>
                    </div>

                    <div class="onboard-welcome-card">
                        <div class="onboard-welcome-card__icon">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path>
                                <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path>
                                <path d="M18 12a2 2 0 0 0 0 4h4v-4Z"></path>
                            </svg>
                        </div>
                        <h3>5% Fee Only</h3>
                        <p>Simple pricing. 5% on completed sales. No hidden costs.</p>
                    </div>
                </div>

                <div class="onboard-step__note">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 16v-4"></path>
                        <path d="M12 8h.01"></path>
                    </svg>
                    <span>This onboarding takes about 5 minutes. Your progress is saved automatically.</span>
                </div>
            </div>

            <div class="onboard-step__actions">
                <button class="btn-gold-solid btn-lg" onclick="nextStep()">
                    Let's Get Started
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        {# ===== STEP 2: HOW IT WORKS ===== #}
        <div class="onboard-step" id="step-2">
            <div class="onboard-step__header">
                <div class="onboard-step__icon onboard-step__icon--flow">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path>
                        <path d="m9 12 2 2 4-4"></path>
                    </svg>
                </div>
                <h1 class="onboard-step__title">How You Get Paid</h1>
                <p class="onboard-step__subtitle">
                    A simple 4-step flow from sale to payment.
                </p>
            </div>

            <div class="onboard-step__content">
                <div class="onboard-flow">
                    {# Step 1: Buyer Purchases #}
                    <div class="onboard-flow__item">
                        <div class="onboard-flow__number">1</div>
                        <div class="onboard-flow__connector"></div>
                        <div class="onboard-flow__content">
                            <div class="onboard-flow__icon onboard-flow__icon--buyer">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="8" cy="21" r="1"></circle>
                                    <circle cx="19" cy="21" r="1"></circle>
                                    <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"></path>
                                </svg>
                            </div>
                            <h3>Buyer Purchases</h3>
                            <p>A buyer finds your listing and initiates payment. Funds are locked in 2-of-3 multisig escrow.</p>
                        </div>
                    </div>

                    {# Step 2: You Ship #}
                    <div class="onboard-flow__item">
                        <div class="onboard-flow__number">2</div>
                        <div class="onboard-flow__connector"></div>
                        <div class="onboard-flow__content">
                            <div class="onboard-flow__icon onboard-flow__icon--ship">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2"></path>
                                    <path d="M15 18H9"></path>
                                    <path d="M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14"></path>
                                    <circle cx="17" cy="18" r="2"></circle>
                                    <circle cx="7" cy="18" r="2"></circle>
                                </svg>
                            </div>
                            <h3>You Ship / Deliver</h3>
                            <p>Fulfill the order. For physical goods, ship the package. For digital, provide access. Then mark as shipped.</p>
                        </div>
                    </div>

                    {# Step 3: Buyer Confirms #}
                    <div class="onboard-flow__item">
                        <div class="onboard-flow__number">3</div>
                        <div class="onboard-flow__connector"></div>
                        <div class="onboard-flow__content">
                            <div class="onboard-flow__icon onboard-flow__icon--confirm">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                </svg>
                            </div>
                            <h3>Buyer Confirms Receipt</h3>
                            <p>When the buyer receives and is satisfied, they click "Release Payment" to finalize the transaction.</p>
                        </div>
                    </div>

                    {# Step 4: You Get Paid #}
                    <div class="onboard-flow__item onboard-flow__item--final">
                        <div class="onboard-flow__number onboard-flow__number--gold">4</div>
                        <div class="onboard-flow__content">
                            <div class="onboard-flow__icon onboard-flow__icon--paid">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path>
                                    <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path>
                                    <path d="M18 12a2 2 0 0 0 0 4h4v-4Z"></path>
                                </svg>
                            </div>
                            <h3>Funds Released to You</h3>
                            <p>XMR is sent directly to your wallet. 5% fee is deducted automatically. No delays, no holds.</p>
                        </div>
                    </div>
                </div>

                <div class="onboard-dispute-note">
                    <div class="onboard-dispute-note__header">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
                            <path d="M12 17h.01"></path>
                        </svg>
                        <span>What if there's a problem?</span>
                    </div>
                    <p>
                        Either party can open a dispute. A neutral arbiter reviews evidence and decides.
                        Two of three keys (Buyer + Arbiter OR Seller + Arbiter) are needed to release funds.
                    </p>
                </div>
            </div>

            <div class="onboard-step__actions">
                <button class="btn-ghost" onclick="prevStep()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back
                </button>
                <button class="btn-gold-solid btn-lg" onclick="nextStep()">
                    Set Up Wallet
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        {# ===== STEP 3: WALLET SETUP ===== #}
        <div class="onboard-step" id="step-3">
            <div class="onboard-step__header">
                <div class="onboard-step__icon onboard-step__icon--wallet">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"></path>
                        <path d="M3 5v14a2 2 0 0 0 2 2h16v-5"></path>
                        <path d="M18 12a2 2 0 0 0 0 4h4v-4Z"></path>
                    </svg>
                </div>
                <h1 class="onboard-step__title">Your Vendor Wallet</h1>
                <p class="onboard-step__subtitle">
                    This wallet receives payments from completed sales.
                </p>
            </div>

            <div class="onboard-step__content">
                <div class="onboard-wallet-options">
                    {# Option 1: Generate New #}
                    <div class="onboard-wallet-option" id="wallet-option-generate">
                        <input type="radio" name="wallet_option" id="wallet-generate" value="generate" checked>
                        <label for="wallet-generate" class="onboard-wallet-option__card">
                            <div class="onboard-wallet-option__header">
                                <div class="onboard-wallet-option__radio"></div>
                                <div class="onboard-wallet-option__info">
                                    <h3>Generate New Wallet</h3>
                                    <p>Create a fresh Monero wallet in your browser</p>
                                </div>
                                <div class="onboard-wallet-option__badge onboard-wallet-option__badge--recommended">
                                    Recommended
                                </div>
                            </div>
                            <ul class="onboard-wallet-option__features">
                                <li>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                    Keys generated client-side (WASM)
                                </li>
                                <li>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                    25-word seed phrase backup
                                </li>
                                <li>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                    Encrypted storage in browser
                                </li>
                            </ul>
                        </label>
                    </div>

                    {# Option 2: Existing Wallet #}
                    <div class="onboard-wallet-option" id="wallet-option-existing">
                        <input type="radio" name="wallet_option" id="wallet-existing" value="existing">
                        <label for="wallet-existing" class="onboard-wallet-option__card">
                            <div class="onboard-wallet-option__header">
                                <div class="onboard-wallet-option__radio"></div>
                                <div class="onboard-wallet-option__info">
                                    <h3>Use Existing Address</h3>
                                    <p>Enter a Monero address you already control</p>
                                </div>
                            </div>
                            <div class="onboard-wallet-option__input-group" style="display: none;">
                                <label for="existing-address">Your Monero Address</label>
                                <input type="text" id="existing-address" placeholder="4..." class="input-industrial">
                                <span class="onboard-wallet-option__hint">
                                    Must be a valid Monero address starting with 4 or 8
                                </span>
                            </div>
                        </label>
                    </div>
                </div>

                {# Wallet Generation Progress (hidden initially) #}
                <div class="onboard-wallet-progress" id="wallet-progress" style="display: none;">
                    <div class="onboard-wallet-progress__header">
                        <div class="onboard-wallet-progress__spinner"></div>
                        <span id="wallet-progress-text">Initializing secure wallet...</span>
                    </div>
                    <div class="onboard-wallet-progress__bar">
                        <div class="onboard-wallet-progress__fill" id="wallet-progress-bar" style="width: 0%;"></div>
                    </div>
                    <div class="onboard-wallet-progress__messages" id="wallet-messages">
                        <!-- Progress messages appear here -->
                    </div>
                </div>

                {# Seed Phrase Display (hidden initially) #}
                <div class="onboard-seed-display" id="seed-display" style="display: none;">
                    <div class="onboard-seed-display__header">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        <h3>Your Recovery Phrase</h3>
                    </div>
                    <p class="onboard-seed-display__warning">
                        Write these 25 words down in order. This is the ONLY way to recover your wallet.
                        NEVER share this phrase with anyone.
                    </p>
                    <div class="onboard-seed-display__words" id="seed-words">
                        <!-- Seed words will be inserted here -->
                    </div>
                    <label class="onboard-seed-display__confirm">
                        <input type="checkbox" id="seed-confirmed">
                        <span>I have written down my recovery phrase and stored it safely</span>
                    </label>
                </div>

                {# Seed Verification Quiz (hidden initially) #}
                <div class="onboard-seed-quiz" id="seed-quiz" style="display: none;">
                    <h3>Verify Your Recovery Phrase</h3>
                    <p>Enter the requested words to confirm you've saved your phrase.</p>
                    <div class="onboard-seed-quiz__inputs">
                        <div class="onboard-seed-quiz__input-group">
                            <label>Word #<span id="quiz-word-1-num">3</span></label>
                            <input type="text" id="quiz-word-1" class="input-industrial" autocomplete="off">
                        </div>
                        <div class="onboard-seed-quiz__input-group">
                            <label>Word #<span id="quiz-word-2-num">12</span></label>
                            <input type="text" id="quiz-word-2" class="input-industrial" autocomplete="off">
                        </div>
                        <div class="onboard-seed-quiz__input-group">
                            <label>Word #<span id="quiz-word-3-num">21</span></label>
                            <input type="text" id="quiz-word-3" class="input-industrial" autocomplete="off">
                        </div>
                    </div>
                    <div class="onboard-seed-quiz__error" id="quiz-error" style="display: none;">
                        Incorrect words. Please check your recovery phrase and try again.
                    </div>
                </div>

                {# Wallet Success (hidden initially) #}
                <div class="onboard-wallet-success" id="wallet-success" style="display: none;">
                    <div class="onboard-wallet-success__icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                    </div>
                    <h3>Wallet Ready!</h3>
                    <p>Your vendor wallet has been created and secured.</p>
                    <div class="onboard-wallet-success__address">
                        <span class="onboard-wallet-success__label">Your Address</span>
                        <code id="wallet-address-display">4...</code>
                        <button class="btn-icon" onclick="copyAddress()" title="Copy Address">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="onboard-step__actions">
                <button class="btn-ghost" onclick="prevStep()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back
                </button>
                <button class="btn-gold-solid btn-lg" id="wallet-action-btn" onclick="handleWalletAction()">
                    Generate Wallet
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        {# ===== STEP 4: FIRST LISTING ===== #}
        <div class="onboard-step" id="step-4">
            <div class="onboard-step__header">
                <div class="onboard-step__icon onboard-step__icon--listing">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="m7.5 4.27 9 5.15"></path>
                        <path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"></path>
                        <path d="m3.3 7 8.7 5 8.7-5"></path>
                        <path d="M12 22V12"></path>
                    </svg>
                </div>
                <h1 class="onboard-step__title">Create Your First Listing</h1>
                <p class="onboard-step__subtitle">
                    Let's add your first product. You can always edit it later.
                </p>
            </div>

            <div class="onboard-step__content">
                <form id="first-listing-form" class="onboard-listing-form">
                    {# Title #}
                    <div class="form-group-industrial">
                        <label for="listing-title" class="form-label-industrial">
                            Product Title <span class="required">*</span>
                        </label>
                        <input type="text" id="listing-title" name="title"
                               class="input-industrial"
                               placeholder="e.g., Premium Widget Pro"
                               required maxlength="100">
                        <span class="form-hint-industrial">Keep it clear and descriptive (max 100 characters)</span>
                    </div>

                    {# Category #}
                    <div class="form-group-industrial">
                        <label for="listing-category" class="form-label-industrial">
                            Category <span class="required">*</span>
                        </label>
                        <select id="listing-category" name="category" class="select-industrial" required>
                            <option value="">Select a category...</option>
                            <option value="digital">Digital Goods</option>
                            <option value="physical">Physical Products</option>
                            <option value="services">Services</option>
                            <option value="software">Software & Tools</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    {# Price #}
                    <div class="form-group-industrial">
                        <label for="listing-price" class="form-label-industrial">
                            Price (XMR) <span class="required">*</span>
                        </label>
                        <div class="input-with-suffix">
                            <input type="number" id="listing-price" name="price"
                                   class="input-industrial"
                                   placeholder="0.00"
                                   step="0.0001" min="0.0001"
                                   required>
                            <span class="input-suffix">XMR</span>
                        </div>
                        <span class="form-hint-industrial" id="price-usd-hint">
                            <!-- USD equivalent shown here via JS -->
                        </span>
                    </div>

                    {# Description #}
                    <div class="form-group-industrial">
                        <label for="listing-description" class="form-label-industrial">
                            Description <span class="required">*</span>
                        </label>
                        <textarea id="listing-description" name="description"
                                  class="textarea-industrial"
                                  rows="4"
                                  placeholder="Describe your product or service..."
                                  required maxlength="2000"></textarea>
                        <span class="form-hint-industrial">
                            <span id="description-count">0</span>/2000 characters
                        </span>
                    </div>

                    {# Image Upload (Optional) #}
                    <div class="form-group-industrial">
                        <label class="form-label-industrial">
                            Product Image <span class="optional">(optional)</span>
                        </label>
                        <div class="onboard-image-upload" id="image-upload-area">
                            <input type="file" id="listing-image" name="image"
                                   accept="image/jpeg,image/png,image/webp"
                                   style="display: none;">
                            <div class="onboard-image-upload__placeholder" onclick="document.getElementById('listing-image').click()">
                                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                    <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                    <polyline points="21 15 16 10 5 21"></polyline>
                                </svg>
                                <span>Click to upload or drag & drop</span>
                                <span class="onboard-image-upload__hint">JPEG, PNG, WebP up to 5MB</span>
                            </div>
                            <div class="onboard-image-upload__preview" id="image-preview" style="display: none;">
                                <img id="image-preview-img" src="" alt="Preview">
                                <button type="button" class="onboard-image-upload__remove" onclick="removeImage()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="6" x2="6" y2="18"></line>
                                        <line x1="6" y1="6" x2="18" y2="18"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </form>

                <div class="onboard-listing-note">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <path d="M12 16v-4"></path>
                        <path d="M12 8h.01"></path>
                    </svg>
                    <span>You can skip this step and create listings later from your dashboard.</span>
                </div>
            </div>

            <div class="onboard-step__actions">
                <button class="btn-ghost" onclick="prevStep()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                    Back
                </button>
                <button type="button" class="btn-ghost" onclick="skipListing()">
                    Skip for now
                </button>
                <button type="submit" form="first-listing-form" class="btn-gold-solid btn-lg">
                    Create Listing & Finish
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </button>
            </div>
        </div>

        {# ===== SUCCESS SCREEN ===== #}
        <div class="onboard-success" id="onboard-success" style="display: none;">
            <div class="onboard-success__icon">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                </svg>
            </div>
            <h1 class="onboard-success__title">You're All Set!</h1>
            <p class="onboard-success__subtitle">
                Welcome to FROST MARKET. Your vendor account is ready.
            </p>

            <div class="onboard-success__actions">
                <a href="/vendor/dashboard" class="btn-gold-solid btn-lg">
                    Go to Dashboard
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </a>
                <a href="/listings/create" class="btn-gold-outline">
                    Create Another Listing
                </a>
            </div>

            <div class="onboard-success__tips">
                <h3>Quick Tips</h3>
                <ul>
                    <li>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        Respond to orders promptly for better ratings
                    </li>
                    <li>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        Keep your recovery phrase secure and offline
                    </li>
                    <li>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        Mark orders as shipped only when actually dispatched
                    </li>
                </ul>
            </div>
        </div>

    </div>
</div>

<script>
const CSRF_TOKEN = "{{ csrf_token }}";
let currentStep = 1;
let walletState = 'initial'; // initial, generating, seed_shown, seed_verified, complete
let generatedSeed = null;
let quizWordIndices = [3, 12, 21]; // Words to verify

// ============================================
// STEP NAVIGATION
// ============================================
function goToStep(step) {
    if (step < 1 || step > 4) return;
    if (step > currentStep + 1) return; // Can't skip ahead

    // Hide all steps
    document.querySelectorAll('.onboard-step').forEach(el => {
        el.classList.remove('onboard-step--active');
    });

    // Show target step
    document.getElementById(`step-${step}`).classList.add('onboard-step--active');

    // Update stepper
    document.querySelectorAll('.onboard-stepper__step').forEach(el => {
        const stepNum = parseInt(el.dataset.step);
        el.classList.remove('onboard-stepper__step--active', 'onboard-stepper__step--completed');
        if (stepNum === step) {
            el.classList.add('onboard-stepper__step--active');
        } else if (stepNum < step) {
            el.classList.add('onboard-stepper__step--completed');
        }
    });

    // Update progress bar
    const progress = (step / 4) * 100;
    document.getElementById('stepper-progress').style.width = `${progress}%`;

    currentStep = step;
    saveProgress();
}

function nextStep() {
    if (currentStep < 4) {
        goToStep(currentStep + 1);
    }
}

function prevStep() {
    if (currentStep > 1) {
        goToStep(currentStep - 1);
    }
}

// ============================================
// WALLET HANDLING
// ============================================
function handleWalletAction() {
    const selectedOption = document.querySelector('input[name="wallet_option"]:checked').value;

    if (selectedOption === 'generate') {
        if (walletState === 'initial') {
            generateWallet();
        } else if (walletState === 'seed_shown') {
            showSeedQuiz();
        } else if (walletState === 'seed_verified') {
            nextStep();
        }
    } else {
        // Existing address
        const address = document.getElementById('existing-address').value.trim();
        if (validateAddress(address)) {
            saveExistingAddress(address);
            nextStep();
        } else {
            alert('Please enter a valid Monero address');
        }
    }
}

function generateWallet() {
    walletState = 'generating';

    // Hide options, show progress
    document.querySelector('.onboard-wallet-options').style.display = 'none';
    document.getElementById('wallet-progress').style.display = 'block';

    // Update button
    const btn = document.getElementById('wallet-action-btn');
    btn.disabled = true;
    btn.textContent = 'Generating...';

    // Simulate wallet generation with progress
    const messages = [
        'Initializing cryptographic module...',
        'Generating random entropy...',
        'Creating keypair...',
        'Deriving wallet address...',
        'Preparing recovery phrase...',
        'Wallet created!'
    ];

    let progress = 0;
    const interval = setInterval(() => {
        progress += 16.67;
        document.getElementById('wallet-progress-bar').style.width = `${progress}%`;

        const msgIndex = Math.min(Math.floor(progress / 16.67), messages.length - 1);
        document.getElementById('wallet-progress-text').textContent = messages[msgIndex];

        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => showSeedPhrase(), 500);
        }
    }, 400);
}

function showSeedPhrase() {
    // Hide progress, show seed
    document.getElementById('wallet-progress').style.display = 'none';
    document.getElementById('seed-display').style.display = 'block';

    // Generate mock seed phrase (in reality, this comes from WASM)
    generatedSeed = [
        'abandon', 'ability', 'able', 'about', 'above',
        'absent', 'absorb', 'abstract', 'absurd', 'abuse',
        'access', 'accident', 'account', 'accuse', 'achieve',
        'acid', 'acoustic', 'acquire', 'across', 'act',
        'action', 'actor', 'actress', 'actual', 'adapt'
    ];

    // Display words
    const wordsContainer = document.getElementById('seed-words');
    wordsContainer.innerHTML = generatedSeed.map((word, i) => `
        <div class="onboard-seed-word">
            <span class="onboard-seed-word__num">${i + 1}</span>
            <span class="onboard-seed-word__word">${word}</span>
        </div>
    `).join('');

    // Update button
    const btn = document.getElementById('wallet-action-btn');
    btn.disabled = true;
    btn.textContent = 'Confirm backup first';

    // Enable button when checkbox is checked
    document.getElementById('seed-confirmed').addEventListener('change', function() {
        btn.disabled = !this.checked;
        if (this.checked) {
            btn.textContent = 'Verify Backup';
            walletState = 'seed_shown';
        }
    });
}

function showSeedQuiz() {
    document.getElementById('seed-display').style.display = 'none';
    document.getElementById('seed-quiz').style.display = 'block';

    // Randomize quiz words
    quizWordIndices = [
        Math.floor(Math.random() * 8) + 1,  // 1-8
        Math.floor(Math.random() * 8) + 9,  // 9-16
        Math.floor(Math.random() * 8) + 17  // 17-24
    ];

    document.getElementById('quiz-word-1-num').textContent = quizWordIndices[0];
    document.getElementById('quiz-word-2-num').textContent = quizWordIndices[1];
    document.getElementById('quiz-word-3-num').textContent = quizWordIndices[2];

    // Update button
    const btn = document.getElementById('wallet-action-btn');
    btn.textContent = 'Verify & Continue';
    btn.onclick = verifySeedQuiz;
}

function verifySeedQuiz() {
    const word1 = document.getElementById('quiz-word-1').value.trim().toLowerCase();
    const word2 = document.getElementById('quiz-word-2').value.trim().toLowerCase();
    const word3 = document.getElementById('quiz-word-3').value.trim().toLowerCase();

    const correct1 = generatedSeed[quizWordIndices[0] - 1];
    const correct2 = generatedSeed[quizWordIndices[1] - 1];
    const correct3 = generatedSeed[quizWordIndices[2] - 1];

    if (word1 === correct1 && word2 === correct2 && word3 === correct3) {
        // Success
        walletState = 'seed_verified';
        showWalletSuccess();
    } else {
        // Error
        document.getElementById('quiz-error').style.display = 'block';
    }
}

function showWalletSuccess() {
    document.getElementById('seed-quiz').style.display = 'none';
    document.getElementById('wallet-success').style.display = 'block';

    // Show mock address
    document.getElementById('wallet-address-display').textContent =
        '4AdU...x7Kp (truncated for security)';

    walletState = 'complete';

    // Update button
    const btn = document.getElementById('wallet-action-btn');
    btn.textContent = 'Continue to Listing';
    btn.onclick = nextStep;
}

function validateAddress(address) {
    // Basic Monero address validation
    return address && (address.startsWith('4') || address.startsWith('8')) && address.length >= 95;
}

function saveExistingAddress(address) {
    localStorage.setItem('nexus_vendor_address', address);
    walletState = 'complete';
}

function copyAddress() {
    const address = document.getElementById('wallet-address-display').textContent;
    navigator.clipboard.writeText(address);
    // Show feedback
}

// Wallet option toggle
document.querySelectorAll('input[name="wallet_option"]').forEach(input => {
    input.addEventListener('change', function() {
        const inputGroup = document.querySelector('.onboard-wallet-option__input-group');
        const btn = document.getElementById('wallet-action-btn');

        if (this.value === 'existing') {
            inputGroup.style.display = 'block';
            btn.textContent = 'Use This Address';
        } else {
            inputGroup.style.display = 'none';
            btn.textContent = 'Generate Wallet';
        }
    });
});

// ============================================
// LISTING FORM
// ============================================
document.getElementById('listing-description').addEventListener('input', function() {
    document.getElementById('description-count').textContent = this.value.length;
});

document.getElementById('listing-image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('image-preview-img').src = e.target.result;
            document.querySelector('.onboard-image-upload__placeholder').style.display = 'none';
            document.getElementById('image-preview').style.display = 'block';
        };
        reader.readAsDataURL(file);
    }
});

function removeImage() {
    document.getElementById('listing-image').value = '';
    document.getElementById('image-preview').style.display = 'none';
    document.querySelector('.onboard-image-upload__placeholder').style.display = 'flex';
}

document.getElementById('first-listing-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    try {
        const response = await fetch('/api/listings', {
            method: 'POST',
            headers: {
                'X-CSRF-Token': CSRF_TOKEN
            },
            body: formData,
            credentials: 'include'
        });

        if (response.ok) {
            showSuccess();
        } else {
            const data = await response.json();
            alert(data.message || 'Failed to create listing');
        }
    } catch (err) {
        console.error('Listing creation error:', err);
        alert('Failed to create listing. Please try again.');
    }
});

function skipListing() {
    markOnboardingComplete();
    showSuccess();
}

function showSuccess() {
    // Hide step 4
    document.getElementById('step-4').classList.remove('onboard-step--active');
    // Hide stepper
    document.querySelector('.onboard-stepper').style.display = 'none';
    // Show success
    document.getElementById('onboard-success').style.display = 'block';

    markOnboardingComplete();
}

// ============================================
// PROGRESS PERSISTENCE
// ============================================
function saveProgress() {
    localStorage.setItem('nexus_vendor_onboard_step', currentStep.toString());
}

function loadProgress() {
    const savedStep = localStorage.getItem('nexus_vendor_onboard_step');
    if (savedStep) {
        const step = parseInt(savedStep);
        if (step > 1 && step <= 4) {
            goToStep(step);
        }
    }
}

function markOnboardingComplete() {
    localStorage.setItem('nexus_vendor_onboarded', 'true');
    localStorage.removeItem('nexus_vendor_onboard_step');

    // Also notify server
    fetch('/api/vendor/onboard/complete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': CSRF_TOKEN
        },
        credentials: 'include'
    }).catch(() => {
        // Silent fail - local storage is the primary indicator
    });
}

// ============================================
// INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    loadProgress();

    // Check if already onboarded
    if (localStorage.getItem('nexus_vendor_onboarded') === 'true') {
        // Redirect to dashboard
        window.location.href = '/vendor/dashboard';
    }
});
</script>
{% endblock %}
