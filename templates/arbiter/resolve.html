{% extends "base-aura.html" %}

{% block title %}Resolve Dispute - FROST MARKET{% endblock %}

{% block content %}
{% include "components/topbar-aura.html" %}

<div class="container mx-auto px-4 py-12 pb-32 max-w-5xl">
    <!-- Back Button -->
    <a href="/arbiter/dashboard"
        class="inline-flex items-center gap-2 text-gray-400 hover:text-white transition-colors mb-8 group">
        <i data-lucide="arrow-left" class="w-4 h-4 group-hover:-translate-x-1 transition-transform"></i>
        Back to Dashboard
    </a>

    <!-- Header -->
    <div class="p-6 rounded-2xl bg-gradient-to-r from-purple-900/30 to-pink-900/30 border border-purple-500/20 backdrop-blur-md mb-8">
        <div class="flex items-center gap-3 mb-4">
            <div class="p-3 rounded-full bg-purple-500/20 text-purple-400">
                <i data-lucide="gavel" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="text-2xl text-white font-light">Dispute Resolution</h1>
                <p class="text-gray-400 text-sm">Escrow #{{ escrow.id | truncate(length=12, end="...") }}</p>
            </div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
                <span class="text-gray-500 block">Amount</span>
                <span class="text-cyan-400 font-mono text-lg">{{ escrow.amount_xmr }} XMR</span>
            </div>
            <div>
                <span class="text-gray-500 block">Status</span>
                <span class="text-orange-400">{{ escrow.status | replace(from="_", to=" ") | title }}</span>
            </div>
            <div>
                <span class="text-gray-500 block">Disputed</span>
                <span class="text-white">{{ escrow.disputed_at | default(value=escrow.updated_at) | date(format="%Y-%m-%d") }}</span>
            </div>
            <div>
                <span class="text-gray-500 block">Order</span>
                <a href="/orders/{{ order.id }}" class="text-cyan-400 hover:text-cyan-300">#{{ order.id | truncate(length=8, end="") }}</a>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Buyer's Claim -->
        <div class="p-6 rounded-2xl bg-cyan-500/5 border border-cyan-500/20">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-full bg-cyan-500/20 flex items-center justify-center text-cyan-400 font-bold">
                    B
                </div>
                <div>
                    <h3 class="text-white font-medium">Buyer: {{ buyer.username | default(value="Anonymous") }}</h3>
                    <span class="text-xs text-gray-500">{{ buyer.orders_count | default(value=0) }} orders completed</span>
                </div>
            </div>

            <div class="space-y-3">
                <div>
                    <span class="text-xs text-gray-500 uppercase tracking-wider block mb-1">Dispute Reason</span>
                    <p class="text-gray-300 text-sm bg-black/20 rounded-lg p-3 border border-white/5">
                        {{ dispute.buyer_reason | default(value="No reason provided by buyer.") }}
                    </p>
                </div>

                {% if dispute.buyer_evidence %}
                <div>
                    <span class="text-xs text-gray-500 uppercase tracking-wider block mb-1">Evidence</span>
                    <div class="space-y-2">
                        {% for evidence in dispute.buyer_evidence %}
                        <a href="{{ evidence.url }}" target="_blank"
                           class="flex items-center gap-2 text-sm text-cyan-400 hover:text-cyan-300 bg-black/20 rounded-lg p-2 border border-white/5">
                            <i data-lucide="{% if evidence.type == 'image' %}image{% elif evidence.type == 'document' %}file-text{% else %}paperclip{% endif %}" class="w-4 h-4"></i>
                            {{ evidence.name | default(value="Evidence file") }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <div class="pt-3 border-t border-white/10">
                    <span class="text-xs text-gray-500">Buyer wants:</span>
                    <span class="text-cyan-400 font-medium ml-2">Full Refund</span>
                </div>
            </div>
        </div>

        <!-- Vendor's Response -->
        <div class="p-6 rounded-2xl bg-purple-500/5 border border-purple-500/20">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 font-bold">
                    V
                </div>
                <div>
                    <h3 class="text-white font-medium">Vendor: {{ vendor.username | default(value="Anonymous") }}</h3>
                    <span class="text-xs text-gray-500">{{ vendor.sales_count | default(value=0) }} sales â€¢ {{ vendor.rating | default(value="N/A") }} rating</span>
                </div>
            </div>

            <div class="space-y-3">
                <div>
                    <span class="text-xs text-gray-500 uppercase tracking-wider block mb-1">Vendor Response</span>
                    <p class="text-gray-300 text-sm bg-black/20 rounded-lg p-3 border border-white/5">
                        {{ dispute.vendor_response | default(value="No response from vendor yet.") }}
                    </p>
                </div>

                {% if dispute.vendor_evidence %}
                <div>
                    <span class="text-xs text-gray-500 uppercase tracking-wider block mb-1">Evidence</span>
                    <div class="space-y-2">
                        {% for evidence in dispute.vendor_evidence %}
                        <a href="{{ evidence.url }}" target="_blank"
                           class="flex items-center gap-2 text-sm text-purple-400 hover:text-purple-300 bg-black/20 rounded-lg p-2 border border-white/5">
                            <i data-lucide="{% if evidence.type == 'image' %}image{% elif evidence.type == 'document' %}file-text{% else %}paperclip{% endif %}" class="w-4 h-4"></i>
                            {{ evidence.name | default(value="Evidence file") }}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if dispute.tracking_number %}
                <div>
                    <span class="text-xs text-gray-500 uppercase tracking-wider block mb-1">Tracking</span>
                    <span class="text-white font-mono text-sm">{{ dispute.tracking_number }}</span>
                </div>
                {% endif %}

                <div class="pt-3 border-t border-white/10">
                    <span class="text-xs text-gray-500">Vendor wants:</span>
                    <span class="text-purple-400 font-medium ml-2">Release Payment</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Chat History (if available) -->
    {% if messages and messages | length > 0 %}
    <div class="p-6 rounded-2xl bg-white/5 border border-white/10 mb-8">
        <h3 class="text-white font-medium mb-4 flex items-center gap-2">
            <i data-lucide="message-square" class="w-5 h-5 text-gray-400"></i>
            Chat History ({{ messages | length }} messages)
        </h3>
        <div class="max-h-60 overflow-y-auto space-y-2 custom-scrollbar">
            {% for msg in messages %}
            <div class="p-2 rounded-lg {% if msg.sender_role == 'buyer' %}bg-cyan-500/10{% else %}bg-purple-500/10{% endif %}">
                <div class="flex items-center gap-2 text-xs text-gray-500 mb-1">
                    <span class="{% if msg.sender_role == 'buyer' %}text-cyan-400{% else %}text-purple-400{% endif %}">{{ msg.sender_role | title }}</span>
                    <span>{{ msg.created_at | date(format="%m/%d %H:%M") }}</span>
                </div>
                <p class="text-sm text-gray-300">{{ msg.content }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Resolution Form -->
    <div class="p-6 rounded-2xl bg-white/5 border border-white/10">
        <h3 class="text-white font-medium mb-6 flex items-center gap-2">
            <i data-lucide="scale" class="w-5 h-5 text-yellow-400"></i>
            Your Decision
        </h3>

        <form id="resolve-form" class="space-y-6">
            <input type="hidden" name="escrow_id" value="{{ escrow.id }}">

            <!-- Decision Radio Buttons -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <label class="relative cursor-pointer group">
                    <input type="radio" name="resolution" value="buyer" class="peer sr-only" required>
                    <div class="p-4 rounded-xl border-2 border-white/10 peer-checked:border-cyan-500 peer-checked:bg-cyan-500/10 transition-all group-hover:border-white/30">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-cyan-500/20 flex items-center justify-center text-cyan-400">
                                <i data-lucide="undo-2" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <span class="text-white font-medium block">Refund Buyer</span>
                                <span class="text-xs text-gray-500">{{ escrow.amount_xmr }} XMR to buyer</span>
                            </div>
                        </div>
                    </div>
                </label>

                <label class="relative cursor-pointer group">
                    <input type="radio" name="resolution" value="vendor" class="peer sr-only" required>
                    <div class="p-4 rounded-xl border-2 border-white/10 peer-checked:border-purple-500 peer-checked:bg-purple-500/10 transition-all group-hover:border-white/30">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400">
                                <i data-lucide="send" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <span class="text-white font-medium block">Release to Vendor</span>
                                <span class="text-xs text-gray-500">{{ escrow.amount_xmr }} XMR to vendor</span>
                            </div>
                        </div>
                    </div>
                </label>
            </div>

            <!-- Reason (Required) -->
            <div>
                <label class="text-sm text-gray-400 block mb-2">
                    Reason for Decision <span class="text-red-400">*</span>
                </label>
                <textarea name="reason" rows="3" required minlength="20"
                    class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-gray-600 text-sm focus:outline-none focus:border-purple-500/50 transition-all resize-none"
                    placeholder="Explain your decision (minimum 20 characters)..."></textarea>
                <p class="text-xs text-gray-500 mt-1">This will be visible to both parties.</p>
            </div>

            <!-- Warning -->
            <div class="p-4 rounded-xl bg-yellow-500/10 border border-yellow-500/20">
                <div class="flex items-start gap-3">
                    <i data-lucide="alert-triangle" class="w-5 h-5 text-yellow-400 flex-shrink-0 mt-0.5"></i>
                    <div class="text-sm text-yellow-400/80">
                        <strong class="text-yellow-400">This action is final.</strong>
                        Once submitted, the decision cannot be reversed. The transaction will be signed
                        with your arbiter key and broadcast to the Monero network.
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex gap-4">
                <button type="submit" id="submit-resolution"
                    class="flex-1 py-3 rounded-xl bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold hover:opacity-90 transition-opacity shadow-lg shadow-purple-500/20 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                    Submit Decision
                </button>
                <a href="/arbiter/dashboard"
                   class="px-6 py-3 rounded-xl bg-white/5 hover:bg-white/10 text-gray-400 hover:text-white border border-white/10 transition-all flex items-center gap-2">
                    Cancel
                </a>
            </div>
        </form>

        <!-- Result Container -->
        <div id="resolution-result" class="mt-4 hidden"></div>
    </div>
</div>

{% include "components/navigation-aura.html" %}

<script>
document.getElementById('resolve-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    const form = e.target;
    const submitBtn = document.getElementById('submit-resolution');
    const resultDiv = document.getElementById('resolution-result');

    const formData = new FormData(form);
    const resolution = formData.get('resolution');
    const reason = formData.get('reason');
    const escrowId = formData.get('escrow_id');

    if (!resolution) {
        resultDiv.innerHTML = '<div class="p-4 rounded-xl bg-red-500/10 border border-red-500/20 text-red-400">Please select a resolution (Refund Buyer or Release to Vendor)</div>';
        resultDiv.classList.remove('hidden');
        return;
    }

    if (!reason || reason.length < 20) {
        resultDiv.innerHTML = '<div class="p-4 rounded-xl bg-red-500/10 border border-red-500/20 text-red-400">Please provide a reason (minimum 20 characters)</div>';
        resultDiv.classList.remove('hidden');
        return;
    }

    // Disable button and show loading
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="animate-spin inline-block w-5 h-5 border-2 border-white/30 border-t-white rounded-full mr-2"></span>Processing...';

    try {
        // Step 1: Set signing pair
        const signingPairResponse = await fetch(`/api/escrow/${escrowId}/dispute/signing-pair`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                signing_pair: resolution === 'buyer' ? 'arbiter_buyer' : 'arbiter_vendor'
            })
        });

        if (!signingPairResponse.ok) {
            const error = await signingPairResponse.json();
            throw new Error(error.error || 'Failed to set signing pair');
        }

        // Step 2: Resolve dispute
        const resolveResponse = await fetch(`/api/escrow/${escrowId}/resolve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                resolution: resolution,
                reason: reason
            })
        });

        const result = await resolveResponse.json();

        if (resolveResponse.ok) {
            resultDiv.innerHTML = `
                <div class="p-4 rounded-xl bg-green-500/10 border border-green-500/20 text-green-400">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                        <strong>Dispute Resolved Successfully!</strong>
                    </div>
                    <p class="text-sm text-green-400/80">${result.message || 'The transaction will be broadcast shortly.'}</p>
                    <a href="/arbiter/dashboard" class="inline-block mt-3 text-sm text-white hover:text-green-400">
                        &larr; Return to Dashboard
                    </a>
                </div>
            `;
            resultDiv.classList.remove('hidden');
            lucide.createIcons();

            // Redirect after 3 seconds
            setTimeout(() => {
                window.location.href = '/arbiter/dashboard?filter=resolved';
            }, 3000);
        } else {
            throw new Error(result.error || 'Failed to resolve dispute');
        }
    } catch (error) {
        resultDiv.innerHTML = `
            <div class="p-4 rounded-xl bg-red-500/10 border border-red-500/20 text-red-400">
                <div class="flex items-center gap-2 mb-2">
                    <i data-lucide="x-circle" class="w-5 h-5"></i>
                    <strong>Error</strong>
                </div>
                <p class="text-sm">${error.message}</p>
            </div>
        `;
        resultDiv.classList.remove('hidden');
        lucide.createIcons();

        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i data-lucide="check-circle" class="w-5 h-5"></i> Submit Decision';
        lucide.createIcons();
    }
});
</script>
{% endblock %}
